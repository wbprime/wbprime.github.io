

<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Wbprime</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Wbprime</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;www.wangbo.im">Wbprime</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https://www.wangbo.im">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#vert-x-dui-jwt-de-zhi-chi" class="toc-link">Vert.x 对 JWT 的支持</a>
                    
                </li>
                
                <li>
                    <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#ji-yu-tong-yong-liu-cheng-de-gai-zao" class="toc-link">基于通用流程的改造</a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#yong-hu-yuan-de-chou-xiang-userrealm" class="toc-link">用户源的抽象 UserRealm</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#spibaseduserrealmservice" class="toc-link">SpiBasedUserRealmService</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#jwt-auth-provider" class="toc-link">JWT Auth Provider</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#auth-handler" class="toc-link">Auth Handler</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#login-controller" class="toc-link">Login Controller</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#zong-jie" class="toc-link">总结</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-12-multiple-jwt-auth-handler-in-vertx&#x2F;">Multiple JWT Auth Handlers in Vert.x</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-03-12</span>
            
        </div>
    </header>

    <div class="post-content">
      <p><a href="https://vertx.io">Vert.x</a> 的官方 Web 开发包 <a href="https://vertx.io/docs/vertx-web/java/">Vert.x-Web</a> 中
提供了内置的 Authentication&amp;Authorisation 支持；通过扩展的
<a href="https://vertx.io/docs/vertx-auth-common/java/">Auth Common</a> 模块和 <a href="https://vertx.io/docs/vertx-auth-jdbc/java/">JDBC
auth</a> <a href="https://vertx.io/docs/vertx-auth-mongo/java/">MongoDB
auth</a> <a href="https://vertx.io/docs/vertx-auth-shiro/java/">Shiro
auth</a> <a href="https://vertx.io/docs/vertx-auth-jwt/java/">JWT
auth</a> <a href="https://vertx.io/docs/vertx-auth-oauth2/java/">OAuth 2</a> 等模块，可以覆盖大部分的用户认证与验权的支持。</p>
<p>在实际的项目中，遇到了一个支持多用户提供方的需求：项目的用户是从多个其他项目导入的；项目的逻辑比较简
单，不想维护自己的用户信息数据和外部映射。</p>
<p>比如，项目需要支持主站用户、视频网站等入口登录访问。正常情况下，只需要项目维护一套内部用户表、一个外
部项目表以及内部用户和外部用户的映射表；在用户导入或用户绑定请求时，建立外部项目 ID 和外部项目用户
ID 与内部用户 ID 的对应关系；在登录请求时，根据外部项目 ID 和外部项目用户 ID 调用用户认证回调，通过
后再寻找到内部用户的 ID 即可。</p>
<p>实际在项目的设计和实现过程中，采用了一个比较好玩的方法：在内部用户表的基础上，对用户使用
<a href="https://jwt.io">JWT</a> 的认证模型；用户登录时，根据外部项目 ID 和外部项目用户 ID 调用用户认证回调，发
放 JWT token，在 token 中限定用户的访问权限。</p>
<p><a name="continue-reading"></a></p>
<h1 id="vert-x-dui-jwt-de-zhi-chi"><a class="zola-anchor" href="#vert-x-dui-jwt-de-zhi-chi" aria-label="Anchor link for: vert-x-dui-jwt-de-zhi-chi">🔗</a>
Vert.x 对 JWT 的支持</h1>
<p>相关文档参见 <a href="https://vertx.io/docs/vertx-auth-common/java/">Vert.x Auth Common</a> <a href="https://vertx.io/docs/vertx-auth-jwt/java/">Vert.x
JWT</a> <a href="https://vertx.io/docs/vertx-web/java/#_authentication_authorisation">Vert.x Web AuthN &amp;
AuthZ</a> 。</p>
<ol>
<li>确定 JWT 的算法和密钥</li>
</ol>
<pre style="background-color:#2b303b;">
<span style="color:#ebcb8b;">WTAuthOptions</span><span style="color:#c0c5ce;"> authConfig = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">JWTAuthOptions</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setKeyStore</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">KeyStoreOptions</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setType</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">jceks</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setPath</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">keystore.jceks</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setPassword</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">secret</span><span style="color:#c0c5ce;">&quot;));
</span><span style="color:#c0c5ce;">
</span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;"> authProvider = </span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">create</span><span style="color:#c0c5ce;">(vertx, authConfig);
</span></pre>
<p>JWTAuth 是 Vert.x 的 AuthProvider 的一个实现；AuthProvider 主要提供根据一个 JSON 的用户信息对象进行用户认证的能力；JWTAuth 则通过校验一个 JWT 型的 JSON token 来验权，同时扩展加上了生成 JWT token 的方法。</p>
<p>JWT 算法和结构相关参见 <a href="https://jwt.io">JWT</a> 。</p>
<ol start="2">
<li>生成并发放 Token</li>
</ol>
<p>这一步一般在登录时进行。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">router.route(&quot;/login&quot;).handler(this::login);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">private void login(final RoutingContext ctx) {
</span><span style="color:#c0c5ce;">  </span><span style="color:#c0c5ce;">if (&quot;paulo&quot;.equals(ctx.request().getParam(&quot;username&quot;)) &amp;&amp; &quot;secret&quot;.equals(ctx.request().getParam(&quot;password&quot;))) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">ctx.response().end(authProvider.generateToken(new JsonObject().put(&quot;sub&quot;, &quot;paulo&quot;), new JWTOptions()));
</span><span style="color:#c0c5ce;">  </span><span style="color:#c0c5ce;">} else {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">ctx.fail(401);
</span><span style="color:#c0c5ce;">  </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">}
</span></pre>
<ol start="3">
<li>验证 Token</li>
</ol>
<p>这一步一般以拦截器的形式实现，用于在访问需要权限控制的接口时，提前通过 JWT 验权来确定是否放行。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">router.route().handler(JWTAuthHandler.create(authProvider));
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">router.get().handler(this::findById);
</span><span style="color:#c0c5ce;">router.post().handler(this::add);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">private void findById(final RoutingContext ctx) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">final User user = ctx.getUser();
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">if (null != user) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// Authenticated
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// TODO
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">private void add(final RoutingContext ctx) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">final User user = ctx.getUser();
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">if (null != user) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// Authenticated
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// TODO
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">}
</span></pre><h1 id="ji-yu-tong-yong-liu-cheng-de-gai-zao"><a class="zola-anchor" href="#ji-yu-tong-yong-liu-cheng-de-gai-zao" aria-label="Anchor link for: ji-yu-tong-yong-liu-cheng-de-gai-zao">🔗</a>
基于通用流程的改造</h1>
<p>因为需要增加对多用户源的支持，所以需要扩充实现 JWT 验证的流程，使得能够：1. 不同用户源的用户需要使用不同的密钥和有效期等基本配置；2. 不同数据源的用户的登录接口参数可以不一样（如用户源 A 通过 username/password，用户源 B 通过 uid/token）</p>
<p>最主要的思路是把各个用户源不同的逻辑抽象出来，包括用户管理、JWT 密钥管理、用户认证、用户授权等；扩展
官方的 JWT Auth Provider，提供多源的分发验证。</p>
<h2 id="yong-hu-yuan-de-chou-xiang-userrealm"><a class="zola-anchor" href="#yong-hu-yuan-de-chou-xiang-userrealm" aria-label="Anchor link for: yong-hu-yuan-de-chou-xiang-userrealm">🔗</a>
用户源的抽象 UserRealm</h2>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public interface </span><span style="color:#ebcb8b;">RxUserRealm </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Set</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">supportedRealms</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">isUserAvailable</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">uid</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">getJwtSecret</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">JwtTokenDto</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authenticate</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">LoginDto </span><span style="color:#bf616a;">login</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authorize</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PrincipalDto </span><span style="color:#bf616a;">pricipal</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PermissionDto </span><span style="color:#bf616a;">permission</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">}
</span></pre>
<p>其中，supportedRealms 说明自身的用户源集合；isUserAvailable 提供根据用户ID或用户名查询用户是否存在的功能；getJwtSecret 提供查询用户源相关的 JWT 密钥的功能；authenticate &amp; authorize 提供各用户源的用户认证和授权管理的功能。</p>
<p>接口的返回使用 <a href="https://github.com/ReactiveX/RxJava">RxJava 2</a> 的类型，主要原因是这些接口可以是远程调用的，可以利用RxJava 的异步响应机制来封装差异。</p>
<p>作为示例，服务提供了一个 DemoUserRealm，用以提供无数据源用户体验服务的能力。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">AutoService</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">)
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">DemoUserRealm </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">RxUserRealm </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private static final </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">UID_PREFIX </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">demo</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private static final </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">JWT_SECRET </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">demo</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Set</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">supportedRealms</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">ImmutableSet</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">of</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">demo</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">isUserAvailable</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">uid</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(uid.</span><span style="color:#bf616a;">startsWith</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">UID_PREFIX</span><span style="color:#eff1f5;">));
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">getJwtSecret</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">JWT_SECRET</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">JwtTokenDto</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authenticate</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">LoginDto </span><span style="color:#bf616a;">login</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> pw </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> login.</span><span style="color:#bf616a;">claims</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">password</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// Omitted
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">JwtTokenDto</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">create</span><span style="color:#eff1f5;">()); </span><span style="color:#65737e;">// Omitted
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authorize</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PrincipalDto </span><span style="color:#bf616a;">principal</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PermissionDto </span><span style="color:#bf616a;">permission</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">switch </span><span style="color:#eff1f5;">(permission.</span><span style="color:#bf616a;">category</span><span style="color:#eff1f5;">()) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">case </span><span style="color:#d08770;">READ</span><span style="color:#c0c5ce;">:
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">TRUE</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">case </span><span style="color:#d08770;">WRITE</span><span style="color:#c0c5ce;">:
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">FALSE</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">default</span><span style="color:#c0c5ce;">:
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">FALSE</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre>
<p><code>@AutoService</code> 注解是 Google Auto-Service 包的一部分，用来辅助实现 Java 基于 <code>java.util.ServiceLoader</code> 的 SPI 机制。</p>
<h2 id="spibaseduserrealmservice"><a class="zola-anchor" href="#spibaseduserrealmservice" aria-label="Anchor link for: spibaseduserrealmservice">🔗</a>
SpiBasedUserRealmService</h2>
<p>为了提高扩展性，可以使用 Java ServiceLoader (<code>java.util.ServiceLoader</code>) 来进行 UserRealm 的管理。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">SpiBasedUserRealmService </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">Map</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; mappedRealms;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#8fa1b3;">SpiBasedUserRealmService</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Map</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; map </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">HashMap</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">ServiceLoader</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; realms </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">ServiceLoader</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">load</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">class</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">for </span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;"> r</span><span style="color:#c0c5ce;">:</span><span style="color:#eff1f5;"> realms) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Set</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; types </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> r.</span><span style="color:#bf616a;">supportedRealms</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(types.</span><span style="color:#bf616a;">isEmpty</span><span style="color:#eff1f5;">()) </span><span style="color:#b48ead;">continue</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">for </span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> type</span><span style="color:#c0c5ce;">:</span><span style="color:#eff1f5;"> types) {
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(map.</span><span style="color:#bf616a;">containsKey</span><span style="color:#eff1f5;">(type)) </span><span style="color:#b48ead;">continue</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">map.</span><span style="color:#bf616a;">put</span><span style="color:#eff1f5;">(type, r);
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// Guava utils
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">mappedRealms </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">ImmutableMap</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">copyOf</span><span style="color:#eff1f5;">(map);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Optional</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">findRealm</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">realm</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Optional</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">ofNullable</span><span style="color:#eff1f5;">(mappedRealms.</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">(type));
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre><h2 id="jwt-auth-provider"><a class="zola-anchor" href="#jwt-auth-provider" aria-label="Anchor link for: jwt-auth-provider">🔗</a>
JWT Auth Provider</h2>
<p>主要的逻辑在 <code>CustomJwtAuthProvider</code> 中。该类实现 Vert.x 内置的 JWTAuth 接口，以能够和 vert.x-web 模块无缝结合。</p>
<p>在 authenticate 的实现中，首先对 JWT 的 token 串进行只解码不验证，从解码出的 JSON 中可以获得对应的用户源类型；可以通过用户源类型找到可用的 RxUserRealm 实例，查询对应的 JWT 配置；之后再使用配置创建原生的 JWTAuth 实例进行 authenticate。</p>
<p>在 generateToken 的实现中，首先根据用户源类型查询到可用的 RxUserRealm 实例，然后使用该实例的 JWT 配置创建原生的 JWTAuth 实例进行 generateToken。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">CustomJwtAuthProvider </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">JWTAuth </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">Scheduler </span><span style="color:#eff1f5;">workingScheduler;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">Vertx </span><span style="color:#eff1f5;">vertx;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">SpiBasedUserRealmService </span><span style="color:#eff1f5;">realmService;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// init code omited
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">authenticate</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JsonObject </span><span style="color:#bf616a;">authInfo</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Handler</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">AsyncResult</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">User</span><span style="color:#eff1f5;">&gt;&gt; </span><span style="color:#bf616a;">resultHandler</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#d08770;">JWT</span><span style="color:#eff1f5;"> decode;
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">try </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> jwtStr </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> authInfo.</span><span style="color:#bf616a;">getString</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">jwt</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">decode </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">JWT</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">decode</span><span style="color:#eff1f5;">(jwtStr);
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">} </span><span style="color:#b48ead;">catch </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">RuntimeException </span><span style="color:#bf616a;">ex</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">resultHandler.</span><span style="color:#bf616a;">handle</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Future</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">failedFuture</span><span style="color:#eff1f5;">(ex));
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> realm </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">firstAudience</span><span style="color:#eff1f5;">(decode);
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">authProviderByRealm</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Strings</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">nullToEmpty</span><span style="color:#eff1f5;">(realm))
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">subscribeOn</span><span style="color:#eff1f5;">(workingScheduler)
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">subscribe</span><span style="color:#eff1f5;">(
</span><span style="color:#eff1f5;">                </span><span style="color:#bf616a;">jwt </span><span style="color:#b48ead;">-&gt;</span><span style="color:#eff1f5;"> jwt.</span><span style="color:#bf616a;">authenticate</span><span style="color:#eff1f5;">(authInfo, </span><span style="color:#bf616a;">re </span><span style="color:#b48ead;">-&gt; </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                    </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(re.</span><span style="color:#bf616a;">failed</span><span style="color:#eff1f5;">()) {
</span><span style="color:#eff1f5;">                        </span><span style="color:#d08770;">LOG</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">warn</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">JWT auth failed for realm </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">{}</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, realm, re.</span><span style="color:#bf616a;">cause</span><span style="color:#eff1f5;">());
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">} </span><span style="color:#b48ead;">else </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                        </span><span style="color:#d08770;">LOG</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">debug</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">JWT auth succeed for realm </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">{}</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, realm);
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">resultHandler.</span><span style="color:#bf616a;">handle</span><span style="color:#eff1f5;">(re);
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">}),
</span><span style="color:#eff1f5;">                </span><span style="color:#bf616a;">ex </span><span style="color:#b48ead;">-&gt; </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                    </span><span style="color:#d08770;">LOG</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">warn</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">JWT auth exception for realm </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">{}</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, realm, ex);
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">resultHandler.</span><span style="color:#bf616a;">handle</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Future</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">failedFuture</span><span style="color:#eff1f5;">(ex));
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">String </span><span style="color:#8fa1b3;">firstAudience</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Payload </span><span style="color:#bf616a;">payload</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; audience </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> payload.</span><span style="color:#bf616a;">getAudience</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">null </span><span style="color:#c0c5ce;">!=</span><span style="color:#eff1f5;"> audience </span><span style="color:#c0c5ce;">&amp;&amp; !</span><span style="color:#eff1f5;"> audience.</span><span style="color:#bf616a;">isEmpty</span><span style="color:#eff1f5;">()) </span><span style="color:#c0c5ce;">?</span><span style="color:#eff1f5;"> audience.</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">: &quot;&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">String </span><span style="color:#8fa1b3;">generateToken</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JsonObject </span><span style="color:#bf616a;">claims</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JWTOptions </span><span style="color:#bf616a;">options</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> realm </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> claims.</span><span style="color:#bf616a;">getString</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">aud</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">authProviderByRealm</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Strings</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">nullToEmpty</span><span style="color:#eff1f5;">(realm))
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">jwt </span><span style="color:#b48ead;">-&gt;</span><span style="color:#eff1f5;"> jwt.</span><span style="color:#bf616a;">generateToken</span><span style="color:#eff1f5;">(claims, options))
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">blockingGet</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authProviderByRealm</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">realm</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Optional</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; opt </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> realmService.</span><span style="color:#bf616a;">findRealm</span><span style="color:#eff1f5;">(realm);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">!</span><span style="color:#eff1f5;"> opt.</span><span style="color:#bf616a;">isPresent</span><span style="color:#eff1f5;">())
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">IllegalStateException</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Realm not supported: </span><span style="color:#c0c5ce;">&quot; +</span><span style="color:#eff1f5;"> realm));
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;"> opt.</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">findJwtSecret</span><span style="color:#eff1f5;">(realm).</span><span style="color:#bf616a;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">::</span><span style="color:#bf616a;">jwtAuth</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">JWTAuth </span><span style="color:#8fa1b3;">jwtAuth</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">key</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">create</span><span style="color:#eff1f5;">(vertx, </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">JWTAuthOptions</span><span style="color:#eff1f5;">()
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">addPubSecKey</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">PubSecKeyOptions</span><span style="color:#eff1f5;">()
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">setAlgorithm</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">HS256</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">setPublicKey</span><span style="color:#eff1f5;">(key)
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">setSymmetric</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre><h2 id="auth-handler"><a class="zola-anchor" href="#auth-handler" aria-label="Anchor link for: auth-handler">🔗</a>
Auth Handler</h2>
<p>对于需要用户认证和验权保护的接口，正常使用 vert.x-web 模块提供的 JWTAuthHandler 机制。</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// ...
</span><span style="color:#65737e;">// omited
</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;"> jwtAuth = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CustomJwtAuthProvider</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">router.</span><span style="color:#bf616a;">route</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">handler</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">JWTAuthHandler</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">create</span><span style="color:#c0c5ce;">(jwtAuth)</span><span style="background-color:#bf616a;color:#2b303b;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// omited
</span><span style="color:#65737e;">// ...
</span></pre><h2 id="login-controller"><a class="zola-anchor" href="#login-controller" aria-label="Anchor link for: login-controller">🔗</a>
Login Controller</h2>
<p>最后一步是在 HTTP 的 handler 里面使用 CustomJwtAuthProvider 生成 JWT token 并返回给调用方使用。</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// ...
</span><span style="color:#65737e;">// omited
</span><span style="color:#c0c5ce;">router.</span><span style="color:#bf616a;">post</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/login</span><span style="color:#c0c5ce;">&quot;).</span><span style="color:#bf616a;">handler</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">::</span><span style="color:#bf616a;">login</span><span style="color:#c0c5ce;">);
</span><span style="color:#65737e;">// omited
</span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;"> jwtAuth; </span><span style="color:#65737e;">// formerly inited
</span><span style="color:#b48ead;">private</span><span style="color:#c0c5ce;"> void </span><span style="color:#bf616a;">login</span><span style="color:#c0c5ce;">(final </span><span style="color:#ebcb8b;">RoutingContext</span><span style="color:#c0c5ce;"> ctx) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// Generate JWT token
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// final String token = jwtAuth.generateToken(...);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#c0c5ce;"> token = &quot;</span><span style="color:#a3be8c;">generated token</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">ctx.</span><span style="color:#bf616a;">response</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">end</span><span style="color:#c0c5ce;">(token);
</span><span style="color:#c0c5ce;">}
</span></pre><h1 id="zong-jie"><a class="zola-anchor" href="#zong-jie" aria-label="Anchor link for: zong-jie">🔗</a>
总结</h1>
<p>整个设计的基本思路就是基于内置的 JWTAuth 实现类
(io.vertx.ext.auth.jwt.impl.JWTAuthProviderImpl)，在 authenticate &amp; generateToken 的实现中从参数中取
出用户源类型，再根据用户源类型执行各自的逻辑，之后再调用 JWTAuthProviderImpl 的实现。这样在 Vert.x
的框架范围之内做最小的改动实现了所需要的功能。不同的用户源的实现和管理可以使用不同的方式实现，我在项
目中使用的是 Java 的 SPI 服务发现机制；如果有必要，可以在项目中引入依赖注入框架（如 <a href="https://github.com/google/guice">Guice</a> <a href="https://spring.io/projects/spring-framework">Spring</a> 等）管理用户源逻辑的实现。</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;vert-x&#x2F;">#vert.x</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;jwt&#x2F;">#jwt</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;auth&#x2F;">#auth</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-11-graphviz-note&#x2F;">‹ Graphviz Dot Note</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-21-a-product-env-bug-misused-hashmap-nullability&#x2F;">记一次由于误用 HashMap 值的 null 特性的 BUG ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;www.wangbo.im&#x2F;even.js" ></script>
      
    </body>

</html>
