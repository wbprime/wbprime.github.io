

<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>Wbprime</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">Wbprime</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;www.wangbo.im">Wbprime</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https://www.wangbo.im">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    


<div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">Contents</h2>
    <div class="post-toc-content always-active">
        <nav id="TableOfContents">
            <ul>
                
                <li>
                    <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#vert-x-dui-jwt-de-zhi-chi" class="toc-link">Vert.x å¯¹ JWT çš„æ”¯æŒ</a>
                    
                </li>
                
                <li>
                    <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#ji-yu-tong-yong-liu-cheng-de-gai-zao" class="toc-link">åŸºäºé€šç”¨æµç¨‹çš„æ”¹é€ </a>
                    
                    <ul>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#yong-hu-yuan-de-chou-xiang-userrealm" class="toc-link">ç”¨æˆ·æºçš„æŠ½è±¡ UserRealm</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#spibaseduserrealmservice" class="toc-link">SpiBasedUserRealmService</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#jwt-auth-provider" class="toc-link">JWT Auth Provider</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#auth-handler" class="toc-link">Auth Handler</a>
                        </li>
                        
                        <li>
                            <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#login-controller" class="toc-link">Login Controller</a>
                        </li>
                        
                    </ul>
                    
                </li>
                
                <li>
                    <a href="https://www.wangbo.im/posts/2019-03-12-multiple-jwt-auth-handler-in-vertx/#zong-jie" class="toc-link">æ€»ç»“</a>
                    
                </li>
                
            </ul>
        </nav>
    </div>
</div>


<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-12-multiple-jwt-auth-handler-in-vertx&#x2F;">Multiple JWT Auth Handlers in Vert.x</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-03-12</span>
            
        </div>
    </header>

    <div class="post-content">
      <p><a href="https://vertx.io">Vert.x</a> çš„å®˜æ–¹ Web å¼€å‘åŒ… <a href="https://vertx.io/docs/vertx-web/java/">Vert.x-Web</a> ä¸­
æä¾›äº†å†…ç½®çš„ Authentication&amp;Authorisation æ”¯æŒï¼›é€šè¿‡æ‰©å±•çš„
<a href="https://vertx.io/docs/vertx-auth-common/java/">Auth Common</a> æ¨¡å—å’Œ <a href="https://vertx.io/docs/vertx-auth-jdbc/java/">JDBC
auth</a> <a href="https://vertx.io/docs/vertx-auth-mongo/java/">MongoDB
auth</a> <a href="https://vertx.io/docs/vertx-auth-shiro/java/">Shiro
auth</a> <a href="https://vertx.io/docs/vertx-auth-jwt/java/">JWT
auth</a> <a href="https://vertx.io/docs/vertx-auth-oauth2/java/">OAuth 2</a> ç­‰æ¨¡å—ï¼Œå¯ä»¥è¦†ç›–å¤§éƒ¨åˆ†çš„ç”¨æˆ·è®¤è¯ä¸éªŒæƒçš„æ”¯æŒã€‚</p>
<p>åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œé‡åˆ°äº†ä¸€ä¸ªæ”¯æŒå¤šç”¨æˆ·æä¾›æ–¹çš„éœ€æ±‚ï¼šé¡¹ç›®çš„ç”¨æˆ·æ˜¯ä»å¤šä¸ªå…¶ä»–é¡¹ç›®å¯¼å…¥çš„ï¼›é¡¹ç›®çš„é€»è¾‘æ¯”è¾ƒç®€
å•ï¼Œä¸æƒ³ç»´æŠ¤è‡ªå·±çš„ç”¨æˆ·ä¿¡æ¯æ•°æ®å’Œå¤–éƒ¨æ˜ å°„ã€‚</p>
<p>æ¯”å¦‚ï¼Œé¡¹ç›®éœ€è¦æ”¯æŒä¸»ç«™ç”¨æˆ·ã€è§†é¢‘ç½‘ç«™ç­‰å…¥å£ç™»å½•è®¿é—®ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œåªéœ€è¦é¡¹ç›®ç»´æŠ¤ä¸€å¥—å†…éƒ¨ç”¨æˆ·è¡¨ã€ä¸€ä¸ªå¤–
éƒ¨é¡¹ç›®è¡¨ä»¥åŠå†…éƒ¨ç”¨æˆ·å’Œå¤–éƒ¨ç”¨æˆ·çš„æ˜ å°„è¡¨ï¼›åœ¨ç”¨æˆ·å¯¼å…¥æˆ–ç”¨æˆ·ç»‘å®šè¯·æ±‚æ—¶ï¼Œå»ºç«‹å¤–éƒ¨é¡¹ç›® ID å’Œå¤–éƒ¨é¡¹ç›®ç”¨æˆ·
ID ä¸å†…éƒ¨ç”¨æˆ· ID çš„å¯¹åº”å…³ç³»ï¼›åœ¨ç™»å½•è¯·æ±‚æ—¶ï¼Œæ ¹æ®å¤–éƒ¨é¡¹ç›® ID å’Œå¤–éƒ¨é¡¹ç›®ç”¨æˆ· ID è°ƒç”¨ç”¨æˆ·è®¤è¯å›è°ƒï¼Œé€šè¿‡
åå†å¯»æ‰¾åˆ°å†…éƒ¨ç”¨æˆ·çš„ ID å³å¯ã€‚</p>
<p>å®é™…åœ¨é¡¹ç›®çš„è®¾è®¡å’Œå®ç°è¿‡ç¨‹ä¸­ï¼Œé‡‡ç”¨äº†ä¸€ä¸ªæ¯”è¾ƒå¥½ç©çš„æ–¹æ³•ï¼šåœ¨å†…éƒ¨ç”¨æˆ·è¡¨çš„åŸºç¡€ä¸Šï¼Œå¯¹ç”¨æˆ·ä½¿ç”¨
<a href="https://jwt.io">JWT</a> çš„è®¤è¯æ¨¡å‹ï¼›ç”¨æˆ·ç™»å½•æ—¶ï¼Œæ ¹æ®å¤–éƒ¨é¡¹ç›® ID å’Œå¤–éƒ¨é¡¹ç›®ç”¨æˆ· ID è°ƒç”¨ç”¨æˆ·è®¤è¯å›è°ƒï¼Œå‘
æ”¾ JWT tokenï¼Œåœ¨ token ä¸­é™å®šç”¨æˆ·çš„è®¿é—®æƒé™ã€‚</p>
<p><a name="continue-reading"></a></p>
<h1 id="vert-x-dui-jwt-de-zhi-chi"><a class="zola-anchor" href="#vert-x-dui-jwt-de-zhi-chi" aria-label="Anchor link for: vert-x-dui-jwt-de-zhi-chi">ğŸ”—</a>
Vert.x å¯¹ JWT çš„æ”¯æŒ</h1>
<p>ç›¸å…³æ–‡æ¡£å‚è§ <a href="https://vertx.io/docs/vertx-auth-common/java/">Vert.x Auth Common</a> <a href="https://vertx.io/docs/vertx-auth-jwt/java/">Vert.x
JWT</a> <a href="https://vertx.io/docs/vertx-web/java/#_authentication_authorisation">Vert.x Web AuthN &amp;
AuthZ</a> ã€‚</p>
<ol>
<li>ç¡®å®š JWT çš„ç®—æ³•å’Œå¯†é’¥</li>
</ol>
<pre style="background-color:#2b303b;">
<span style="color:#ebcb8b;">WTAuthOptions</span><span style="color:#c0c5ce;"> authConfig = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">JWTAuthOptions</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setKeyStore</span><span style="color:#c0c5ce;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">KeyStoreOptions</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setType</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">jceks</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setPath</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">keystore.jceks</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">setPassword</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">secret</span><span style="color:#c0c5ce;">&quot;));
</span><span style="color:#c0c5ce;">
</span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;"> authProvider = </span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">create</span><span style="color:#c0c5ce;">(vertx, authConfig);
</span></pre>
<p>JWTAuth æ˜¯ Vert.x çš„ AuthProvider çš„ä¸€ä¸ªå®ç°ï¼›AuthProvider ä¸»è¦æä¾›æ ¹æ®ä¸€ä¸ª JSON çš„ç”¨æˆ·ä¿¡æ¯å¯¹è±¡è¿›è¡Œç”¨æˆ·è®¤è¯çš„èƒ½åŠ›ï¼›JWTAuth åˆ™é€šè¿‡æ ¡éªŒä¸€ä¸ª JWT å‹çš„ JSON token æ¥éªŒæƒï¼ŒåŒæ—¶æ‰©å±•åŠ ä¸Šäº†ç”Ÿæˆ JWT token çš„æ–¹æ³•ã€‚</p>
<p>JWT ç®—æ³•å’Œç»“æ„ç›¸å…³å‚è§ <a href="https://jwt.io">JWT</a> ã€‚</p>
<ol start="2">
<li>ç”Ÿæˆå¹¶å‘æ”¾ Token</li>
</ol>
<p>è¿™ä¸€æ­¥ä¸€èˆ¬åœ¨ç™»å½•æ—¶è¿›è¡Œã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">router.route(&quot;/login&quot;).handler(this::login);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">private void login(final RoutingContext ctx) {
</span><span style="color:#c0c5ce;">  </span><span style="color:#c0c5ce;">if (&quot;paulo&quot;.equals(ctx.request().getParam(&quot;username&quot;)) &amp;&amp; &quot;secret&quot;.equals(ctx.request().getParam(&quot;password&quot;))) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">ctx.response().end(authProvider.generateToken(new JsonObject().put(&quot;sub&quot;, &quot;paulo&quot;), new JWTOptions()));
</span><span style="color:#c0c5ce;">  </span><span style="color:#c0c5ce;">} else {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">ctx.fail(401);
</span><span style="color:#c0c5ce;">  </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">}
</span></pre>
<ol start="3">
<li>éªŒè¯ Token</li>
</ol>
<p>è¿™ä¸€æ­¥ä¸€èˆ¬ä»¥æ‹¦æˆªå™¨çš„å½¢å¼å®ç°ï¼Œç”¨äºåœ¨è®¿é—®éœ€è¦æƒé™æ§åˆ¶çš„æ¥å£æ—¶ï¼Œæå‰é€šè¿‡ JWT éªŒæƒæ¥ç¡®å®šæ˜¯å¦æ”¾è¡Œã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">router.route().handler(JWTAuthHandler.create(authProvider));
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">router.get().handler(this::findById);
</span><span style="color:#c0c5ce;">router.post().handler(this::add);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">private void findById(final RoutingContext ctx) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">final User user = ctx.getUser();
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">if (null != user) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// Authenticated
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// TODO
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">private void add(final RoutingContext ctx) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">final User user = ctx.getUser();
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">if (null != user) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// Authenticated
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">// TODO
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">}
</span></pre><h1 id="ji-yu-tong-yong-liu-cheng-de-gai-zao"><a class="zola-anchor" href="#ji-yu-tong-yong-liu-cheng-de-gai-zao" aria-label="Anchor link for: ji-yu-tong-yong-liu-cheng-de-gai-zao">ğŸ”—</a>
åŸºäºé€šç”¨æµç¨‹çš„æ”¹é€ </h1>
<p>å› ä¸ºéœ€è¦å¢åŠ å¯¹å¤šç”¨æˆ·æºçš„æ”¯æŒï¼Œæ‰€ä»¥éœ€è¦æ‰©å……å®ç° JWT éªŒè¯çš„æµç¨‹ï¼Œä½¿å¾—èƒ½å¤Ÿï¼š1. ä¸åŒç”¨æˆ·æºçš„ç”¨æˆ·éœ€è¦ä½¿ç”¨ä¸åŒçš„å¯†é’¥å’Œæœ‰æ•ˆæœŸç­‰åŸºæœ¬é…ç½®ï¼›2. ä¸åŒæ•°æ®æºçš„ç”¨æˆ·çš„ç™»å½•æ¥å£å‚æ•°å¯ä»¥ä¸ä¸€æ ·ï¼ˆå¦‚ç”¨æˆ·æº A é€šè¿‡ username/passwordï¼Œç”¨æˆ·æº B é€šè¿‡ uid/tokenï¼‰</p>
<p>æœ€ä¸»è¦çš„æ€è·¯æ˜¯æŠŠå„ä¸ªç”¨æˆ·æºä¸åŒçš„é€»è¾‘æŠ½è±¡å‡ºæ¥ï¼ŒåŒ…æ‹¬ç”¨æˆ·ç®¡ç†ã€JWT å¯†é’¥ç®¡ç†ã€ç”¨æˆ·è®¤è¯ã€ç”¨æˆ·æˆæƒç­‰ï¼›æ‰©å±•
å®˜æ–¹çš„ JWT Auth Providerï¼Œæä¾›å¤šæºçš„åˆ†å‘éªŒè¯ã€‚</p>
<h2 id="yong-hu-yuan-de-chou-xiang-userrealm"><a class="zola-anchor" href="#yong-hu-yuan-de-chou-xiang-userrealm" aria-label="Anchor link for: yong-hu-yuan-de-chou-xiang-userrealm">ğŸ”—</a>
ç”¨æˆ·æºçš„æŠ½è±¡ UserRealm</h2>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public interface </span><span style="color:#ebcb8b;">RxUserRealm </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Set</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">supportedRealms</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">isUserAvailable</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">uid</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">getJwtSecret</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">JwtTokenDto</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authenticate</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">LoginDto </span><span style="color:#bf616a;">login</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authorize</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PrincipalDto </span><span style="color:#bf616a;">pricipal</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PermissionDto </span><span style="color:#bf616a;">permission</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">}
</span></pre>
<p>å…¶ä¸­ï¼ŒsupportedRealms è¯´æ˜è‡ªèº«çš„ç”¨æˆ·æºé›†åˆï¼›isUserAvailable æä¾›æ ¹æ®ç”¨æˆ·IDæˆ–ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·æ˜¯å¦å­˜åœ¨çš„åŠŸèƒ½ï¼›getJwtSecret æä¾›æŸ¥è¯¢ç”¨æˆ·æºç›¸å…³çš„ JWT å¯†é’¥çš„åŠŸèƒ½ï¼›authenticate &amp; authorize æä¾›å„ç”¨æˆ·æºçš„ç”¨æˆ·è®¤è¯å’Œæˆæƒç®¡ç†çš„åŠŸèƒ½ã€‚</p>
<p>æ¥å£çš„è¿”å›ä½¿ç”¨ <a href="https://github.com/ReactiveX/RxJava">RxJava 2</a> çš„ç±»å‹ï¼Œä¸»è¦åŸå› æ˜¯è¿™äº›æ¥å£å¯ä»¥æ˜¯è¿œç¨‹è°ƒç”¨çš„ï¼Œå¯ä»¥åˆ©ç”¨RxJava çš„å¼‚æ­¥å“åº”æœºåˆ¶æ¥å°è£…å·®å¼‚ã€‚</p>
<p>ä½œä¸ºç¤ºä¾‹ï¼ŒæœåŠ¡æä¾›äº†ä¸€ä¸ª DemoUserRealmï¼Œç”¨ä»¥æä¾›æ— æ•°æ®æºç”¨æˆ·ä½“éªŒæœåŠ¡çš„èƒ½åŠ›ã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">AutoService</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">)
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">DemoUserRealm </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">RxUserRealm </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private static final </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">UID_PREFIX </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">demo</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private static final </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">JWT_SECRET </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">demo</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Set</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">supportedRealms</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">ImmutableSet</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">of</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">demo</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">isUserAvailable</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">uid</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(uid.</span><span style="color:#bf616a;">startsWith</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">UID_PREFIX</span><span style="color:#eff1f5;">));
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">getJwtSecret</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">JWT_SECRET</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">JwtTokenDto</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authenticate</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">LoginDto </span><span style="color:#bf616a;">login</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> pw </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> login.</span><span style="color:#bf616a;">claims</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">password</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// Omitted
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">JwtTokenDto</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">create</span><span style="color:#eff1f5;">()); </span><span style="color:#65737e;">// Omitted
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authorize</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PrincipalDto </span><span style="color:#bf616a;">principal</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">PermissionDto </span><span style="color:#bf616a;">permission</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">switch </span><span style="color:#eff1f5;">(permission.</span><span style="color:#bf616a;">category</span><span style="color:#eff1f5;">()) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">case </span><span style="color:#d08770;">READ</span><span style="color:#c0c5ce;">:
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">TRUE</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">case </span><span style="color:#d08770;">WRITE</span><span style="color:#c0c5ce;">:
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">FALSE</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">default</span><span style="color:#c0c5ce;">:
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Boolean</span><span style="color:#eff1f5;">.</span><span style="color:#d08770;">FALSE</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre>
<p><code>@AutoService</code> æ³¨è§£æ˜¯ Google Auto-Service åŒ…çš„ä¸€éƒ¨åˆ†ï¼Œç”¨æ¥è¾…åŠ©å®ç° Java åŸºäº <code>java.util.ServiceLoader</code> çš„ SPI æœºåˆ¶ã€‚</p>
<h2 id="spibaseduserrealmservice"><a class="zola-anchor" href="#spibaseduserrealmservice" aria-label="Anchor link for: spibaseduserrealmservice">ğŸ”—</a>
SpiBasedUserRealmService</h2>
<p>ä¸ºäº†æé«˜æ‰©å±•æ€§ï¼Œå¯ä»¥ä½¿ç”¨ Java ServiceLoader (<code>java.util.ServiceLoader</code>) æ¥è¿›è¡Œ UserRealm çš„ç®¡ç†ã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">SpiBasedUserRealmService </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">Map</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; mappedRealms;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#8fa1b3;">SpiBasedUserRealmService</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Map</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; map </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">HashMap</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">ServiceLoader</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; realms </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">ServiceLoader</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">load</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">class</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">for </span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;"> r</span><span style="color:#c0c5ce;">:</span><span style="color:#eff1f5;"> realms) {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Set</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; types </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> r.</span><span style="color:#bf616a;">supportedRealms</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(types.</span><span style="color:#bf616a;">isEmpty</span><span style="color:#eff1f5;">()) </span><span style="color:#b48ead;">continue</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">for </span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> type</span><span style="color:#c0c5ce;">:</span><span style="color:#eff1f5;"> types) {
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(map.</span><span style="color:#bf616a;">containsKey</span><span style="color:#eff1f5;">(type)) </span><span style="color:#b48ead;">continue</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">map.</span><span style="color:#bf616a;">put</span><span style="color:#eff1f5;">(type, r);
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#65737e;">// Guava utils
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">mappedRealms </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">ImmutableMap</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">copyOf</span><span style="color:#eff1f5;">(map);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Optional</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">findRealm</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">realm</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Optional</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">ofNullable</span><span style="color:#eff1f5;">(mappedRealms.</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">(type));
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre><h2 id="jwt-auth-provider"><a class="zola-anchor" href="#jwt-auth-provider" aria-label="Anchor link for: jwt-auth-provider">ğŸ”—</a>
JWT Auth Provider</h2>
<p>ä¸»è¦çš„é€»è¾‘åœ¨ <code>CustomJwtAuthProvider</code> ä¸­ã€‚è¯¥ç±»å®ç° Vert.x å†…ç½®çš„ JWTAuth æ¥å£ï¼Œä»¥èƒ½å¤Ÿå’Œ vert.x-web æ¨¡å—æ— ç¼ç»“åˆã€‚</p>
<p>åœ¨ authenticate çš„å®ç°ä¸­ï¼Œé¦–å…ˆå¯¹ JWT çš„ token ä¸²è¿›è¡Œåªè§£ç ä¸éªŒè¯ï¼Œä»è§£ç å‡ºçš„ JSON ä¸­å¯ä»¥è·å¾—å¯¹åº”çš„ç”¨æˆ·æºç±»å‹ï¼›å¯ä»¥é€šè¿‡ç”¨æˆ·æºç±»å‹æ‰¾åˆ°å¯ç”¨çš„ RxUserRealm å®ä¾‹ï¼ŒæŸ¥è¯¢å¯¹åº”çš„ JWT é…ç½®ï¼›ä¹‹åå†ä½¿ç”¨é…ç½®åˆ›å»ºåŸç”Ÿçš„ JWTAuth å®ä¾‹è¿›è¡Œ authenticateã€‚</p>
<p>åœ¨ generateToken çš„å®ç°ä¸­ï¼Œé¦–å…ˆæ ¹æ®ç”¨æˆ·æºç±»å‹æŸ¥è¯¢åˆ°å¯ç”¨çš„ RxUserRealm å®ä¾‹ï¼Œç„¶åä½¿ç”¨è¯¥å®ä¾‹çš„ JWT é…ç½®åˆ›å»ºåŸç”Ÿçš„ JWTAuth å®ä¾‹è¿›è¡Œ generateTokenã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">class </span><span style="color:#ebcb8b;">CustomJwtAuthProvider </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">JWTAuth </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">Scheduler </span><span style="color:#eff1f5;">workingScheduler;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">Vertx </span><span style="color:#eff1f5;">vertx;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">SpiBasedUserRealmService </span><span style="color:#eff1f5;">realmService;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// init code omited
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public void </span><span style="color:#8fa1b3;">authenticate</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JsonObject </span><span style="color:#bf616a;">authInfo</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Handler</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">AsyncResult</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">User</span><span style="color:#eff1f5;">&gt;&gt; </span><span style="color:#bf616a;">resultHandler</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#d08770;">JWT</span><span style="color:#eff1f5;"> decode;
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">try </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> jwtStr </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> authInfo.</span><span style="color:#bf616a;">getString</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">jwt</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">decode </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">JWT</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">decode</span><span style="color:#eff1f5;">(jwtStr);
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">} </span><span style="color:#b48ead;">catch </span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">RuntimeException </span><span style="color:#bf616a;">ex</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">resultHandler.</span><span style="color:#bf616a;">handle</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Future</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">failedFuture</span><span style="color:#eff1f5;">(ex));
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> realm </span><span style="color:#c0c5ce;">= </span><span style="color:#bf616a;">firstAudience</span><span style="color:#eff1f5;">(decode);
</span><span style="color:#eff1f5;">        </span><span style="color:#bf616a;">authProviderByRealm</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Strings</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">nullToEmpty</span><span style="color:#eff1f5;">(realm))
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">subscribeOn</span><span style="color:#eff1f5;">(workingScheduler)
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">subscribe</span><span style="color:#eff1f5;">(
</span><span style="color:#eff1f5;">                </span><span style="color:#bf616a;">jwt </span><span style="color:#b48ead;">-&gt;</span><span style="color:#eff1f5;"> jwt.</span><span style="color:#bf616a;">authenticate</span><span style="color:#eff1f5;">(authInfo, </span><span style="color:#bf616a;">re </span><span style="color:#b48ead;">-&gt; </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                    </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(re.</span><span style="color:#bf616a;">failed</span><span style="color:#eff1f5;">()) {
</span><span style="color:#eff1f5;">                        </span><span style="color:#d08770;">LOG</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">warn</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">JWT auth failed for realm </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">{}</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, realm, re.</span><span style="color:#bf616a;">cause</span><span style="color:#eff1f5;">());
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">} </span><span style="color:#b48ead;">else </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                        </span><span style="color:#d08770;">LOG</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">debug</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">JWT auth succeed for realm </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">{}</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, realm);
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">resultHandler.</span><span style="color:#bf616a;">handle</span><span style="color:#eff1f5;">(re);
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">}),
</span><span style="color:#eff1f5;">                </span><span style="color:#bf616a;">ex </span><span style="color:#b48ead;">-&gt; </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">                    </span><span style="color:#d08770;">LOG</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">warn</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">JWT auth exception for realm </span><span style="color:#96b5b4;">\&quot;</span><span style="color:#a3be8c;">{}</span><span style="color:#96b5b4;">\&quot;</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">, realm, ex);
</span><span style="color:#eff1f5;">                    </span><span style="color:#eff1f5;">resultHandler.</span><span style="color:#bf616a;">handle</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Future</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">failedFuture</span><span style="color:#eff1f5;">(ex));
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">String </span><span style="color:#8fa1b3;">firstAudience</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Payload </span><span style="color:#bf616a;">payload</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; audience </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> payload.</span><span style="color:#bf616a;">getAudience</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">null </span><span style="color:#c0c5ce;">!=</span><span style="color:#eff1f5;"> audience </span><span style="color:#c0c5ce;">&amp;&amp; !</span><span style="color:#eff1f5;"> audience.</span><span style="color:#bf616a;">isEmpty</span><span style="color:#eff1f5;">()) </span><span style="color:#c0c5ce;">?</span><span style="color:#eff1f5;"> audience.</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">) </span><span style="color:#c0c5ce;">: &quot;&quot;</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">String </span><span style="color:#8fa1b3;">generateToken</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JsonObject </span><span style="color:#bf616a;">claims</span><span style="color:#eff1f5;">, </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JWTOptions </span><span style="color:#bf616a;">options</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;"> realm </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> claims.</span><span style="color:#bf616a;">getString</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">aud</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">authProviderByRealm</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Strings</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">nullToEmpty</span><span style="color:#eff1f5;">(realm))
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">jwt </span><span style="color:#b48ead;">-&gt;</span><span style="color:#eff1f5;"> jwt.</span><span style="color:#bf616a;">generateToken</span><span style="color:#eff1f5;">(claims, options))
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">blockingGet</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">authProviderByRealm</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">realm</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">Optional</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RxUserRealm</span><span style="color:#eff1f5;">&gt; opt </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> realmService.</span><span style="color:#bf616a;">findRealm</span><span style="color:#eff1f5;">(realm);
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">if </span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">!</span><span style="color:#eff1f5;"> opt.</span><span style="color:#bf616a;">isPresent</span><span style="color:#eff1f5;">())
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Single</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">error</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">IllegalStateException</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Realm not supported: </span><span style="color:#c0c5ce;">&quot; +</span><span style="color:#eff1f5;"> realm));
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return</span><span style="color:#eff1f5;"> opt.</span><span style="color:#bf616a;">get</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">findJwtSecret</span><span style="color:#eff1f5;">(realm).</span><span style="color:#bf616a;">map</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">::</span><span style="color:#bf616a;">jwtAuth</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">JWTAuth </span><span style="color:#8fa1b3;">jwtAuth</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">key</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">create</span><span style="color:#eff1f5;">(vertx, </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">JWTAuthOptions</span><span style="color:#eff1f5;">()
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">addPubSecKey</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">PubSecKeyOptions</span><span style="color:#eff1f5;">()
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">setAlgorithm</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">HS256</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">setPublicKey</span><span style="color:#eff1f5;">(key)
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">setSymmetric</span><span style="color:#eff1f5;">(</span><span style="color:#d08770;">true</span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">            </span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre><h2 id="auth-handler"><a class="zola-anchor" href="#auth-handler" aria-label="Anchor link for: auth-handler">ğŸ”—</a>
Auth Handler</h2>
<p>å¯¹äºéœ€è¦ç”¨æˆ·è®¤è¯å’ŒéªŒæƒä¿æŠ¤çš„æ¥å£ï¼Œæ­£å¸¸ä½¿ç”¨ vert.x-web æ¨¡å—æä¾›çš„ JWTAuthHandler æœºåˆ¶ã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// ...
</span><span style="color:#65737e;">// omited
</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;"> jwtAuth = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CustomJwtAuthProvider</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">router.</span><span style="color:#bf616a;">route</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">handler</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">JWTAuthHandler</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">create</span><span style="color:#c0c5ce;">(jwtAuth)</span><span style="background-color:#bf616a;color:#2b303b;">;</span><span style="color:#c0c5ce;">
</span><span style="color:#65737e;">// omited
</span><span style="color:#65737e;">// ...
</span></pre><h2 id="login-controller"><a class="zola-anchor" href="#login-controller" aria-label="Anchor link for: login-controller">ğŸ”—</a>
Login Controller</h2>
<p>æœ€åä¸€æ­¥æ˜¯åœ¨ HTTP çš„ handler é‡Œé¢ä½¿ç”¨ CustomJwtAuthProvider ç”Ÿæˆ JWT token å¹¶è¿”å›ç»™è°ƒç”¨æ–¹ä½¿ç”¨ã€‚</p>
<pre style="background-color:#2b303b;">
<span style="color:#65737e;">// ...
</span><span style="color:#65737e;">// omited
</span><span style="color:#c0c5ce;">router.</span><span style="color:#bf616a;">post</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/login</span><span style="color:#c0c5ce;">&quot;).</span><span style="color:#bf616a;">handler</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">::</span><span style="color:#bf616a;">login</span><span style="color:#c0c5ce;">);
</span><span style="color:#65737e;">// omited
</span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#ebcb8b;">JWTAuth</span><span style="color:#c0c5ce;"> jwtAuth; </span><span style="color:#65737e;">// formerly inited
</span><span style="color:#b48ead;">private</span><span style="color:#c0c5ce;"> void </span><span style="color:#bf616a;">login</span><span style="color:#c0c5ce;">(final </span><span style="color:#ebcb8b;">RoutingContext</span><span style="color:#c0c5ce;"> ctx) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// Generate JWT token
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// final String token = jwtAuth.generateToken(...);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String</span><span style="color:#c0c5ce;"> token = &quot;</span><span style="color:#a3be8c;">generated token</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">ctx.</span><span style="color:#bf616a;">response</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">end</span><span style="color:#c0c5ce;">(token);
</span><span style="color:#c0c5ce;">}
</span></pre><h1 id="zong-jie"><a class="zola-anchor" href="#zong-jie" aria-label="Anchor link for: zong-jie">ğŸ”—</a>
æ€»ç»“</h1>
<p>æ•´ä¸ªè®¾è®¡çš„åŸºæœ¬æ€è·¯å°±æ˜¯åŸºäºå†…ç½®çš„ JWTAuth å®ç°ç±»
(io.vertx.ext.auth.jwt.impl.JWTAuthProviderImpl)ï¼Œåœ¨ authenticate &amp; generateToken çš„å®ç°ä¸­ä»å‚æ•°ä¸­å–
å‡ºç”¨æˆ·æºç±»å‹ï¼Œå†æ ¹æ®ç”¨æˆ·æºç±»å‹æ‰§è¡Œå„è‡ªçš„é€»è¾‘ï¼Œä¹‹åå†è°ƒç”¨ JWTAuthProviderImpl çš„å®ç°ã€‚è¿™æ ·åœ¨ Vert.x
çš„æ¡†æ¶èŒƒå›´ä¹‹å†…åšæœ€å°çš„æ”¹åŠ¨å®ç°äº†æ‰€éœ€è¦çš„åŠŸèƒ½ã€‚ä¸åŒçš„ç”¨æˆ·æºçš„å®ç°å’Œç®¡ç†å¯ä»¥ä½¿ç”¨ä¸åŒçš„æ–¹å¼å®ç°ï¼Œæˆ‘åœ¨é¡¹
ç›®ä¸­ä½¿ç”¨çš„æ˜¯ Java çš„ SPI æœåŠ¡å‘ç°æœºåˆ¶ï¼›å¦‚æœæœ‰å¿…è¦ï¼Œå¯ä»¥åœ¨é¡¹ç›®ä¸­å¼•å…¥ä¾èµ–æ³¨å…¥æ¡†æ¶ï¼ˆå¦‚ <a href="https://github.com/google/guice">Guice</a> <a href="https://spring.io/projects/spring-framework">Spring</a> ç­‰ï¼‰ç®¡ç†ç”¨æˆ·æºé€»è¾‘çš„å®ç°ã€‚</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;vert-x&#x2F;">#vert.x</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;jwt&#x2F;">#jwt</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;auth&#x2F;">#auth</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-11-graphviz-note&#x2F;">â€¹ Graphviz Dot Note</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-21-a-product-env-bug-misused-hashmap-nullability&#x2F;">è®°ä¸€æ¬¡ç”±äºè¯¯ç”¨ HashMap å€¼çš„ null ç‰¹æ€§çš„ BUG â€º</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;www.wangbo.im&#x2F;even.js" ></script>
      
    </body>

</html>
