<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Libevent Note</title>
        <style>

    html body {
        font-family: Raleway, sans-serif;
        background-color: white;
    }

    :root {
        --accent: lightseagreen;
        --border-width:  0 ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c&#43;&#43;.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.32-DEV" />
        
    </head>

    <body>

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Libevent Note</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/posts/">Posts</a></li>
                            
                                <li><a href="/categories/">Categories</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="https://github.com/wbprime/"><i class="fa fa-github"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
      

    <h4><a href="/posts/2018-02-05-libevent-notes/">Libevent Note</a></h4>
    <h5>Note on libevent</h5>
     <kbd class="item-tag">libevent</kbd> 

</div>


    <br> <div class="text-justify">

<h1 id="event-context">Event Context</h1>

<h2 id="structure">Structure</h2>

<p><code>event_base</code></p>

<h2 id="setup-a-default-context">Setup a Default Context</h2>

<pre><code>#include &lt;event2/event.h&gt;
struct event_base *event_base_new(void);
</code></pre>

<h2 id="setup-a-custom-context">Setup a Custom Context</h2>

<p>可以用 <code>event_config</code> 来自定义上下文。</p>

<pre><code>struct event_config *event_config_new(void);
struct event_base *event_base_new_with_config(const struct event_config *cfg);
void event_config_free(struct event_config *cfg);
</code></pre>

<p><code>event_config</code> 的自定义方法：</p>

<pre><code>#include &lt;event2/event.h&gt;
int event_config_avoid_method(struct event_config *cfg, const char *method);

enum event_method_feature {
    EV_FEATURE_ET = 0x01,
    EV_FEATURE_O1 = 0x02,
    EV_FEATURE_FDS = 0x04,
};
int event_config_require_features(struct event_config *cfg,
                                  enum event_method_feature feature);

enum event_base_config_flag {
    EVENT_BASE_FLAG_NOLOCK = 0x01,
    EVENT_BASE_FLAG_IGNORE_ENV = 0x02,
    EVENT_BASE_FLAG_STARTUP_IOCP = 0x04,
    EVENT_BASE_FLAG_NO_CACHE_TIME = 0x08,
    EVENT_BASE_FLAG_EPOLL_USE_CHANGELIST = 0x10,
    EVENT_BASE_FLAG_PRECISE_TIMER = 0x20
};
int event_config_set_flag(struct event_config *cfg,
    enum event_base_config_flag flag);
</code></pre>

<p><code>event_config_avoid_method()</code> 指定不使用的后端名</p>

<pre><code>`const char **event_get_supported_methods(void);` 可以用于获取可用的后端名列表
</code></pre>

<h2 id="deallocate-a-context">Deallocate a Context</h2>

<pre><code>#include &lt;event2/event.h&gt;
void event_base_free(struct event_base *base);
</code></pre>

<h2 id="reinit-a-context">Reinit a Context</h2>

<pre><code>#include &lt;event2/event.h&gt;
int event_reinit(struct event_base *base);
</code></pre>

<p>一般在<code>fork</code>之后需要调用待方法。</p>

<h1 id="iterate-all-active-pending-events">Iterate All Active/Pending Events</h1>

<pre><code>typedef int (*event_base_foreach_event_cb)(
    const struct event_base *,
    const struct event *, void *);
    
int event_base_foreach_event(
    struct event_base *base,
    event_base_foreach_event_cb fn,
    void *arg);
</code></pre>

<p><code>event_base_foreach_event()</code> 会以随机的顺序遍历当前所有可用的event，每一个event执行一次参数fn的函数，参数arg会被传入参数fn中作为第三个参数。</p>

<p>参数fn的返回值如果不是0,则退出迭代过程。</p>

<p><code>event_base_foreach_event()</code>的返回值是参数fn的最后一次返回值。</p>

<h1 id="event-loop">Event Loop</h1>

<h2 id="run-event-loop">Run Event Loop</h2>

<pre><code class="language-c">#define EVLOOP_ONCE             0x01
#define EVLOOP_NONBLOCK         0x02
#define EVLOOP_NO_EXIT_ON_EMPTY 0x04

int event_base_loop(struct event_base *base, int flags);
</code></pre>

<p>flags:</p>

<ul>
<li><code>EVLOOP_ONCE</code> the loop wait active events</li>
<li><code>EVLOOP_NONBLOCK</code> the loop checks available active events</li>
<li><code>EVLOOP_NO_EXIT_ON_EMPTY</code> the loop will not exit even when no active events</li>
</ul>

<p>As a convinience, <code>libevent</code> provides another method.</p>

<pre><code class="language-c">int event_base_dispatch(struct event_base *base);
</code></pre>

<p>Thus the loop keeps running until there are no more registered events or until
event_base_loopbreak() or event_base_loopexit() is called.</p>

<h2 id="stop-event-loop">Stop Event Loop</h2>

<ul>
<li><p><code>int event_base_loopexit(struct event_base *base, const struct timeval *tv);</code></p>

<p>设定base在指定时间间隔后退出循环；如果参数tv为null，则立即退出；如果要退出时
，还有callback没有运行，则运行完了再退出</p></li>

<li><p><code>int event_base_loopbreak(struct event_base *base);</code></p>

<p>设定base马上退出循环</p></li>
</ul>

<p><code>event_base_loopbreak()</code> VS <code>event_base_loopexit(base, NULL)</code></p>

<p>二者的区别在于前者等待正在运行的callback执行结束立即退出；后者等所有的就绪的
callback执行结束才退出。另外，如果当前没有循环，loopexit会是的下一次运行的loop退
出；而loopbreak不会影响到后续的loop。</p>

<h2 id="get-the-exit-reason">Get the Exit Reason</h2>

<pre><code>int event_base_got_exit(struct event_base *base);
int event_base_got_break(struct event_base *base);
</code></pre>

<p>判断event循环退出的原因（方式），分别对应与loopexit和loopbreak，如果是则返回非0值。</p>

<h2 id="skip-to-next-loop">Skip to Next Loop</h2>

<p><code>int event_base_loopcontinue(struct event_base *);</code></p>

<p>退出本次循环，进行下一次循环</p>

<h1 id="events">Events</h1>

<h2 id="overview">Overview</h2>

<p><code>event</code> 封装了以下信息：</p>

<ul>
<li>读写就绪的文件描述符（fd）</li>
<li>定时器超时</li>
<li>发生了信号的信息</li>
<li>用户自定义的事件</li>
</ul>

<h2 id="lifecycle-of-event">Lifecycle of Event</h2>

<ul>
<li>initialized
event新建并添加到上下文（event_base）之后</li>
<li>pending
pending可以通过deleting来变成non-pending；反之可以通过adding将non-pending变为pending
event变为active状态之后，会在将要调用callbakc之前变为non-pending的状态</li>
<li>active
不同类型的event被触发（文件描述符可读可写，定时器超时），关联的callback回调会被执行</li>
<li>persistent
event可以设置为persistent：event可以在执行了callback之后还保持pending状态
<br /></li>
</ul>

<h2 id="event-的创建与销毁">Event 的创建与销毁</h2>

<h3 id="通用方法">通用方法</h3>

<pre><code>#include &lt;event2/event.h&gt;
#define EV_TIMEOUT      0x01
#define EV_READ         0x02
#define EV_WRITE        0x04
#define EV_SIGNAL       0x08
#define EV_PERSIST      0x10
#define EV_ET           0x20

typedef void (*event_callback_fn)(evutil_socket_t, short, void *);

struct event *event_new(struct event_base *base, evutil_socket_t fd,
    short what, event_callback_fn cb,
    void *arg);
int event_base_once(struct event_base *, evutil_socket_t, short,
  void (*)(evutil_socket_t, short, void *), void *, const struct timeval *);

void event_free(struct event *event);
</code></pre>

<p><code>event_new</code>
中的参数cb是目标callback，在对应的event被触发使会被调用，参数fd，被触发的事件类型和arg会被作为参数传入。</p>

<p>调用 <code>event_new()</code> 之后的event是initialized和non-pending的。</p>

<p>如果想将要创建的event作为第三个参数传入callback中，可以使用 <code>void *event_self_cbarg();</code> 的trick：<code>event_new(base, -1, EV_PERSIST, cb_func, event_self_cbarg());</code>。</p>

<h3 id="定时事件">定时事件</h3>

<p>libevent提供了一系列的辅助函数简化定时事件的创建。</p>

<pre><code>#define evtimer_new(base, callback, arg) \
    event_new((base), -1, 0, (callback), (arg))
#define evtimer_add(ev, tv) \
    event_add((ev),(tv))
#define evtimer_del(ev) \
    event_del(ev)
#define evtimer_pending(ev, tv_out) \
    event_pending((ev), EV_TIMEOUT, (tv_out))
</code></pre>

<h3 id="信号处理事件">信号处理事件</h3>

<p>libevent提供了一系列的辅助函数简化信号事件的创建。</p>

<pre><code class="language-c">#define evsignal_new(base, signum, cb, arg) \
    event_new(base, signum, EV_SIGNAL|EV_PERSIST, cb, arg)
#define evsignal_add(ev, tv) \
    event_add((ev),(tv))
#define evsignal_del(ev) \
    event_del(ev)
#define evsignal_pending(ev, what, tv_out) \
    event_pending((ev), (what), (tv_out))
</code></pre>

<p>举例：</p>

<pre><code class="language-c">evsignal_new(base, SIGHUP, sighup_function, NULL);
</code></pre>

<h2 id="pending-non-pending">Pending &amp; Non-Pending</h2>

<p>pending -&gt; non-pending</p>

<p><code>int event_add(struct event *ev, const struct timeval *tv);</code></p>

<p>如果当前event已经是pending了，会尝试修改过期时间。</p>

<p>non-pending -&gt; pending</p>

<p><code>int event_del(struct event *ev);</code></p>

<p>如果只想修改event的过期时间而不改变pending状态，使用<code>int event_remove_timer(struct event *ev);</code></p>

<h2 id="priority">Priority</h2>

<p><code>int event_priority_set(struct event *event, int priority);</code></p>

<h2 id="get-event-info">Get Event Info</h2>

<pre><code class="language-c">int event_pending(const struct event *ev, short what, struct timeval *tv_out);

#define event_get_signal(ev) /* ... */
evutil_socket_t event_get_fd(const struct event *ev);
struct event_base *event_get_base(const struct event *ev);
short event_get_events(const struct event *ev);
event_callback_fn event_get_callback(const struct event *ev);
void *event_get_callback_arg(const struct event *ev);
int event_get_priority(const struct event *ev);

void event_get_assignment(const struct event *event,
        struct event_base **base_out,
        evutil_socket_t *fd_out,
        short *events_out,
        event_callback_fn *callback_out,
        void **arg_out);
</code></pre>

<h2 id="manually-trigger-a-event">Manually Trigger a Event</h2>

<p><code>void event_active(struct event *ev, int what, short ncalls);</code></p>
</div>

    
    

    

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a></p>

        </footer>

    </body>

</html>

