<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>wangboâ€™s blog - Intro to Spring Cloud Gateway</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">WB Prime</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;github.wangbo.im">
                            Github
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;www.wangbo.im">WB Prime</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;github.wangbo.im">
                                    Github
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;intro-to-spring-cloud-gateway-slide&#x2F;">Intro to Spring Cloud Gateway</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-08-28</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>æœ¬æ–‡åŸºäºåœ¨éƒ¨é—¨å†…çš„ä¸€æ¬¡åˆ†äº«ä¿®æ”¹è€Œæˆï¼Œä¸»è¦ä»‹ç» <a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Gateway</a> çš„è¯·æ±‚å¤„ç†æµç¨‹å’Œè£…é…æµç¨‹ã€‚</p>
<p>æ¼”ç¤ºæ–‡æ¡£æ˜¯ä» markdown æ ¼å¼æ–‡æœ¬é€šè¿‡æ ¼å¼è½¬æ¢å·¥å…· <a href="https://pandoc.org/">Pandoc</a> å¼•ç”¨
<a href="https://revealjs.com">Reveal.js</a> è½¬æ¢å¾—åˆ°ï¼Œå¯ä¾›ä¸‹è½½ã€‚</p>
<table><thead><tr><th>Downloads</th></tr></thead><tbody>
<tr><td><a href="https://www.wangbo.im/posts/intro-to-spring-cloud-gateway-slide/slide.md">Markdown</a></td></tr>
<tr><td><a href="https://www.wangbo.im/posts/intro-to-spring-cloud-gateway-slide/slide.html">Slide</a></td></tr>
</tbody></table>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<h1 id="intro"><a class="zola-anchor" href="#intro" aria-label="Anchor link for: intro">ğŸ”—</a>Intro</h1>
<h2 id="spring-cloud-gateway"><a class="zola-anchor" href="#spring-cloud-gateway" aria-label="Anchor link for: spring-cloud-gateway">ğŸ”—</a>Spring Cloud Gateway</h2>
<blockquote>
<p><strong>Spring Cloud Gateway</strong> aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.</p>
</blockquote>
<p>ç®€è€Œè¨€ä¹‹ï¼Œ<a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Cloud Gateway</a> æ˜¯ä¸€ä¸ªåŸºäº Java çš„ Api ç½‘å…³ç³»ç»Ÿï¼Œå¼€ç®±å³ç”¨ï¼›å¦‚æœéœ€è¦è‡ªå®šä¹‰ä¹Ÿæ˜¯å¯ä»¥å¿«é€Ÿæå®šã€‚</p>
<p>æ–‡æ¡£åœ°å€ï¼š<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.0.RELEASE/">Documentation 2.1.0 Current GA</a></p>
<h2 id="pom"><a class="zola-anchor" href="#pom" aria-label="Anchor link for: pom">ğŸ”—</a>pom</h2>
<pre style="background-color:#282828;">
<span style="color:#83a598;">&lt;</span><span style="font-weight:bold;color:#8ec07c;">dependencies</span><span style="color:#83a598;">&gt;
    &lt;</span><span style="font-weight:bold;color:#8ec07c;">dependency</span><span style="color:#83a598;">&gt;
      &lt;</span><span style="font-weight:bold;color:#8ec07c;">groupId</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">org.springframework.cloud</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">groupId</span><span style="color:#83a598;">&gt;
      &lt;</span><span style="font-weight:bold;color:#8ec07c;">artifactId</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">spring-cloud-starter-gateway</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">artifactId</span><span style="color:#83a598;">&gt;
    &lt;/</span><span style="font-weight:bold;color:#8ec07c;">dependency</span><span style="color:#83a598;">&gt;
&lt;/</span><span style="font-weight:bold;color:#8ec07c;">dependencies</span><span style="color:#83a598;">&gt;
&lt;</span><span style="font-weight:bold;color:#8ec07c;">dependencyManagement</span><span style="color:#83a598;">&gt;
    &lt;</span><span style="font-weight:bold;color:#8ec07c;">dependencies</span><span style="color:#83a598;">&gt;
      &lt;</span><span style="font-weight:bold;color:#8ec07c;">dependency</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">groupId</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">org.springframework.boot</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">groupId</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">artifactId</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">spring-boot-dependencies</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">artifactId</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">version</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">${spring-boot.version}</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">version</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">type</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">pom</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">type</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">scope</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">import</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">scope</span><span style="color:#83a598;">&gt;
      &lt;/</span><span style="font-weight:bold;color:#8ec07c;">dependency</span><span style="color:#83a598;">&gt;
      &lt;</span><span style="font-weight:bold;color:#8ec07c;">dependency</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">groupId</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">org.springframework.cloud</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">groupId</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">artifactId</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">spring-cloud-dependencies</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">artifactId</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">version</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">${spring-cloud.version}</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">version</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">type</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">pom</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">type</span><span style="color:#83a598;">&gt;
        &lt;</span><span style="font-weight:bold;color:#8ec07c;">scope</span><span style="color:#83a598;">&gt;</span><span style="color:#fdf4c1aa;">import</span><span style="color:#83a598;">&lt;/</span><span style="font-weight:bold;color:#8ec07c;">scope</span><span style="color:#83a598;">&gt;
      &lt;/</span><span style="font-weight:bold;color:#8ec07c;">dependency</span><span style="color:#83a598;">&gt;
    &lt;/</span><span style="font-weight:bold;color:#8ec07c;">dependencies</span><span style="color:#83a598;">&gt;
&lt;/</span><span style="font-weight:bold;color:#8ec07c;">dependencyManagement</span><span style="color:#83a598;">&gt;
</span></pre><h2 id="spring-reactor"><a class="zola-anchor" href="#spring-reactor" aria-label="Anchor link for: spring-reactor">ğŸ”—</a>Spring Reactor</h2>
<p><a href="https://projectreactor.io/">Project Reactor</a> æ˜¯ <a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> çš„åº•å±‚æŠ€æœ¯ã€‚å…¶å·ç§°æ˜¯ä¸€ä¸ª
å¼‚æ­¥ååº”å¼çš„ç¼–ç¨‹æ¨¡å¼ï¼Œç«äº‰è€…æ˜¯å¤§åé¼é¼çš„ <a href="https://github.com/ReactiveX/RxJava">RxJava</a>ã€‚</p>
<blockquote>
<p>Reactor is a fourth-generation Reactive library for building non-blocking applications on the JVM based on the Reactive Streams Specification.</p>
</blockquote>
<ul>
<li><code>Mono&lt;T&gt;</code> ç±»ä¼¼äº <code>CompletableFuture&lt;T&gt;</code>ï¼Œæ”¯æŒå¼‚æ­¥ 0/1 ä¸ªç»“æœæˆ–å¼‚å¸¸çš„è¯­ä¹‰</li>
<li><code>Flux&lt;T&gt;</code> ç±»ä¼¼äº <code>Stream&lt;T&gt;</code>ï¼Œæ”¯æŒå¼‚æ­¥ N ä¸ªç»“æœæˆ–å¼‚å¸¸çš„è¯­ä¹‰</li>
</ul>
<h3 id="mono"><a class="zola-anchor" href="#mono" aria-label="Anchor link for: mono">ğŸ”—</a>Mono</h3>
<p><em>First</em> æ„å»º</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; mono </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">fromRunnable(() </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> dao.update(user))</span><span style="color:#fdf4c1aa;">;
</span></pre>
<p>or</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">User</span><span style="color:#fdf4c1aa;">&gt; mono </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">fromCallable(() </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> dao.findById(</span><span style="color:#d3869b;">1000</span><span style="color:#fa5c4b;">L</span><span style="color:#fdf4c1;">)</span><span style="background-color:#932b1e;color:#fdf4c1;">;</span><span style="color:#fdf4c1aa;">
</span></pre>
<p><em>Then</em> æ‹¼æ¥ä¸è½¬æ¢</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">mono.</span><span style="color:#fdf4c1;">map(user </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> user.getId())</span><span style="color:#fdf4c1aa;">;
</span></pre>
<p>or</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">mono.</span><span style="color:#fdf4c1;">flatMap(user </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> userDao.deleteById(user.getId())</span><span style="background-color:#932b1e;color:#fdf4c1;">;</span><span style="color:#fdf4c1aa;">
</span></pre>
<p><em>Finally</em> å¼‚æ­¥å¤„ç†ç»“æœ</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">mono.</span><span style="color:#fdf4c1;">subscribe(
	value </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#8ec07c;">System</span><span style="color:#fdf4c1;">.out.println(value),
	ex </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> ex.printStackTrace(),
	() </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#8ec07c;">System</span><span style="color:#fdf4c1;">.out.println(</span><span style="color:#b8bb26;">&quot;No data&quot;</span><span style="color:#fdf4c1;">)
)</span><span style="color:#fdf4c1aa;">;
</span></pre><h3 id="flux"><a class="zola-anchor" href="#flux" aria-label="Anchor link for: flux">ğŸ”—</a>Flux</h3>
<p><em>First</em> æ„å»º</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">User</span><span style="color:#fdf4c1aa;">&gt; flux </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">create(sink </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">{
	</span><span style="color:#fa5c4b;">final </span><span style="color:#8ec07c;">User</span><span style="color:#fa5c4b;">[]</span><span style="color:#fdf4c1;"> users </span><span style="color:#fe8019;">=</span><span style="color:#fdf4c1;"> userDao.findByName(name);
	</span><span style="color:#fa5c4b;">if </span><span style="color:#fdf4c1;">(users </span><span style="color:#fe8019;">!= </span><span style="color:#d3869b;">null</span><span style="color:#fdf4c1;">) {
		</span><span style="color:#fa5c4b;">for </span><span style="color:#fdf4c1;">(</span><span style="color:#8ec07c;">User</span><span style="color:#fdf4c1;"> user </span><span style="color:#fe8019;">:</span><span style="color:#fdf4c1;"> users) {
			sink.next(user);
		}
		sink.complete();
	} </span><span style="color:#fa5c4b;">else </span><span style="color:#fdf4c1;">{
		sink.error(
            </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">IllegalStateException</span><span style="color:#fdf4c1;">(
                </span><span style="color:#b8bb26;">&quot;Invalid name: &quot; </span><span style="color:#fe8019;">+</span><span style="color:#fdf4c1;"> name));
	}
})</span><span style="color:#fdf4c1aa;">;
</span></pre>
<p>or</p>
<pre style="background-color:#282828;">
<span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">String</span><span style="color:#fdf4c1aa;">&gt; flux </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">just(</span><span style="color:#b8bb26;">&quot;123&quot;</span><span style="color:#fdf4c1;">, </span><span style="color:#b8bb26;">&quot;456&quot;</span><span style="color:#fdf4c1;">, </span><span style="color:#b8bb26;">&quot;789&quot;</span><span style="color:#fdf4c1;">)</span><span style="color:#fdf4c1aa;">;
</span></pre>
<p><em>Then</em> æ‹¼æ¥ä¸è½¬æ¢</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">flux.</span><span style="color:#fdf4c1;">map(str </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#8ec07c;">Longs</span><span style="color:#fdf4c1;">.tryParse(str))</span><span style="color:#fdf4c1aa;">;
</span></pre>
<p>or</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">flux.</span><span style="color:#fdf4c1;">flatMap(user </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> userDao.deleteById(user.getId()))</span><span style="color:#fdf4c1aa;">;
</span></pre>
<p><em>Finally</em> å¼‚æ­¥å¤„ç†ç»“æœ</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">mono.</span><span style="color:#fdf4c1;">subscribe(
	value </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#8ec07c;">System</span><span style="color:#fdf4c1;">.out.println(value),
	ex </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> ex.printStackTrace(),
	() </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#8ec07c;">System</span><span style="color:#fdf4c1;">.out.println(</span><span style="color:#b8bb26;">&quot;No data&quot;</span><span style="color:#fdf4c1;">)
)</span><span style="color:#fdf4c1aa;">;
</span></pre><h2 id="webflux"><a class="zola-anchor" href="#webflux" aria-label="Anchor link for: webflux">ğŸ”—</a>WebFlux</h2>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">Spring WebFlux - Web on Reactive Stack</a> æ˜¯ <a href="https://spring.io/">Spring</a> æ¨å‡ºçš„åŸºäº <a href="https://projectreactor.io/">Project Reactor</a> çš„ HTTP ç½‘ç»œå¼€å‘æ¡†æ¶ï¼Œç›¸ä¼¼è€…æ˜¯ <a href="https://vertx.io/docs/vertx-web/java/">Vert.x-Web</a>ã€‚</p>
<blockquote>
<p>fully non-blocking, supports Reactive Streams back pressure, and runs on such servers as Netty, Undertow, and Servlet 3.1+ containers.</p>
<ul>
<li>the Spring WebFlux framework</li>
<li>the reactive WebClient</li>
<li>support for testing</li>
<li>and reactive libraries.</li>
</ul>
</blockquote>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">WebFlux</a> è¢«è®¾è®¡æ¥å–ä»£æˆ–è€…è¯´è¡¥å……åŸæœ‰çš„åŸºäº Servlet çš„ç½‘ç»œæ¡†æ¶ï¼š<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#spring-web">Spring Web MVC - Web on Servlet Stack</a>ã€‚</p>
<p><img src="https://www.wangbo.im/posts/intro-to-spring-cloud-gateway-slide/spring-mvc-context-hierarchy.png" alt="spring-mvc-dispatcherservlet" /></p>
<p>äºŒè€…çš„å…³ç³»ï¼š</p>
<p><img src="https://www.wangbo.im/posts/intro-to-spring-cloud-gateway-slide/spring-mvc-vs-webflux.png" alt="spring-webflux-vs-webmvc" /></p>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">WebFlux</a> çš„å…¸å‹ä»£ç ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">RequestMapping</span><span style="color:#fdf4c1aa;">(</span><span style="color:#b8bb26;">&quot;/root&quot;</span><span style="color:#fdf4c1aa;">)
@</span><span style="color:#fdf4c1;">RestController
</span><span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">WebFluxTestController </span><span style="color:#fdf4c1aa;">{
    @</span><span style="color:#fdf4c1;">GetMapping</span><span style="color:#fdf4c1aa;">(</span><span style="color:#b8bb26;">&quot;/user/{id}&quot;</span><span style="color:#fdf4c1aa;">)
    </span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">UserDto</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#8ec07c;">getUser</span><span style="color:#fdf4c1aa;">(</span><span style="color:#fa5c4b;">final </span><span style="color:#8ec07c;">String </span><span style="color:#fdf4c1;">id</span><span style="color:#fdf4c1aa;">) {
        </span><span style="color:#fa5c4b;">return </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">just(</span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">Foobar</span><span style="color:#fdf4c1;">())</span><span style="color:#fdf4c1aa;">;
    }
}
</span></pre><h1 id="gateway"><a class="zola-anchor" href="#gateway" aria-label="Anchor link for: gateway">ğŸ”—</a>Gateway</h1>
<h2 id="workflow"><a class="zola-anchor" href="#workflow" aria-label="Anchor link for: workflow">ğŸ”—</a>Workflow</h2>
<p>å®˜æ–¹çš„è¯·æ±‚å¤„ç†æµç¨‹å›¾ï¼š</p>
<p><img src="https://www.wangbo.im/posts/intro-to-spring-cloud-gateway-slide/spring_cloud_gateway_diagram.png" alt="spring-gateway-architecture" /></p>
<p>ä¸‹é¢æ¥ä»å¯¹è±¡è£…é…(Assembly) å’Œè¯·æ±‚åŒ¹é…(Runtime) çš„è§’åº¦æ¥æ·±å…¥ä¸€ä¸‹ <a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> çš„å†…éƒ¨ä»£ç ã€‚</p>
<h2 id="assembly-httphandlerautoconfiguration"><a class="zola-anchor" href="#assembly-httphandlerautoconfiguration" aria-label="Anchor link for: assembly-httphandlerautoconfiguration">ğŸ”—</a>Assembly - HttpHandlerAutoConfiguration</h2>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">WebFlux</a> åŸºäº Spring çš„ä¼ ç»Ÿå¯¹åº•å±‚çš„ç½‘ç»œå±‚è¿›è¡Œäº†æŠ½è±¡ï¼Œå¯ä»¥æ”¯æŒ Servlet çš„å®ç°å’Œä¸€ä¸ªå†…å»ºçš„
åŸºäº <a href="https://netty.io/">Netty</a> çš„å®ç°ã€‚<a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> é»˜è®¤ä½¿ç”¨åŸºäº Netty çš„å®ç°ã€‚</p>
<p>é¦–å…ˆå®šä½åˆ°ç½‘ç»œæœåŠ¡å™¨ <code>WebServer</code> æ¥å£çš„ Netty å®ç°ç±»ã€‚</p>
<ul>
<li><code>org.springframework.boot.web.embedded.netty.NettyReactiveWebServerFactory#getWebServer</code></li>
<li><code>org.springframework.boot.web.embedded.netty.NettyWebServer#start</code></li>
<li><code>org.springframework.http.server.reactive.ReactorHttpHandlerAdapter#apply</code></li>
<li><code>org.springframework.http.server.reactive.HttpHandler#handle</code></li>
</ul>
<p>å‘ç°è¯·æ±‚çš„å¤„ç†ç±»æ˜¯ <code>HttpHandler</code> ç±»ã€‚</p>
<h2 id="assembly-httphandlerautoconfiguration-1"><a class="zola-anchor" href="#assembly-httphandlerautoconfiguration-1" aria-label="Anchor link for: assembly-httphandlerautoconfiguration-1">ğŸ”—</a>Assembly - HttpHandlerAutoConfiguration</h2>
<p>ç„¶åæ ¹æ® Spring boot å¯åŠ¨é€»è¾‘æ‰¾åˆ° <code>HttpHandler</code> çš„å®ç°ç±»ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Configuration
</span><span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">ConditionalOnClass</span><span style="color:#fdf4c1aa;">({ </span><span style="color:#8ec07c;">DispatcherHandler</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">HttpHandler</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class </span><span style="color:#fdf4c1aa;">})
@</span><span style="color:#fdf4c1;">ConditionalOnWebApplication</span><span style="color:#fdf4c1aa;">(</span><span style="color:#fdf4c1;">type </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">ConditionalOnWebApplication</span><span style="color:#fdf4c1aa;">.</span><span style="color:#8ec07c;">Type</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">REACTIVE</span><span style="color:#fdf4c1aa;">)
@</span><span style="color:#fdf4c1;">ConditionalOnMissingBean</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">HttpHandler</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class</span><span style="color:#fdf4c1aa;">)
@</span><span style="color:#fdf4c1;">AutoConfigureAfter</span><span style="color:#fdf4c1aa;">({ </span><span style="color:#8ec07c;">WebFluxAutoConfiguration</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class </span><span style="color:#fdf4c1aa;">})
@</span><span style="color:#fdf4c1;">AutoConfigureOrder</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">Ordered</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">HIGHEST_PRECEDENCE </span><span style="color:#fe8019;">+ </span><span style="color:#d3869b;">10</span><span style="color:#fdf4c1aa;">)
</span><span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">HttpHandlerAutoConfiguration </span><span style="color:#fdf4c1aa;">{
	@</span><span style="color:#fdf4c1;">Configuration
	</span><span style="color:#fa5c4b;">public static class </span><span style="color:#8ec07c;">AnnotationConfig </span><span style="color:#fdf4c1aa;">{
		</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">ApplicationContext </span><span style="color:#fdf4c1aa;">applicationContext;

		</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">AnnotationConfig</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">ApplicationContext </span><span style="color:#fdf4c1;">applicationContext</span><span style="color:#fdf4c1aa;">) {
			</span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.applicationContext </span><span style="color:#fe8019;">=</span><span style="color:#fdf4c1aa;"> applicationContext;
		}

		@</span><span style="color:#fdf4c1;">Bean
		</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">HttpHandler httpHandler</span><span style="color:#fdf4c1aa;">() {
			</span><span style="color:#fa5c4b;">return </span><span style="color:#8ec07c;">WebHttpHandlerBuilder</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">applicationContext(this.applicationContext)</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">build()</span><span style="color:#fdf4c1aa;">;
		}
	}
}
</span></pre>
<p>å®šä½åˆ° <code>WebHttpHandlerBuilder</code> ç±»ï¼Œä¸‹ä¸€æ­¥éœ€è¦å»çœ‹çœ‹å…¶ <code>build()</code> æ–¹æ³•é‡Œé¢çš„ä»£ç ã€‚</p>
<h2 id="assembly-webhttphandlerbuilder"><a class="zola-anchor" href="#assembly-webhttphandlerbuilder" aria-label="Anchor link for: assembly-webhttphandlerbuilder">ğŸ”—</a>Assembly - WebHttpHandlerBuilder</h2>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public static final </span><span style="color:#8ec07c;">String </span><span style="color:#fdf4c1;">WEB_HANDLER_BEAN_NAME </span><span style="color:#fe8019;">= </span><span style="color:#b8bb26;">&quot;webHandler&quot;</span><span style="color:#fdf4c1aa;">;

</span><span style="color:#fa5c4b;">private </span><span style="color:#fdf4c1;">WebHttpHandlerBuilder(</span><span style="color:#8ec07c;">WebHandler</span><span style="color:#fdf4c1;"> webHandler, @</span><span style="color:#8ec07c;">Nullable ApplicationContext</span><span style="color:#fdf4c1;"> applicationContext) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.webHandler </span><span style="color:#fe8019;">=</span><span style="color:#fdf4c1aa;"> webHandler; </span><span style="font-style:italic;color:#928374;">// HERE
	</span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.applicationContext </span><span style="color:#fe8019;">=</span><span style="color:#fdf4c1aa;"> applicationContext;
}

</span><span style="color:#fa5c4b;">public static </span><span style="color:#8ec07c;">WebHttpHandlerBuilder </span><span style="color:#fdf4c1;">applicationContext(</span><span style="color:#8ec07c;">ApplicationContext</span><span style="color:#fdf4c1;"> context) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#8ec07c;">WebHttpHandlerBuilder</span><span style="color:#fdf4c1aa;"> builder </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">WebHttpHandlerBuilder</span><span style="color:#fdf4c1aa;">(
			context.</span><span style="color:#fdf4c1;">getBean(WEB_HANDLER_BEAN_NAME, </span><span style="color:#8ec07c;">WebHandler</span><span style="color:#fdf4c1;">.class)</span><span style="color:#fdf4c1aa;">, context); </span><span style="font-style:italic;color:#928374;">// HERE

	// ...

	</span><span style="color:#fa5c4b;">return</span><span style="color:#fdf4c1aa;"> builder;
}

</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">HttpHandler </span><span style="color:#fdf4c1;">build() </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#8ec07c;">WebHandler</span><span style="color:#fdf4c1aa;"> decorated </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">FilteringWebHandler</span><span style="color:#fdf4c1aa;">(</span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.webHandler, </span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.filters); </span><span style="font-style:italic;color:#928374;">// HERE
</span><span style="color:#fdf4c1aa;">	decorated </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">ExceptionHandlingWebHandler</span><span style="color:#fdf4c1aa;">(decorated,  </span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.exceptionHandlers); </span><span style="font-style:italic;color:#928374;">// HERE

	</span><span style="color:#8ec07c;">HttpWebHandlerAdapter</span><span style="color:#fdf4c1aa;"> adapted </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">HttpWebHandlerAdapter</span><span style="color:#fdf4c1aa;">(decorated); </span><span style="font-style:italic;color:#928374;">//HERE

	// ...

	</span><span style="color:#fa5c4b;">return</span><span style="color:#fdf4c1aa;"> adapted;
}
</span></pre>
<p>æ‰¾åˆ°äº†æ¯”è¾ƒå…³é”®çš„ <code>HttpWebHandlerAdapter</code> ç±»å’Œ <code>FilteringWebHandler</code> ç±»ã€‚</p>
<h2 id="assembly-httpwebhandleradapter"><a class="zola-anchor" href="#assembly-httpwebhandleradapter" aria-label="Anchor link for: assembly-httpwebhandleradapter">ğŸ”—</a>Assembly - HttpWebHandlerAdapter</h2>
<p>å‘ç° <code>HttpWebHandlerAdapter</code> ç±»çš„é€»è¾‘å°±æ˜¯æŠŠè¯·æ±‚è½¬ç»™äº† <code>FilteringWebHandler</code> ç±»ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">handle(</span><span style="color:#8ec07c;">ServerHttpRequest</span><span style="color:#fdf4c1;"> request, </span><span style="color:#8ec07c;">ServerHttpResponse</span><span style="color:#fdf4c1;"> response) </span><span style="color:#fdf4c1aa;">{
	</span><span style="font-style:italic;color:#928374;">// ...

	</span><span style="color:#fa5c4b;">return </span><span style="color:#fdf4c1;">getDelegate()</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">handle(exchange) </span><span style="font-style:italic;color:#928374;">// HERE
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">doOnSuccess(aVoid </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">logResponse(exchange))
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">onErrorResume(ex </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">handleUnresolvedError(exchange, ex))
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">then(</span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1;">.defer(response::setComplete))</span><span style="color:#fdf4c1aa;">;
}
</span></pre><h2 id="assembly-exceptionhandlingwebhandler"><a class="zola-anchor" href="#assembly-exceptionhandlingwebhandler" aria-label="Anchor link for: assembly-exceptionhandlingwebhandler">ğŸ”—</a>Assembly - ExceptionHandlingWebHandler</h2>
<p>è¿™æ˜¯ <code>WebHttpHandlerBuilder#build()</code> é‡Œé¢å‘ç°çš„ <code>ExceptionHandlingWebHandler</code> ç±»ï¼Œå¯ä»¥ä¸ç”¨é‡ç‚¹å…³æ³¨ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Override
</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">handle(</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1;"> exchange) </span><span style="color:#fdf4c1aa;">{

	</span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; completion;
	</span><span style="color:#fa5c4b;">try </span><span style="color:#fdf4c1aa;">{
		completion </span><span style="color:#fe8019;">= </span><span style="color:#fdf4c1;">super</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">handle(exchange)</span><span style="color:#fdf4c1aa;">; </span><span style="font-style:italic;color:#928374;">// HERE
	</span><span style="color:#fdf4c1aa;">} </span><span style="color:#fa5c4b;">catch </span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">Throwable </span><span style="color:#fdf4c1;">ex</span><span style="color:#fdf4c1aa;">) {
		completion </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">error(ex)</span><span style="color:#fdf4c1aa;">;
	}

	</span><span style="color:#fa5c4b;">return</span><span style="color:#fdf4c1aa;"> completion;
}
</span></pre><h2 id="assembly-filteringwebhandler"><a class="zola-anchor" href="#assembly-filteringwebhandler" aria-label="Anchor link for: assembly-filteringwebhandler">ğŸ”—</a>Assembly - FilteringWebHandler</h2>
<p>é‡ç‚¹çœ‹ä¸€ä¸‹ <code>FilteringWebHandler</code> ç±»çš„å®ç°ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.chain </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">DefaultWebFilterChain</span><span style="color:#fdf4c1aa;">(handler, filters); </span><span style="font-style:italic;color:#928374;">// HERE

</span><span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Override
</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">handle(</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1;"> exchange) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">return </span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.chain.</span><span style="color:#fdf4c1;">filter(exchange)</span><span style="color:#fdf4c1aa;">;
}
</span></pre>
<p>é‡Œé¢æŠŠè¯·æ±‚è½¬ç»™äº† <code>DefaultWebFilterChain</code> ç±»ï¼Œè¿™ä¸ªç±»ä¸€å¬å°±æ˜¯ä¸€ä¸ªç±»ä¼¼è´£ä»»é“¾çš„è®¾è®¡ã€‚</p>
<h2 id="assembly-defaultwebfilterchain"><a class="zola-anchor" href="#assembly-defaultwebfilterchain" aria-label="Anchor link for: assembly-defaultwebfilterchain">ğŸ”—</a>Assembly - DefaultWebFilterChain</h2>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Override
</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">filter(</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1;"> exchange) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">return </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">defer(() </span><span style="color:#fa5c4b;">-&gt;
		</span><span style="color:#fdf4c1;">this.currentFilter </span><span style="color:#fe8019;">!= </span><span style="color:#d3869b;">null </span><span style="color:#fe8019;">&amp;&amp; </span><span style="color:#fdf4c1;">this.next </span><span style="color:#fe8019;">!= </span><span style="color:#d3869b;">null </span><span style="color:#fe8019;">?
				</span><span style="color:#fdf4c1;">this.currentFilter.filter(exchange, this.next) </span><span style="color:#fe8019;">:
				</span><span style="color:#fdf4c1;">this.handler.handle(exchange))</span><span style="color:#fdf4c1aa;">;
}
</span></pre>
<p>è¿™é‡Œé¢åˆåšäº†ä¸€å±‚å°è£…ï¼Œä¼šè°ƒç”¨åˆ° <code>DispatcherHandler</code> ç±»çš„å®ç°é€»è¾‘ã€‚</p>
<h2 id="assembly-webfluxconfigurationsupport"><a class="zola-anchor" href="#assembly-webfluxconfigurationsupport" aria-label="Anchor link for: assembly-webfluxconfigurationsupport">ğŸ”—</a>Assembly - WebFluxConfigurationSupport</h2>
<p><code>DispatcherHandler</code> ç±»åœ¨ <code>org.springframework.web.reactive.config.WebFluxConfigurationSupport</code> ä¸­è¢«
è‡ªåŠ¨æ³¨å†Œã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Bean
</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">DispatcherHandler </span><span style="color:#fdf4c1;">webHandler() </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">return new </span><span style="color:#8ec07c;">DispatcherHandler</span><span style="color:#fdf4c1aa;">();
}
</span></pre><h2 id="assembly-dispatcherhandler"><a class="zola-anchor" href="#assembly-dispatcherhandler" aria-label="Anchor link for: assembly-dispatcherhandler">ğŸ”—</a>Assembly - DispatcherHandler</h2>
<p>è¿™ä¸ª <code>org.springframework.web.reactive.DispatcherHandler</code> åˆåšäº†ä¸€å±‚å°è£…ï¼Œåº•ä¸‹æ˜¯ä¸€ç³»åˆ—çš„
<code>HandlerMapping</code> ç±»çš„å®ç°ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">protected</span><span style="color:#fdf4c1aa;"> void </span><span style="color:#fdf4c1;">initStrategies(</span><span style="color:#8ec07c;">ApplicationContext</span><span style="color:#fdf4c1;"> context) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#8ec07c;">Map</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">String</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">HandlerMapping</span><span style="color:#fdf4c1aa;">&gt; mappingBeans </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">BeanFactoryUtils</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">beansOfTypeIncludingAncestors(
			context, </span><span style="color:#8ec07c;">HandlerMapping</span><span style="color:#fdf4c1;">.class, </span><span style="color:#d3869b;">true</span><span style="color:#fdf4c1;">, </span><span style="color:#d3869b;">false</span><span style="color:#fdf4c1;">)</span><span style="color:#fdf4c1aa;">;

	</span><span style="color:#8ec07c;">ArrayList</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">HandlerMapping</span><span style="color:#fdf4c1aa;">&gt; mappings </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">ArrayList</span><span style="color:#fdf4c1aa;">&lt;&gt;(mappingBeans.</span><span style="color:#fdf4c1;">values()</span><span style="color:#fdf4c1aa;">);
	</span><span style="color:#8ec07c;">AnnotationAwareOrderComparator</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">sort(mappings)</span><span style="color:#fdf4c1aa;">;
	</span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.handlerMappings </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">Collections</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">unmodifiableList(mappings)</span><span style="color:#fdf4c1aa;">;
}

@</span><span style="color:#fdf4c1;">Override
</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">handle(</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1;"> exchange) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">if </span><span style="color:#fdf4c1aa;">(</span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.handlerMappings </span><span style="color:#fe8019;">== </span><span style="color:#d3869b;">null</span><span style="color:#fdf4c1aa;">) {
		</span><span style="color:#fa5c4b;">return </span><span style="color:#fdf4c1;">createNotFoundError()</span><span style="color:#fdf4c1aa;">;
	}
	</span><span style="color:#fa5c4b;">return </span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">fromIterable(this.handlerMappings)
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">concatMap(mapping </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> mapping.getHandler(exchange))
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">next()
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">switchIfEmpty(createNotFoundError())
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">flatMap(handler </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">invokeHandler(exchange, handler))
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">flatMap(result </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">handleResult(exchange, result))</span><span style="color:#fdf4c1aa;">;
}
</span></pre><h2 id="assembly-routepredicatehandlermapping"><a class="zola-anchor" href="#assembly-routepredicatehandlermapping" aria-label="Anchor link for: assembly-routepredicatehandlermapping">ğŸ”—</a>Assembly - RoutePredicateHandlerMapping</h2>
<p><code>HandlerMapping</code> ä¹Ÿæ˜¯é€šè¿‡ Spring è‡ªåŠ¨ç®¡ç†çš„ï¼Œå…¶å®ç°ç±»æ˜¯ <code>org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping</code>ã€‚</p>
<p>è£…é…ä»£ç åœ¨ <code>org.springframework.cloud.gateway.config.GatewayAutoConfiguration</code> ä¸­ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Configuration
</span><span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">ConditionalOnProperty</span><span style="color:#fdf4c1aa;">(</span><span style="color:#fdf4c1;">name </span><span style="color:#fe8019;">= </span><span style="color:#b8bb26;">&quot;spring.cloud.gateway.enabled&quot;</span><span style="color:#fdf4c1aa;">, </span><span style="color:#fdf4c1;">matchIfMissing </span><span style="color:#fe8019;">= </span><span style="color:#d3869b;">true</span><span style="color:#fdf4c1aa;">)
@</span><span style="color:#fdf4c1;">EnableConfigurationProperties
</span><span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">AutoConfigureBefore</span><span style="color:#fdf4c1aa;">({ </span><span style="color:#8ec07c;">HttpHandlerAutoConfiguration</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class</span><span style="color:#fdf4c1aa;">,
		</span><span style="color:#8ec07c;">WebFluxAutoConfiguration</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class </span><span style="color:#fdf4c1aa;">})
@</span><span style="color:#fdf4c1;">AutoConfigureAfter</span><span style="color:#fdf4c1aa;">({ </span><span style="color:#8ec07c;">GatewayLoadBalancerClientAutoConfiguration</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class</span><span style="color:#fdf4c1aa;">,
		</span><span style="color:#8ec07c;">GatewayClassPathWarningAutoConfiguration</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class </span><span style="color:#fdf4c1aa;">})
@</span><span style="color:#fdf4c1;">ConditionalOnClass</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">DispatcherHandler</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">class</span><span style="color:#fdf4c1aa;">)
</span><span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">GatewayAutoConfiguration </span><span style="color:#fdf4c1aa;">{
	@</span><span style="color:#fdf4c1;">Bean
	</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">RoutePredicateHandlerMapping routePredicateHandlerMapping</span><span style="color:#fdf4c1aa;">(
			</span><span style="color:#8ec07c;">FilteringWebHandler </span><span style="color:#fdf4c1;">webHandler</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">RouteLocator </span><span style="color:#fdf4c1;">routeLocator</span><span style="color:#fdf4c1aa;">,
			</span><span style="color:#8ec07c;">GlobalCorsProperties </span><span style="color:#fdf4c1;">globalCorsProperties</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">Environment </span><span style="color:#fdf4c1;">environment</span><span style="color:#fdf4c1aa;">) {
		</span><span style="color:#fa5c4b;">return new </span><span style="color:#8ec07c;">RoutePredicateHandlerMapping</span><span style="color:#fdf4c1aa;">(webHandler, routeLocator,
				globalCorsProperties, environment);
	}

	@</span><span style="color:#fdf4c1;">Bean
	</span><span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Primary
	</span><span style="font-style:italic;color:#928374;">// TODO: property to disable composite?
	</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">RouteLocator cachedCompositeRouteLocator</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">RouteLocator</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">routeLocators</span><span style="color:#fdf4c1aa;">) {
		</span><span style="color:#fa5c4b;">return new </span><span style="color:#8ec07c;">CachingRouteLocator</span><span style="color:#fdf4c1aa;">(
				</span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">CompositeRouteLocator</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">fromIterable(routeLocators)</span><span style="color:#fdf4c1aa;">));
	}

	@</span><span style="color:#fdf4c1;">Bean
	</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">FilteringWebHandler filteringWebHandler</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">GlobalFilter</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">globalFilters</span><span style="color:#fdf4c1aa;">) {
		</span><span style="color:#fa5c4b;">return new </span><span style="color:#8ec07c;">FilteringWebHandler</span><span style="color:#fdf4c1aa;">(globalFilters);
	}
}
</span></pre>
<p><code>GatewayAutoConfiguration</code> è¿™ä¸ªè£…é…ç±»é‡Œé¢è¿˜æä¾›äº† <code>RouteLocator</code> å’Œ <code>FilteringWebHandler</code> çš„å®ç°ï¼Œè¿™
ä¸ªåé¢ä¼šç”¨åˆ°ã€‚</p>
<h2 id="runtime-routepredicatehandlermapping"><a class="zola-anchor" href="#runtime-routepredicatehandlermapping" aria-label="Anchor link for: runtime-routepredicatehandlermapping">ğŸ”—</a>Runtime - RoutePredicateHandlerMapping</h2>
<p><code>RoutePredicateHandlerMapping</code> ä¸­é¦–å…ˆä» <code>org.springframework.cloud.gateway.route.RouteLocator</code> ä¸­å»
è·å–å½“å‰æ‰€æœ‰å¯ç”¨çš„ <code>Route</code> å®ä¾‹å¹¶æ‰¾åˆ°ç¬¬ä¸€ä¸ªèƒ½åŒ¹é…å½“å‰è¯·æ±‚çš„ <code>Route</code> æ”¾åˆ°è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œç„¶åè°ƒç”¨ <code>org.springframework.cloud.gateway.handler.FilteringWebHandler</code> é‡Œé¢çš„ä»£ç ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">protected </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Route</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">lookupRoute(</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1;"> exchange) </span><span style="color:#fdf4c1aa;">{
    </span><span style="color:#fa5c4b;">return </span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.routeLocator.</span><span style="color:#fdf4c1;">getRoutes()
		</span><span style="font-style:italic;color:#928374;">// individually filter routes so that filterWhen error delaying is not a
		// problem
		</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">concatMap(route </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1;">.just(route).filterWhen(r </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">{
			</span><span style="font-style:italic;color:#928374;">// add the current route we are testing
</span><span style="color:#fdf4c1;">			exchange.getAttributes().put(GATEWAY_PREDICATE_ROUTE_ATTR, r.getId());
			</span><span style="color:#fa5c4b;">return</span><span style="color:#fdf4c1;"> r.getPredicate().apply(exchange);
		})
	</span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fdf4c1;">}
</span></pre>
<p><code>RouteLocator</code> çš„é€»è¾‘åé¢å†è®²ï¼Œå…ˆçœ‹çœ‹ <code>FilteringWebHandler</code> çš„é€»è¾‘ã€‚</p>
<h2 id="runtime-filteringwebhandler"><a class="zola-anchor" href="#runtime-filteringwebhandler" aria-label="Anchor link for: runtime-filteringwebhandler">ğŸ”—</a>Runtime - FilteringWebHandler</h2>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">handle(</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1;"> exchange) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#8ec07c;">Route</span><span style="color:#fdf4c1aa;"> route </span><span style="color:#fe8019;">=</span><span style="color:#fdf4c1aa;"> exchange.</span><span style="color:#fdf4c1;">getRequiredAttribute(GATEWAY_ROUTE_ATTR)</span><span style="color:#fdf4c1aa;">;
	</span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">GatewayFilter</span><span style="color:#fdf4c1aa;">&gt; gatewayFilters </span><span style="color:#fe8019;">=</span><span style="color:#fdf4c1aa;"> route.</span><span style="color:#fdf4c1;">getFilters()</span><span style="color:#fdf4c1aa;">;

	</span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">GatewayFilter</span><span style="color:#fdf4c1aa;">&gt; combined </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">ArrayList</span><span style="color:#fdf4c1aa;">&lt;&gt;(</span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.globalFilters);
	combined.</span><span style="color:#fdf4c1;">addAll(gatewayFilters)</span><span style="color:#fdf4c1aa;">;

	</span><span style="color:#8ec07c;">AnnotationAwareOrderComparator</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">sort(combined)</span><span style="color:#fdf4c1aa;">;

	</span><span style="color:#fa5c4b;">return new </span><span style="color:#8ec07c;">DefaultGatewayFilterChain</span><span style="color:#fdf4c1aa;">(combined).</span><span style="color:#fdf4c1;">filter(exchange)</span><span style="color:#fdf4c1aa;">;
}
</span></pre>
<p><code>FilteringWebHandler</code> ä¸­é¦–å…ˆä»è¯·æ±‚çš„ä¸Šä¸‹æ–‡ä¸­å–å‡ºåŒ¹é…åˆ°çš„ <code>Route</code> å®ä¾‹ï¼Œå°†å®ä¾‹é‡Œé¢çš„ <code>GatewayFilter</code>
åˆ—è¡¨å’Œå…¨å±€çš„ <code>GlobalFilter</code> åˆ—è¡¨åˆå¹¶æ’åºåæ”¾å…¥ <code>DefaultGatewayFilterChain</code> ï¼ˆåˆæ˜¯ä¸€ä¸ªè´£ä»»é“¾ï¼‰ä¸­è¿›è¡Œ
é“¾å¼å¤„ç†ã€‚</p>
<h2 id="runtime-defaultwebfilterchain"><a class="zola-anchor" href="#runtime-defaultwebfilterchain" aria-label="Anchor link for: runtime-defaultwebfilterchain">ğŸ”—</a>Runtime - DefaultWebFilterChain</h2>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">filter(</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1;"> exchange) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">return </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">defer(() </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">{
		</span><span style="color:#fa5c4b;">if </span><span style="color:#fdf4c1;">(this.index </span><span style="color:#fe8019;">&lt;</span><span style="color:#fdf4c1;"> filters.size()) {
			</span><span style="color:#8ec07c;">GatewayFilter</span><span style="color:#fdf4c1;"> filter </span><span style="color:#fe8019;">=</span><span style="color:#fdf4c1;"> filters.get(this.index);
			</span><span style="color:#8ec07c;">DefaultGatewayFilterChain</span><span style="color:#fdf4c1;"> chain </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">DefaultGatewayFilterChain</span><span style="color:#fdf4c1;">(this,
					this.index </span><span style="color:#fe8019;">+ </span><span style="color:#d3869b;">1</span><span style="color:#fdf4c1;">);
			</span><span style="color:#fa5c4b;">return</span><span style="color:#fdf4c1;"> filter.filter(exchange, chain);
		}
		</span><span style="color:#fa5c4b;">else </span><span style="color:#fdf4c1;">{
			</span><span style="color:#fa5c4b;">return </span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1;">.empty(); </span><span style="font-style:italic;color:#928374;">// complete
		</span><span style="color:#fdf4c1;">}
	})</span><span style="color:#fdf4c1aa;">;
}
</span></pre>
<p><code>DefaultGatewayFilterChain</code> é‡Œé¢ç»´æŠ¤äº†ä¸€ä¸ª <code>GatewayFilter</code> çš„é›†åˆå’Œä¸€ä¸ªæ ‡è¯†å½“å‰æ­£åœ¨å¤„ç†çš„å…ƒç´ çš„ç´¢å¼•
ï¼Œæ¯æ¬¡è°ƒç”¨åˆ°ä¸€ä¸ª <code>GatewayFilter</code> å…ƒç´ çš„å¤„ç†é€»è¾‘æ—¶åˆ›å»ºä¸€ä¸ªæ–°çš„æŒ‡å‘å¾ªæˆé¢å…ƒç´ çš„é“¾ï¼Œä»¥ä¸å¯å˜æ€§ä¿è¯çº¿ç¨‹
å®‰å…¨ã€‚</p>
<h1 id="routes"><a class="zola-anchor" href="#routes" aria-label="Anchor link for: routes">ğŸ”—</a>Routes</h1>
<p><a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> å‘å¤–æš´éœ²å‡ºæ¥çš„å¯¹è±¡ä¹‹ä¸€æ˜¯è·¯ç”±(Route) å¯¹è±¡ï¼Œå…¶æ ¹æ®ä¸€ä¸ªæˆ–è€…ä¸€ç³»åˆ—çš„æ¡ä»¶æ¥åˆ¤æ–­
æ¥æ”¶åˆ°çš„è¯·æ±‚æ˜¯å¦èƒ½è¢«æœ¬è·¯ç”±å¤„ç†ï¼Œå¦‚æœèƒ½å¤Ÿå¤„ç†ï¼Œåˆ™ä½¿ç”¨å†…ç½®çš„ä¸€ç³»åˆ—å±€éƒ¨è¿‡æ»¤å™¨å’Œå…¨å±€çš„è¿‡æ»¤å™¨å¤„ç†è¯·æ±‚å¹¶è¿”å›å“åº”ã€‚</p>
<h2 id="class-route"><a class="zola-anchor" href="#class-route" aria-label="Anchor link for: class-route">ğŸ”—</a>Class Route</h2>
<p>Route ç±»çš„å…¨ç§°æ˜¯ <code>org.springframework.cloud.gateway.route.Route</code>ï¼Œæ˜¯ <a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> æš´éœ²
å‡ºæ¥çš„å¤„ç†è¯·æ±‚çš„åŸºæœ¬å•å…ƒã€‚</p>
<p>ç»“æ„å¦‚ä¸‹ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">Route </span><span style="color:#fa5c4b;">implements </span><span style="color:#8ec07c;">Ordered </span><span style="color:#fdf4c1aa;">{

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">String </span><span style="color:#fdf4c1aa;">id;

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">URI </span><span style="color:#fdf4c1aa;">uri;

	</span><span style="color:#fa5c4b;">private final int </span><span style="color:#fdf4c1aa;">order;

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">AsyncPredicate</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1aa;">&gt; predicate;

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">GatewayFilter</span><span style="color:#fdf4c1aa;">&gt; gatewayFilters;

	</span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fdf4c1aa;">}
</span></pre>
<p>ä¸»è¦æˆå‘˜æ˜¯ä¸€ä¸ªè¯·æ±‚çš„åˆ¤å®šå™¨ <code>predicate</code>ã€å¤šä¸ªå¤„ç†å™¨ <code>gatewayFilters</code>ã€ä¸€ä¸ªåç«¯è®¿é—®åœ°å€ <code>uri</code>ï¼Œä»¥åŠä¸€
ä¸ªå”¯ä¸€æ ‡è¯†å’Œåºå·ã€‚</p>
<h2 id="interface-routelocator"><a class="zola-anchor" href="#interface-routelocator" aria-label="Anchor link for: interface-routelocator">ğŸ”—</a>Interface RouteLocator</h2>
<p><a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> é€šè¿‡ <code>org.springframework.cloud.gateway.route.RouteLocator</code> æ¥è¿›è¡Œæ‰€æœ‰è·¯ç”±
å¯¹è±¡çš„åŠ è½½ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public interface </span><span style="color:#8ec07c;">RouteLocator </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Route</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#8ec07c;">getRoutes</span><span style="color:#fdf4c1aa;">();
}
</span></pre><h2 id="routelocator-implementations"><a class="zola-anchor" href="#routelocator-implementations" aria-label="Anchor link for: routelocator-implementations">ğŸ”—</a>RouteLocator Implementations</h2>
<p><code>RouteLocator</code> æ¥å£æœ‰ä»¥ä¸‹è‡ªå¸¦å®ç°ï¼š</p>
<ul>
<li><code>org.springframework.cloud.gateway.route.CachingRouteLocator</code></li>
<li><code>org.springframework.cloud.gateway.route.CompositeRouteLocator</code></li>
<li><code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator</code></li>
</ul>
<p>åœ¨ <code>GatewayAutoConfiguration</code> ä¸­å¯ä»¥äº†è§£åŠ è½½çš„å®ä¾‹ï¼šç”± <code>RouteDefinitionRouteLocator</code> ç®¡ç†çš„è·¯ç”±å’Œå¤šä¸ªç”±ç¬¬ä¸‰æ–¹è‡ªå·±å®ç°çš„ <code>RouteLocator</code> ç®¡ç†çš„è·¯ç”±è¢« <code>CompositeRouteLocator</code> ç»„åˆèµ·æ¥ä¹‹åçš„ç»“æœå†ç»è¿‡ <code>CachingRouteLocator</code> è¢«ç¼“å­˜ä½¿ç”¨ã€‚</p>
<p><strong>æ‰€æœ‰</strong> èƒ½è¢« Spring æ„ŸçŸ¥åˆ°çš„ <code>org.springframework.cloud.gateway.route.RouteLocator</code> bean å®ä¾‹éƒ½ä¼šè¢«é»˜è®¤æ”¶é›†è¢« <code>CompositeRouteLocator</code> ç®¡ç†ã€‚</p>
<h2 id="routedefinitionroutelocator"><a class="zola-anchor" href="#routedefinitionroutelocator" aria-label="Anchor link for: routedefinitionroutelocator">ğŸ”—</a>RouteDefinitionRouteLocator</h2>
<p><code>RouteDefinitionLocator</code> ç”¨æ¥ç®¡ç†ååºåˆ—åŒ–ç”Ÿæˆçš„è·¯ç”±ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Override
</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Route</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">getRoutes() </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">return </span><span style="color:#fdf4c1;">this</span><span style="color:#fdf4c1aa;">.routeDefinitionLocator.</span><span style="color:#fdf4c1;">getRouteDefinitions()</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">map(this::convertToRoute)
			</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">map(route </span><span style="color:#fa5c4b;">-&gt; </span><span style="color:#fdf4c1;">{
				</span><span style="color:#fa5c4b;">if </span><span style="color:#fdf4c1;">(logger.isDebugEnabled()) {
					logger.debug(</span><span style="color:#b8bb26;">&quot;RouteDefinition matched: &quot; </span><span style="color:#fe8019;">+</span><span style="color:#fdf4c1;"> route.getId());
				}
				</span><span style="color:#fa5c4b;">return</span><span style="color:#fdf4c1;"> route;
			})</span><span style="color:#fdf4c1aa;">;
}
</span></pre>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå…¶ä½¿ç”¨äº† <code>RouteDefinitionLocator</code> æ¥ç®¡ç†è·¯ç”±çš„å®šä¹‰å¯¹è±¡ï¼Œå¹¶æä¾›äº†è·¯ç”±å®šä¹‰å¯¹è±¡åˆ°è·¯ç”±å¯¹è±¡çš„è½¬
æ¢ã€‚</p>
<p><code>RouteDefinitionLocator</code> çš„è®¾è®¡æ¨¡å¼ä¸ <code>RouteLocator</code> ç›¸ä¼¼ã€‚</p>
<h2 id="routedefinitionlocator-and-implementations"><a class="zola-anchor" href="#routedefinitionlocator-and-implementations" aria-label="Anchor link for: routedefinitionlocator-and-implementations">ğŸ”—</a>RouteDefinitionLocator and Implementations</h2>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">package </span><span style="color:#8ec07c;">org.springframework.cloud.gateway.route</span><span style="color:#fdf4c1aa;">;
</span><span style="color:#fa5c4b;">public interface </span><span style="color:#8ec07c;">RouteDefinitionLocator </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">RouteDefinition</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#8ec07c;">getRouteDefinitions</span><span style="color:#fdf4c1aa;">();
}
</span></pre>
<p><code>RouteDefinitionLocator</code> çš„å®ç°ç±»æœ‰ï¼š</p>
<ul>
<li><code>org.springframework.cloud.gateway.route.CompositeRouteDefinitionLocator</code></li>
<li><code>org.springframework.cloud.gateway.config.PropertiesRouteDefinitionLocator</code></li>
<li><code>org.springframework.cloud.gateway.route.InMemoryRouteDefinitionRepository</code></li>
</ul>
<h2 id="routedefinitionlocator-loading"><a class="zola-anchor" href="#routedefinitionlocator-loading" aria-label="Anchor link for: routedefinitionlocator-loading">ğŸ”—</a>RouteDefinitionLocator Loading</h2>
<p>ç±»ä¼¼åœ°ï¼Œåœ¨ <code>GatewayAutoConfiguration</code> ä¸­å¯ä»¥æ‰¾åˆ° <code>RouteDefinitionLocator</code> è¢«åŠ è½½ä½¿ç”¨çš„é€»è¾‘ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Bean
</span><span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Primary
</span><span style="color:#fa5c4b;">public </span><span style="color:#8ec07c;">RouteDefinitionLocator </span><span style="color:#fdf4c1;">routeDefinitionLocator(
		</span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1;">&lt;</span><span style="color:#8ec07c;">RouteDefinitionLocator</span><span style="color:#fdf4c1;">&gt; routeDefinitionLocators) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">return new </span><span style="color:#8ec07c;">CompositeRouteDefinitionLocator</span><span style="color:#fdf4c1aa;">(
			</span><span style="color:#8ec07c;">Flux</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">fromIterable(routeDefinitionLocators)</span><span style="color:#fdf4c1aa;">);
}
</span></pre>
<p><strong>æ‰€æœ‰</strong> èƒ½è¢« Spring æ„ŸçŸ¥åˆ°çš„ <code>org.springframework.cloud.gateway.route.RouteDefinitionLocator</code> bean å®ä¾‹éƒ½ä¼šè¢«é»˜è®¤æ”¶é›†è¢« <code>CompositeRouteDefinitionLocator</code> ç®¡ç†ã€‚</p>
<h2 id="routedefinition"><a class="zola-anchor" href="#routedefinition" aria-label="Anchor link for: routedefinition">ğŸ”—</a>RouteDefinition</h2>
<p><code>RouteDefinition</code> æ˜¯ <code>Route</code> è·¯ç”±å¯¹è±¡çš„åºåˆ—åŒ–å¯¹è±¡ï¼›ä¸€ä¸ªåˆæ³•çš„ <code>RouteDefinition</code> å¯¹è±¡å¯ä»¥è¢«æ„é€ ä¸ºä¸€ä¸ª
è·¯ç”±å¯¹è±¡ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">RouteDefinition </span><span style="color:#fdf4c1aa;">{
	@</span><span style="color:#fdf4c1;">NotEmpty
	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">String </span><span style="color:#fdf4c1aa;">id </span><span style="color:#fe8019;">= </span><span style="color:#8ec07c;">UUID</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">randomUUID()</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">toString()</span><span style="color:#fdf4c1aa;">;

	@</span><span style="color:#fdf4c1;">NotEmpty
	</span><span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Valid
	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">PredicateDefinition</span><span style="color:#fdf4c1aa;">&gt; predicates </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">ArrayList</span><span style="color:#fdf4c1aa;">&lt;&gt;();

	@</span><span style="color:#fdf4c1;">Valid
	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">FilterDefinition</span><span style="color:#fdf4c1aa;">&gt; filters </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">ArrayList</span><span style="color:#fdf4c1aa;">&lt;&gt;();

	@</span><span style="color:#fdf4c1;">NotNull
	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">URI </span><span style="color:#fdf4c1aa;">uri;

	</span><span style="color:#fa5c4b;">private int </span><span style="color:#fdf4c1aa;">order </span><span style="color:#fe8019;">= </span><span style="color:#d3869b;">0</span><span style="color:#fdf4c1aa;">;

 	</span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fdf4c1aa;">}
</span></pre>
<p>ä¸ <code>Route</code> ç±»ä¼¼ï¼Œ<code>RouteDefinition</code> çš„ä¸»è¦æˆå‘˜æ˜¯å¤šä¸ªè¯·æ±‚çš„åˆ¤å®šå™¨å®šä¹‰å¯¹è±¡ <code>predicates</code>ã€å¤šä¸ªå¤„ç†å™¨å®šä¹‰å¯¹è±¡ <code>filters</code>ã€ä¸€ä¸ªåç«¯è®¿é—®åœ°å€ <code>uri</code>ï¼Œä»¥åŠä¸€ä¸ªå”¯ä¸€æ ‡è¯†å’Œåºå·ã€‚</p>
<h2 id="route-construction"><a class="zola-anchor" href="#route-construction" aria-label="Anchor link for: route-construction">ğŸ”—</a>Route Construction</h2>
<p>æ‰€ä»¥ï¼Œ<a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> å®˜æ–¹æä¾›äº†ä¸¤ç§æ–¹å¼ç”Ÿæˆä¸€ä¸ªè·¯ç”±å¯¹è±¡ã€‚</p>
<h3 id="via-routelocatorbuilder-in-java"><a class="zola-anchor" href="#via-routelocatorbuilder-in-java" aria-label="Anchor link for: via-routelocatorbuilder-in-java">ğŸ”—</a>Via RouteLocatorBuilder in Java</h3>
<p><code>RouteLocatorBuilder</code> å¯ä»¥å¾ˆå®¹æ˜“åœ°è¢«ç”¨æ¥æ„å»ºè·¯ç”±å¯¹è±¡ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">@</span><span style="color:#fdf4c1;">Bean
</span><span style="color:#8ec07c;">RouteLocator </span><span style="color:#fdf4c1;">constantRouteLocator(final </span><span style="color:#8ec07c;">RouteLocatorBuilder</span><span style="color:#fdf4c1;"> builder) </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#fa5c4b;">return</span><span style="color:#fdf4c1aa;"> builder.</span><span style="color:#fdf4c1;">routes()
		</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">route(</span><span style="color:#b8bb26;">&quot;demo_lb&quot;</span><span style="color:#fdf4c1;">, r </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> r.header(</span><span style="color:#b8bb26;">&quot;XHOST&quot;</span><span style="color:#fdf4c1;">)
			.filters(f </span><span style="color:#fa5c4b;">-&gt;</span><span style="color:#fdf4c1;"> f.prefixPath(</span><span style="color:#b8bb26;">&quot;/search&quot;</span><span style="color:#fdf4c1;">))
			.uri(</span><span style="color:#b8bb26;">&quot;lb://httpbin.org&quot;</span><span style="color:#fdf4c1;">))
		</span><span style="color:#fdf4c1aa;">.</span><span style="color:#fdf4c1;">build()</span><span style="color:#fdf4c1aa;">;
}
</span></pre><h3 id="via-routedefinition-in-yaml-properties"><a class="zola-anchor" href="#via-routedefinition-in-yaml-properties" aria-label="Anchor link for: via-routedefinition-in-yaml-properties">ğŸ”—</a>Via RouteDefinition in YAML/Properties</h3>
<p><code>RouteDefinition</code> å¯ä»¥å¾ˆå®¹æ˜“åœ°è¢«ç”¨æ¥ä»å¤–éƒ¨é…ç½®æ–‡ä»¶ (YAML/Properties) æ„å»ºè·¯ç”±å¯¹è±¡ã€‚</p>
<pre style="background-color:#282828;">
<span style="font-weight:bold;color:#8ec07c;">spring</span><span style="color:#fdf4c1aa;">:
    </span><span style="font-weight:bold;color:#8ec07c;">cloud</span><span style="color:#fdf4c1aa;">:
        </span><span style="font-weight:bold;color:#8ec07c;">gateway</span><span style="color:#fdf4c1aa;">:
            </span><span style="font-weight:bold;color:#8ec07c;">routes</span><span style="color:#fdf4c1aa;">:
                - </span><span style="font-weight:bold;color:#8ec07c;">id</span><span style="color:#fdf4c1aa;">: </span><span style="font-weight:bold;color:#8ec07c;">r1
                  order</span><span style="color:#fdf4c1aa;">: </span><span style="color:#d3869b;">2
                  </span><span style="font-weight:bold;color:#8ec07c;">uri</span><span style="color:#fdf4c1aa;">: </span><span style="color:#b8bb26;">&quot;https://a.com&quot;
                  </span><span style="font-weight:bold;color:#8ec07c;">predicates</span><span style="color:#fdf4c1aa;">:
                      - </span><span style="font-weight:bold;color:#8ec07c;">host=a.org
                  filters</span><span style="color:#fdf4c1aa;">:
                      - </span><span style="font-weight:bold;color:#8ec07c;">AddRequestHeader=XHOST,my.a.org
                </span><span style="color:#fdf4c1aa;">- </span><span style="font-weight:bold;color:#8ec07c;">id</span><span style="color:#fdf4c1aa;">: </span><span style="font-weight:bold;color:#8ec07c;">r2
                  order</span><span style="color:#fdf4c1aa;">: </span><span style="color:#d3869b;">1
                  </span><span style="font-weight:bold;color:#8ec07c;">uri</span><span style="color:#fdf4c1aa;">: </span><span style="color:#b8bb26;">&quot;https://b.com&quot;
                  </span><span style="font-weight:bold;color:#8ec07c;">predicates</span><span style="color:#fdf4c1aa;">:
                      - </span><span style="font-weight:bold;color:#8ec07c;">Host=b.org
                  filters</span><span style="color:#fdf4c1aa;">:
                      - </span><span style="color:#b8bb26;">AddRequestHeader=XHOST,my.b.org
</span></pre><h1 id="predicate"><a class="zola-anchor" href="#predicate" aria-label="Anchor link for: predicate">ğŸ”—</a>Predicate</h1>
<p>è°“è¯å¯¹è±¡å³è·¯ç”±å¯¹è±¡é‡Œé¢çš„åˆ¤å®šæ¡ä»¶ã€‚</p>
<h2 id="asyncpredicate"><a class="zola-anchor" href="#asyncpredicate" aria-label="Anchor link for: asyncpredicate">ğŸ”—</a>AsyncPredicate</h2>
<p><code>Route</code> ç±»é‡Œé¢çš„è°“è¯å¯¹è±¡çš„ç±»å‹æ˜¯ <code>AsyncPredicate</code>ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">Route </span><span style="color:#fa5c4b;">implements </span><span style="color:#8ec07c;">Ordered </span><span style="color:#fdf4c1aa;">{

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">String </span><span style="color:#fdf4c1aa;">id;

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">URI </span><span style="color:#fdf4c1aa;">uri;

	</span><span style="color:#fa5c4b;">private final int </span><span style="color:#fdf4c1aa;">order;

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">AsyncPredicate</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1aa;">&gt; predicate; </span><span style="font-style:italic;color:#928374;">// HERE

	</span><span style="color:#fa5c4b;">private final </span><span style="color:#8ec07c;">List</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">GatewayFilter</span><span style="color:#fdf4c1aa;">&gt; gatewayFilters;

	</span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fdf4c1aa;">}
</span></pre><h2 id="predicatedefinition"><a class="zola-anchor" href="#predicatedefinition" aria-label="Anchor link for: predicatedefinition">ğŸ”—</a>PredicateDefinition</h2>
<p>ç›¸æ¯” <code>AsyncPredicate</code> ç±»ï¼Œæˆ‘ä»¬æ›´å…³å¿ƒå…¶å¯¹åº”çš„å®šä¹‰ç±» <code>PredicateDefinition</code>ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">PredicateDefinition </span><span style="color:#fdf4c1aa;">{
	@</span><span style="color:#fdf4c1;">NotNull
	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">String </span><span style="color:#fdf4c1aa;">name;

	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">Map</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">String</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">String</span><span style="color:#fdf4c1aa;">&gt; args </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">LinkedHashMap</span><span style="color:#fdf4c1aa;">&lt;&gt;();

	</span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fdf4c1aa;">}
</span></pre>
<p>ä¸ºäº†ä¿æŒä»£ç ç®€å•ï¼Œå…¶å®šä¹‰è¢«è®¾è®¡ä¸ºä¸€ä¸ªç±»å‹æ ‡è¯†åå’Œä¸€ä¸ª K-V çš„æ˜ å°„è¡¨ã€‚</p>
<h2 id="predicatedefinition-to-asyncpredicate"><a class="zola-anchor" href="#predicatedefinition-to-asyncpredicate" aria-label="Anchor link for: predicatedefinition-to-asyncpredicate">ğŸ”—</a>PredicateDefinition to AsyncPredicate</h2>
<p><code>PredicateDefinition</code> åˆ° <code>AsyncPredicate</code> çš„è½¬æ¢é€»è¾‘åœ¨ <code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator</code> ç±»çš„ <code>lookUp</code> æ–¹æ³•é‡Œé¢ï¼Œå¤§é‡ä½¿ç”¨äº†åå°„çš„æŠ€å·§ã€‚</p>
<p>å…¶ä¸­ï¼Œä½¿ç”¨äº† <code>org.springframework.cloud.gateway.handler.predicate.RoutePredicateFactory</code> ç±»ä½œä¸ºäºŒè€…
è½¬æ¢çš„æ¡¥ã€‚</p>
<h2 id="routepredicatefactory"><a class="zola-anchor" href="#routepredicatefactory" aria-label="Anchor link for: routepredicatefactory">ğŸ”—</a>RoutePredicateFactory</h2>
<p>è¯¥ç±»å…¨ç§° <code>org.springframework.cloud.gateway.handler.predicate.RoutePredicateFactory&lt;C&gt;</code>ï¼Œæä¾›äº†ä¸€ä¸ª
ç»Ÿä¸€çš„åŸºäº Spring é€šç”¨åå°„æ¨¡å¼çš„è°“è¯æ„é€ å·¥å‚ç±»ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public interface </span><span style="color:#8ec07c;">RoutePredicateFactory</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#fdf4c1;">C</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fa5c4b;">extends </span><span style="color:#8ec07c;">ShortcutConfigurable</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">Configurable</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">C</span><span style="color:#fdf4c1aa;">&gt; {
	</span><span style="color:#8ec07c;">AsyncPredicate</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">ServerWebExchange</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">applyAsync(</span><span style="color:#8ec07c;">Consumer</span><span style="color:#fdf4c1;">&lt;</span><span style="color:#8ec07c;">C</span><span style="color:#fdf4c1;">&gt; consumer)</span><span style="color:#fdf4c1aa;">;

	</span><span style="color:#8ec07c;">Class</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">C</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">getConfigClass()</span><span style="color:#fdf4c1aa;">;
}
</span></pre><h2 id="builtin-predicate-factories"><a class="zola-anchor" href="#builtin-predicate-factories" aria-label="Anchor link for: builtin-predicate-factories">ğŸ”—</a>Builtin Predicate Factories</h2>
<p>å®˜æ–¹é»˜è®¤æä¾›äº†ä»¥ä¸‹è°“è¯æ„é€ å·¥å‚çš„å®ç°ç±»ï¼Œå¯ä»¥å®ç°å¤šç§ä¸åŒçš„è¯·æ±‚åŒ¹é…èƒ½åŠ›ã€‚</p>
<ul>
<li><code>org.springframework.cloud.gateway.handler.predicate.AfterRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.BeforeRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.BetweenRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.CookieRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.HeaderRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.HostRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.MethodRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.QueryRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.RemoteAddrRoutePredicateFactory</code></li>
</ul>
<h1 id="filter"><a class="zola-anchor" href="#filter" aria-label="Anchor link for: filter">ğŸ”—</a>Filter</h1>
<p>è¿‡æ»¤å™¨å¯¹è±¡å³è·¯ç”±å¯¹è±¡ä¸­åŒ¹é…åå¤„ç†é€»è¾‘çš„å°è£…ã€‚</p>
<h2 id="gatewayfilter"><a class="zola-anchor" href="#gatewayfilter" aria-label="Anchor link for: gatewayfilter">ğŸ”—</a>GatewayFilter</h2>
<p><code>Route</code> ç±»é‡Œé¢çš„è¿‡æ»¤å™¨å¯¹è±¡çš„ç±»å‹æ˜¯ <code>GatewayFilter</code>ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public interface </span><span style="color:#8ec07c;">GatewayFilter </span><span style="color:#fa5c4b;">extends </span><span style="color:#8ec07c;">ShortcutConfigurable </span><span style="color:#fdf4c1aa;">{
	</span><span style="color:#8ec07c;">Mono</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">Void</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#8ec07c;">filter</span><span style="color:#fdf4c1aa;">(</span><span style="color:#8ec07c;">ServerWebExchange </span><span style="color:#fdf4c1;">exchange</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">GatewayFilterChain </span><span style="color:#fdf4c1;">chain</span><span style="color:#fdf4c1aa;">);
}
</span></pre>
<p>è¯¥ç±»ä¸ä¹‹å‰çš„ <code>DefaultGatewayFilterChain</code> ç±»ç»“åˆèµ·æ¥ï¼Œç»„æˆäº†ä¸€ä¸ªé“¾å¼çš„è¯·æ±‚å¤„ç†æµç¨‹ã€‚</p>
<h2 id="filterdefinition"><a class="zola-anchor" href="#filterdefinition" aria-label="Anchor link for: filterdefinition">ğŸ”—</a>FilterDefinition</h2>
<p>ç›¸æ¯” <code>FilterDefinition</code> ç±»ï¼Œæˆ‘ä»¬æ›´å…³å¿ƒå…¶å¯¹åº”çš„å®šä¹‰ç±» <code>FilterDefinition</code>ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public class </span><span style="color:#8ec07c;">FilterDefinition </span><span style="color:#fdf4c1aa;">{
	@</span><span style="color:#fdf4c1;">NotNull
	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">String </span><span style="color:#fdf4c1aa;">name;

	</span><span style="color:#fa5c4b;">private </span><span style="color:#8ec07c;">Map</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">String</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">String</span><span style="color:#fdf4c1aa;">&gt; args </span><span style="color:#fe8019;">= </span><span style="color:#fa5c4b;">new </span><span style="color:#8ec07c;">LinkedHashMap</span><span style="color:#fdf4c1aa;">&lt;&gt;();

	</span><span style="font-style:italic;color:#928374;">// ...
</span><span style="color:#fdf4c1aa;">}
</span></pre>
<p>ä¸ºäº†ä¿æŒä»£ç ç®€å•ï¼Œå…¶å®šä¹‰è¢«è®¾è®¡ä¸ºä¸€ä¸ªç±»å‹æ ‡è¯†åå’Œä¸€ä¸ª K-V çš„æ˜ å°„è¡¨ã€‚</p>
<h2 id="filterdefinition-to-gatewayfilter"><a class="zola-anchor" href="#filterdefinition-to-gatewayfilter" aria-label="Anchor link for: filterdefinition-to-gatewayfilter">ğŸ”—</a>FilterDefinition to GatewayFilter</h2>
<p>ä»å®šä¹‰ç”Ÿæˆè¿‡æ»¤å™¨å¯¹è±¡çš„é€»è¾‘åœ¨ <code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator</code> çš„ <code>loadGatewayFilters</code> æ–¹æ³•ä¸­ã€‚å…¶ä¸­ï¼ŒåŒæ ·ä½¿ç”¨äº† <code>org.springframework.cloud.gateway.handler.predicate.GatewayFilterFactory</code> ç±»ä½œä¸ºäºŒè€…è½¬æ¢çš„æ¡¥ã€‚</p>
<h2 id="gatewayfilterfactory"><a class="zola-anchor" href="#gatewayfilterfactory" aria-label="Anchor link for: gatewayfilterfactory">ğŸ”—</a>GatewayFilterFactory</h2>
<p><code>org.springframework.cloud.gateway.filter.factory.GatewayFilterFactory&lt;T&gt;</code> çš„è®¾è®¡æ¨¡å¼å’Œä½¿ç”¨æ–¹å¼åŒ
<code>RoutePredicateFactory</code> ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fa5c4b;">public interface </span><span style="color:#8ec07c;">GatewayFilterFactory</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#fdf4c1;">C</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fa5c4b;">extends </span><span style="color:#8ec07c;">ShortcutConfigurable</span><span style="color:#fdf4c1aa;">, </span><span style="color:#8ec07c;">Configurable</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">C</span><span style="color:#fdf4c1aa;">&gt; {
	</span><span style="color:#fa5c4b;">default </span><span style="color:#8ec07c;">GatewayFilter </span><span style="color:#fdf4c1;">apply(</span><span style="color:#8ec07c;">Consumer</span><span style="color:#fdf4c1;">&lt;</span><span style="color:#8ec07c;">C</span><span style="color:#fdf4c1;">&gt; consumer) </span><span style="color:#fdf4c1aa;">{
		</span><span style="color:#8ec07c;">C</span><span style="color:#fdf4c1aa;"> config </span><span style="color:#fe8019;">= </span><span style="color:#fdf4c1;">newConfig()</span><span style="color:#fdf4c1aa;">;
		consumer.</span><span style="color:#fdf4c1;">accept(config)</span><span style="color:#fdf4c1aa;">;
		</span><span style="color:#fa5c4b;">return </span><span style="color:#fdf4c1;">apply(config)</span><span style="color:#fdf4c1aa;">;
	}

	</span><span style="color:#fa5c4b;">default </span><span style="color:#8ec07c;">Class</span><span style="color:#fdf4c1aa;">&lt;</span><span style="color:#8ec07c;">C</span><span style="color:#fdf4c1aa;">&gt; </span><span style="color:#fdf4c1;">getConfigClass() </span><span style="color:#fdf4c1aa;">{
		</span><span style="color:#fa5c4b;">throw new </span><span style="color:#8ec07c;">UnsupportedOperationException</span><span style="color:#fdf4c1aa;">(</span><span style="color:#b8bb26;">&quot;getConfigClass() not implemented&quot;</span><span style="color:#fdf4c1aa;">);
	}
}
</span></pre><h2 id="builtin-filter-factories"><a class="zola-anchor" href="#builtin-filter-factories" aria-label="Anchor link for: builtin-filter-factories">ğŸ”—</a>Builtin Filter Factories</h2>
<p>å®˜æ–¹é»˜è®¤æä¾›äº†ä»¥ä¸‹è¿‡æ»¤å™¨æ„é€ å·¥å‚çš„å®ç°ç±»ï¼Œå¯ä»¥å®ç°å¤šç§ä¸åŒçš„è¯·æ±‚å¤„ç†èƒ½åŠ›ã€‚</p>
<ul>
<li>AddRequestHeader GatewayFilter Factory</li>
<li>AddRequestParameter GatewayFilter Factory</li>
<li>AddResponseHeader GatewayFilter Factory</li>
<li>Hystrix GatewayFilter Factory</li>
<li>FallbackHeaders GatewayFilter Factory</li>
<li>PrefixPath GatewayFilter Factory</li>
<li>PreserveHostHeader GatewayFilter Factory</li>
<li>RequestRateLimiter GatewayFilter Factory</li>
<li>RedirectTo GatewayFilter Factory</li>
<li>RemoveNonProxyHeaders GatewayFilter Factory</li>
<li>RemoveRequestHeader GatewayFilter Factory</li>
<li>RemoveResponseHeader GatewayFilter Factory</li>
<li>RewritePath GatewayFilter Factory</li>
<li>RewriteResponseHeader GatewayFilter Factory</li>
<li>SaveSession GatewayFilter Factory</li>
<li>SecureHeaders GatewayFilter Factory</li>
<li>SetPath GatewayFilter Factory</li>
<li>SetResponseHeader GatewayFilter Factory</li>
<li>SetStatus GatewayFilter Factory</li>
<li>StripPrefix GatewayFilter Factory</li>
<li>Retry GatewayFilter Factory</li>
<li>RequestSize GatewayFilter Factory</li>
<li>Modify Request Body GatewayFilter Factory</li>
<li>Modify Response Body GatewayFilter Factory</li>
</ul>
<h1 id="global-filter"><a class="zola-anchor" href="#global-filter" aria-label="Anchor link for: global-filter">ğŸ”—</a>Global Filter</h1>
<p>å…¨å±€è¿‡æ»¤å™¨å¯¹è±¡æ˜¯å¯¹è·¯ç”±åå‘ä»£ç†åˆ°åç«¯èƒ½åŠ›çš„å°è£…ï¼Œå…¶ä¸»è¦é€šè¿‡ URI çš„ scheme æ¥å†³å®šåº”ç”¨çš„é€»è¾‘ï¼›ä¸€èˆ¬æ¥è¯´
ï¼Œä¸åŒçš„ scheme ä¼šæœ‰ä¸åŒçš„å…¨å±€è¿‡æ»¤å™¨å¯¹è±¡æ¥å¤„ç†ã€‚</p>
<p>å½“å‰å®˜æ–¹é»˜è®¤èƒ½æ”¯æŒçš„ scheme æœ‰ï¼š</p>
<ul>
<li>http</li>
<li>https</li>
<li>lb</li>
<li>forward</li>
</ul>
<p>å…¨å±€è¿‡æ»¤å™¨çš„æ¥å£åŒæ™®é€šè¿‡æ»¤å™¨ï¼Œä½†æ²¡æœ‰æä¾›ä»å®šä¹‰ååºåˆ—åŒ–ç”Ÿæˆçš„èƒ½åŠ›ã€‚</p>
<hr />
<p>ä»¥ä¸Šã€‚</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;gateway&#x2F;">#gateway</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;spring-cloud&#x2F;">#spring-cloud</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;spring-cloud-gateway&#x2F;">#spring-cloud-gateway</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;route&#x2F;">#route</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;ffmpeg-vsync-explained&#x2F;">â€¹ Ffmpeg -vsync ä½¿ç”¨åœºæ™¯è¾¨æ</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;slow-mysql-query-on-too-many-cas-updating-failure&#x2F;">ä¸€æ¬¡ç”±äºçº¿ä¸Š MySQL å¹¶å‘æŠ¢å æ›´æ–°å†²çªå¼•å‘çš„ BUG â€º</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;www.wangbo.im&#x2F;even.js" ></script>
      
    </body>

</html>
