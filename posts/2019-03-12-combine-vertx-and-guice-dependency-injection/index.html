<!DOCTYPE html>
<html lang="en">
    <head>
    <title>在 Vert.x 项目中集成使用 Guice 依赖注入 - Elvis Wang</title>
    
    
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    <meta name="description" content="wangbo’s home &amp; blog"/>

    <meta property="og:title" content="
    wangbo’s blog -&nbsp;在 Vert.x 项目中集成使用 Guice 依赖注入" />
    <meta property="og:type" content="website"/>
    <meta property="og:url" content="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-12-combine-vertx-and-guice-dependency-injection&#x2F;"/>
    <meta property="og:description" content="&lt;p&gt;本文介绍了项目中在基于 &lt;a href=&quot;https:&#x2F;&#x2F;vertx.io&quot; title=&quot;Eclipse Vert.x&quot;&gt;Eclipse Vert.x&lt;&#x2F;a&gt; 的 Verticle 中使用 &lt;a href=&quot;https:&#x2F;&#x2F;github.com&#x…"/>
    <link rel="stylesheet" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;style.css">
    <link rel="stylesheet" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;color&#x2F;blue.css">
<link rel="shortcut icon" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;favicon.ico" type="image/x-icon" /></head>
    <body>
        <div class="container full">
<header class="header">
    <div class="header__inner">
        <div class="header__logo">
            <a href="&#x2F;">
    <div class="logo">
        WB Prime
    </div>
</a>
        </div>
        <div class="menu-trigger">menu</div>
    </div>
    
    <nav class="menu">
        <ul class="menu__inner menu__inner--desktop">
            
            
                    <li>
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;about">About</a>
                    </li>
                
                    <li>
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;categories">Categories</a>
                    </li>
                
                    <li>
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags">Tags</a>
                    </li>
                
            </ul>

        <ul class="menu__inner menu__inner--mobile">
            
        <li>
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;about">About</a>
        </li>
        <li>
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;categories">Categories</a>
        </li>
        <li>
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags">Tags</a>
        </li>
        </ul>
    </nav>

    </header>
<div class="content"><div class="post">
        <h1 class="post-title">
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-03-12-combine-vertx-and-guice-dependency-injection&#x2F;">在 Vert.x 项目中集成使用 Guice 依赖注入</a>
        </h1>
        
    <div class="post-meta">
        <span class="post-date">2019.03.31
                </span>

        <span class="post-author"></span>

        

    
    :: {<a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;categories&#x2F;vertx&#x2F;">Vertx</a>} 

            
    ::
    #<a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;vert-x&#x2F;">vert.x</a>
        
    #<a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;guice&#x2F;">guice</a>
        
    #<a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;jsr303&#x2F;">jsr303</a>
        
    
            
        
    </div>



        

        <div class="post-content">
            <p>本文介绍了项目中在基于 <a href="https://vertx.io" title="Eclipse Vert.x">Eclipse Vert.x</a> 的 Verticle 中使用 <a href="https://github.com/google/guice" title="Google Guice">Google Guice</a> 进行依赖注入的实践，主要的思路是在 <code>io.vertx.core.Verticle#start</code> 方法中主动创建 <code>com.google.inject.Injector</code> 注入器实例并实行注入操作，在注入操作成功结束之后再进行后续的操作。</p>
<p>在开发结束后的某一天，通过万能的搜索发现已经有人提供了基于 <a href="https://github.com/google/guice" title="Google Guice">Google Guice</a> 的 <a href="https://vertx.io" title="Eclipse Vert.x">Eclipse Vert.x</a> 扩展: <a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a>。<a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 扩展了 <a href="https://vertx.io" title="Eclipse Vert.x">Vert.x</a> 内置的 <code>io.vertx.core.spi.VerticleFactory</code> 机制，能够使用 SPI 的方式加载需要的
Guice 依赖。</p>
<p>本文总结一下自己的实现思路，然后分析 <a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 的实现细节，希望能提高自己的代码水平。</p>
<p><a name="continue-reading"></a></p>
<h1 id="wo-de-fang-an"><a class="zola-anchor" href="#wo-de-fang-an" aria-label="Anchor link for: wo-de-fang-an">🔗</a>
我的方案</h1>
<p>我的方案很直接很粗暴：把 Verticle 的启动方法作为程序的入口，在入口方法里面创建 Guice Injector 实例并对启动的 Verticle 实例进行主动注入。</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">public class MainVerticle extends AbstractVerticle {
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private static final Logger LOGGER = LoggerFactory.getLogger(MainVerticle.class);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Named(Constants.KEY_HTTP_LISTEN_HOST)
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private String listenIp;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Named(Constants.KEY_HTTP_LISTEN_PORT)
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private Integer listenPort = 8001;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@RegularRouter
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private Set&lt;Controller&gt; regularControllers;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private Set&lt;Runnable&gt; warmUps;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">public void start(final Future&lt;Void&gt; future) throws Exception {
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">final Injector injector = Guice.createInjector(new MainModule(vertx, config()));
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">injector.injectMembers(this);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">final Router router = Router.router(vertx);
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">router.exceptionHandler(ex -&gt; LOGGER.warn(&quot;Uncaught exception&quot;, ex));
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">regularControllers.stream().sorted().forEach(c -&gt; {
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">LOGGER.debug(&quot;Registered regular Controller \&quot;{}\&quot;&quot;, c);
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">c.accept(router);
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">});
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">Completable.fromRunnable(() -&gt; warmUps.parallelStream().forEach(Runnable::run))
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">.subscribeOn(RxHelper.blockingScheduler(vertx))
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">.subscribe(
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">() -&gt; {
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">LOGGER.info(&quot;Warm up finished, try to start HTTP listening on {}:{} ...&quot;, listenIp, listenPort);
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">vertx.createHttpServer()
</span><span style="color:#dcdcdc;">                        </span><span style="color:#dcdcdc;">.requestHandler(router::accept)
</span><span style="color:#dcdcdc;">                        </span><span style="color:#dcdcdc;">.listen(listenPort, listenIp, e -&gt; {
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">if (e.succeeded()) {
</span><span style="color:#dcdcdc;">                                </span><span style="color:#dcdcdc;">future.complete();
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">} else {
</span><span style="color:#dcdcdc;">                                </span><span style="color:#dcdcdc;">future.fail(e.cause());
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">                        </span><span style="color:#dcdcdc;">});
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">},
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">ex -&gt; {
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">LOGGER.error(&quot;Warmup failed, disable HTTP listening&quot;, ex);
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">future.fail(ex);
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">}
</span></pre>
<p>代码很简洁明了。</p>
<p>服务中需要启动一个 HttpServer 监听，监听的 host 和端口需要在服务外部通过配置的方式传进来。这些配置是通过 Guice 配置并注入的。</p>
<p>构造的 HttpServer 需要为不同的 Endpoint (path &amp; method) 设置不同的响应代码 (Handler)，我将其抽象为一系列的 Controller：其实就是 JDK8 的 Consumer 接口，实现了支持为 Router 添加 Handler 的 <code>accept</code> 方法以及添加了能够实现优先级的 <code>order</code> 方法。</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#9b9b9b;">import </span><span style="color:#dcdcdc;">java.util.function.Consumer;
</span><span style="color:#569cd6;">public interface </span><span style="color:#dcdcdc;">Controller </span><span style="color:#569cd6;">extends </span><span style="color:#4ec9b0;">Consumer</span><span style="color:#dcdcdc;">&lt;Router&gt;, Comparable&lt;Controller&gt; {
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">default long </span><span style="color:#dcdcdc;">order() {</span><span style="color:#569cd6;">return </span><span style="color:#b5cea8;">0</span><span style="color:#569cd6;">L</span><span style="color:#dcdcdc;">;}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">default int </span><span style="color:#dcdcdc;">compareTo(final Controller o) {
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">return </span><span style="color:#dcdcdc;">Long.compare(order(), o.order());
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">default</span><span style="color:#dcdcdc;"> void accept(final Router r) {
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">r.route(</span><span style="color:#d69d85;">&quot;/&quot;</span><span style="color:#dcdcdc;">).handler(ctx </span><span style="color:#569cd6;">-&gt; </span><span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">            </span><span style="color:#569cd6;">final </span><span style="color:#dcdcdc;">JsonObject msg = </span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">JsonObject();
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">msg.put(</span><span style="color:#d69d85;">&quot;Hello&quot;</span><span style="color:#dcdcdc;">, </span><span style="color:#d69d85;">&quot;World&quot;</span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">ctx.response().end(msg.encode());
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">});
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">}
</span></pre>
<p>添加了 <code>order</code> 方法的 Controller 的多个实现类可以通过 <a href="https://github.com/google/guice/wiki/Multibindings" title="Google Guice MultiBindings Extension">com.google.inject.extensions:guice-multibindings</a> 提供的 <code>com.google.inject.multibindings.Multibinder</code> 来提供注入为 <code>java.util.Set</code> 的支持。不同的 Controller 实现类可以处于多个包中，分别通过以下代码提供：</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">final </span><span style="color:#dcdcdc;">Multibinder&lt;Controller&gt; binder =
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">Multibinder.newSetBinder(binder(), Controller.class, RegularRouter.class);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">binder.addBinding().to(FastController.class).in(Scopes.</span><span style="color:#b4cea8;">SINGLETON</span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">binder.addBinding().to(SlowController.class).in(Scopes.</span><span style="color:#b4cea8;">SINGLETON</span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">}
</span></pre>
<p>同样，可以添加对实现了 <code>java.lang.Runnable</code> 的类型注入支持，模拟生命周期管理。</p>
<p>最关键的依赖注入的执行代码在 <code>start</code> 方法的最开始：</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#569cd6;">final </span><span style="color:#dcdcdc;">Injector injector = Guice.createInjector(</span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">MainModule(vertx, config()));
</span><span style="color:#dcdcdc;">injector.injectMembers(this); </span><span style="color:#608b4e;">// On-demand Injection via injectMembers
</span></pre>
<p>代码从依赖提供者 <code>MainModule</code> 创建注入器，成功之后再对当前的 <code>MainVerticle</code> 执行 <a href="https://github.com/google/guice/wiki/Injections" title="Google Guice injectMembers">On-demand Injection</a>。此行代码执行之后，类中所需的依赖就应该会注入完毕。</p>
<p>可以看出，我对 Guice 和 Vert.x 的结合使用需要修改业务代码以插入注入代码，和项目耦合很深，不能很简单地应用到别的项目中。理想的情况下，在 Vert.x 的项目中嵌入 Guice，最好能：</p>
<ol>
<li>不侵入正常的 Verticle 代码，在正常的 Verticle 部署流程中自动创建所需的依赖并对目标 Verticle 实行依赖注入</li>
<li>依赖的提供者 （Guice <code>com.google.inject.Module</code>) 需要能比较方便的切换</li>
<li>不能影响 Vert.x 的异步流程，不能打破<a href="https://vertx.io/docs/vertx-core/java/#_don_t_block_me">黄金法则</a></li>
</ol>
<h1 id="vert-x-guice-extension"><a class="zola-anchor" href="#vert-x-guice-extension" aria-label="Anchor link for: vert-x-guice-extension">🔗</a>
Vert.x Guice Extension</h1>
<p><a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 是基于 <code>io.vertx.core.spi.VerticleFactory</code> 的扩展，能够无缝地接入 Vert.x 部署 Verticle 的过程中。</p>
<h2 id="usecase"><a class="zola-anchor" href="#usecase" aria-label="Anchor link for: usecase">🔗</a>
UseCase</h2>
<p>使用了 <a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 的项目中需要添加以下依赖：</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#808080;">&lt;</span><span style="color:#569cd6;">dependency</span><span style="color:#808080;">&gt;
</span><span style="color:#dcdcdc;">  </span><span style="color:#808080;">&lt;</span><span style="color:#569cd6;">groupId</span><span style="color:#808080;">&gt;</span><span style="color:#dcdcdc;">com.englishtown.vertx</span><span style="color:#808080;">&lt;/</span><span style="color:#569cd6;">groupId</span><span style="color:#808080;">&gt;
</span><span style="color:#dcdcdc;">  </span><span style="color:#808080;">&lt;</span><span style="color:#569cd6;">artifactId</span><span style="color:#808080;">&gt;</span><span style="color:#dcdcdc;">vertx-guice</span><span style="color:#808080;">&lt;/</span><span style="color:#569cd6;">artifactId</span><span style="color:#808080;">&gt;
</span><span style="color:#dcdcdc;">  </span><span style="color:#808080;">&lt;</span><span style="color:#569cd6;">version</span><span style="color:#808080;">&gt;</span><span style="color:#dcdcdc;">2.3.1</span><span style="color:#808080;">&lt;/</span><span style="color:#569cd6;">version</span><span style="color:#808080;">&gt;
</span><span style="color:#808080;">&lt;/</span><span style="color:#569cd6;">dependency</span><span style="color:#808080;">&gt;
</span></pre>
<p>然后正常实现所需要的 Verticle，不需要添加 Guice 相关代码（@Inject 等注解除外）。</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">public class TheVerticle extends AbstractVerticle {
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private static final Logger LOGGER = LoggerFactory.getLogger(TheVerticle.class);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Named(Constants.KEY_HTTP_LISTEN_HOST)
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private String listenIp;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Named(Constants.KEY_HTTP_LISTEN_PORT)
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private Integer listenPort = 8001;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@RegularRouter
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private Set&lt;Controller&gt; regularControllers;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Inject
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">private Set&lt;Runnable&gt; warmUps;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">public void start(final Future&lt;Void&gt; future) throws Exception {
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">// Not needed
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">// final Injector injector = Guice.createInjector(new TheModule(vertx, config()));
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">// injector.injectMembers(this);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">final Router router = Router.router(vertx);
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">router.exceptionHandler(ex -&gt; LOGGER.warn(&quot;Uncaught exception&quot;, ex));
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">regularControllers.stream().sorted().forEach(c -&gt; {
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">LOGGER.debug(&quot;Registered regular Controller \&quot;{}\&quot;&quot;, c);
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">c.accept(router);
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">});
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">Completable.fromRunnable(() -&gt; warmUps.parallelStream().forEach(Runnable::run))
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">.subscribeOn(RxHelper.blockingScheduler(vertx))
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">.subscribe(
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">() -&gt; {
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">LOGGER.info(&quot;Warm up finished, try to start HTTP listening on {}:{} ...&quot;, listenIp, listenPort);
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">vertx.createHttpServer()
</span><span style="color:#dcdcdc;">                        </span><span style="color:#dcdcdc;">.requestHandler(router::accept)
</span><span style="color:#dcdcdc;">                        </span><span style="color:#dcdcdc;">.listen(listenPort, listenIp, e -&gt; {
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">if (e.succeeded()) {
</span><span style="color:#dcdcdc;">                                </span><span style="color:#dcdcdc;">future.complete();
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">} else {
</span><span style="color:#dcdcdc;">                                </span><span style="color:#dcdcdc;">future.fail(e.cause());
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">                        </span><span style="color:#dcdcdc;">});
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">},
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">ex -&gt; {
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">LOGGER.error(&quot;Warmup failed, disable HTTP listening&quot;, ex);
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">future.fail(ex);
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">}
</span></pre>
<p>提供服务中所需的依赖：</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#569cd6;">class </span><span style="color:#dcdcdc;">TheModule </span><span style="color:#569cd6;">extends </span><span style="color:#4ec9b0;">AbstractModule </span><span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">protected void </span><span style="color:#dcdcdc;">configure() {
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">install(</span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">RestModule());
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">install(</span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">AuthModule());
</span><span style="color:#dcdcdc;">        </span><span style="color:#608b4e;">// And more ...
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">bind(MyService.class).to(MyServiceImpl.class);
</span><span style="color:#dcdcdc;">        </span><span style="color:#608b4e;">// And more ...
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Provides
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Singleton
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">private </span><span style="color:#dcdcdc;">OtherService providesOtherService(</span><span style="color:#569cd6;">final </span><span style="color:#dcdcdc;">MyService s) {
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">return new </span><span style="color:#dcdcdc;">OtherServiceImpl(s);
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">}
</span></pre>
<p>TheVerticle 和 TheModule 的结合代码由 <a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 提供，使用者只需要修改 Verticle 的部署代码为：</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">Vertx.vertx().deployVerticle(
</span><span style="color:#dcdcdc;">    </span><span style="color:#d69d85;">&quot;java-guice:&quot; </span><span style="color:#dcdcdc;">+ TheVerticle.class.getName(),
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">DeploymentOptions()
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">.setConfig(</span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">JsonObject().put(</span><span style="color:#d69d85;">&quot;guice_binder&quot;</span><span style="color:#dcdcdc;">, TheModule.class.getName()))
</span><span style="color:#dcdcdc;">);
</span></pre>
<p>作为对比，之前的部署代码为：</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#dcdcdc;">Vertx.vertx().deployVerticle(TheVerticle.class.getName());
</span></pre>
<p>变化之处有两点：</p>
<ol>
<li>Verticle 的名称由原来的 Verticle 类名变为类名加前缀 &quot;java-guice:&quot;</li>
<li>部署时需要附带上一个指向 Module 的依赖提供者实现的配置项，配置项的键名为 &quot;guice_binder&quot;，值为依赖提供者的类名（如果不想添加此配置项，则需要将依赖提供者的类名设置为固定的 ”com.englishtown.vertx.guice.BootstrapBinder&quot;）</li>
</ol>
<h2 id="verticlefactory"><a class="zola-anchor" href="#verticlefactory" aria-label="Anchor link for: verticlefactory">🔗</a>
VerticleFactory</h2>
<p><a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 基于前缀 &quot;java-guice:&quot; 的功能扩展依赖于 Vert.x 的 <code>io.vertx.core.spi.VerticleFactory</code> SPI 机制。</p>
<p>Vert.x 是根据 Verticle 的名称来进行部署的。由于需要支持不同语言的 Verticle 实现（Java, JavaScript, Ruby 等)，Vert.x 对于 Verticle 的创建提供了扩展点 <code>io.vertx.core.spi.VerticleFactory</code>。Vert.x 管理不同类型的 VerticleFactory 实现，使用类 scheme 的前缀（prefix）规则区分 Verticle 名称；不同的 VerticleFactory 实现根据 Verticle 名称的前缀来确定是否能创建该 Verticle。</p>
<p>相关内容可参见 <a href="https://vertx.io/docs/vertx-core/java/#_deploying_verticles_programmatically" title="Deploying verticles programmatically">Vert.x Vertivle Deployment</a>。</p>
<p>Vert.x 官方支持的 Verticle 名称前缀有：</p>
<ul>
<li>&quot;js:&quot; 用于创建使用 JavaScript 编写的 Verticle</li>
<li>&quot;groovy:&quot; 用于创建使用 Groovy 编写的 Verticle</li>
<li>&quot;service:&quot; 用于创建 <a href="http://vertx.io/docs/vertx-service-factory/java/" title="Eclipse Vert.x Service Factory">Vert.x Service</a> 服务</li>
<li>等</li>
</ul>
<p>如果提供的 Verticle 名称没有前缀，Vert.x 会根据后缀名来确定对应的 VerticleFactory；如果没有后缀名，则会默认作为 Java 实现来创建。</p>
<h2 id="guiceverticlefactory"><a class="zola-anchor" href="#guiceverticlefactory" aria-label="Anchor link for: guiceverticlefactory">🔗</a>
GuiceVerticleFactory</h2>
<p>在 <a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 中，提供了一个 <code>io.vertx.core.spi.VerticleFactory</code> 的实现类 <code>com.englishtown.vertx.guice.GuiceVerticleFactory</code>，提供对于 &quot;java-guice:&quot; 前缀名称的创建支持。</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#569cd6;">public class </span><span style="color:#dcdcdc;">GuiceVerticleFactory </span><span style="color:#569cd6;">implements </span><span style="color:#4ec9b0;">VerticleFactory </span><span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public static final </span><span style="color:#dcdcdc;">String PREFIX = </span><span style="color:#d69d85;">&quot;java-guice&quot;</span><span style="color:#dcdcdc;">;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public </span><span style="color:#dcdcdc;">String prefix() {
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">return </span><span style="color:#b4cea8;">PREFIX</span><span style="color:#dcdcdc;">;
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public </span><span style="color:#dcdcdc;">Verticle createVerticle(String verticleName, ClassLoader classLoader) </span><span style="color:#569cd6;">throws </span><span style="color:#dcdcdc;">Exception {
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">verticleName = VerticleFactory.removePrefix(verticleName);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#608b4e;">// Use the provided class loader to create an instance of GuiceVerticleLoader.  This is necessary when working with vert.x IsolatingClassLoader
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">@SuppressWarnings(</span><span style="color:#d69d85;">&quot;unchecked&quot;</span><span style="color:#dcdcdc;">)
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">Class&lt;Verticle&gt; loader = (Class&lt;Verticle&gt;) classLoader.loadClass(GuiceVerticleLoader.class.getName());
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">Constructor&lt;Verticle&gt; ctor = loader.getConstructor(String.class, ClassLoader.class, Injector.class);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">if </span><span style="color:#dcdcdc;">(ctor == </span><span style="color:#569cd6;">null</span><span style="color:#dcdcdc;">) {
</span><span style="color:#dcdcdc;">            </span><span style="color:#569cd6;">throw new </span><span style="color:#dcdcdc;">IllegalStateException(</span><span style="color:#d69d85;">&quot;Could not find GuiceVerticleLoader constructor&quot;</span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">return</span><span style="color:#dcdcdc;"> ctor.newInstance(verticleName, classLoader, getInjector());
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">}
</span></pre>
<p>在 GuiceVerticleFactory 的 <code>createVerticle</code> 实现中，使用了 <code>com.englishtown.vertx.guice.GuiceVertileLoader</code> 类。该类是 Verticle 的一个实现，用来辅助创建目标 Verticle 并代理目标 Verticle 的生命周期管理。</p>
<pre style="background-color:#1e1e1e;">
<span style="color:#569cd6;">public class </span><span style="color:#dcdcdc;">GuiceVerticleLoader </span><span style="color:#569cd6;">extends </span><span style="color:#4ec9b0;">AbstractVerticle </span><span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public static final </span><span style="color:#dcdcdc;">String CONFIG_BOOTSTRAP_BINDER_NAME = </span><span style="color:#d69d85;">&quot;guice_binder&quot;</span><span style="color:#dcdcdc;">;
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public static final </span><span style="color:#dcdcdc;">String BOOTSTRAP_BINDER_NAME = </span><span style="color:#d69d85;">&quot;com.englishtown.vertx.guice.BootstrapBinder&quot;</span><span style="color:#dcdcdc;">;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">private </span><span style="color:#dcdcdc;">Verticle realVerticle;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public void </span><span style="color:#dcdcdc;">init(Vertx vertx, Context context) {
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">super.init(vertx, context);
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#608b4e;">// Create the real verticle and init
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">realVerticle = createRealVerticle();
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">realVerticle.init(vertx, context);
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public void </span><span style="color:#dcdcdc;">start(Future&lt;Void&gt; startedResult) </span><span style="color:#569cd6;">throws </span><span style="color:#dcdcdc;">Exception {
</span><span style="color:#dcdcdc;">        </span><span style="color:#608b4e;">// Start the real verticle
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">realVerticle.start(startedResult);
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">@Override
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">public void </span><span style="color:#dcdcdc;">stop(Future&lt;Void&gt; stopFuture) </span><span style="color:#569cd6;">throws </span><span style="color:#dcdcdc;">Exception {
</span><span style="color:#dcdcdc;">        </span><span style="color:#608b4e;">// Stop the real verticle
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">if </span><span style="color:#dcdcdc;">(realVerticle != </span><span style="color:#569cd6;">null</span><span style="color:#dcdcdc;">) {
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">realVerticle.stop(stopFuture);
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">realVerticle = </span><span style="color:#569cd6;">null</span><span style="color:#dcdcdc;">;
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">    </span><span style="color:#569cd6;">private </span><span style="color:#dcdcdc;">Verticle createRealVerticle(Class&lt;</span><span style="color:#569cd6;">?</span><span style="color:#dcdcdc;">&gt; clazz) </span><span style="color:#569cd6;">throws </span><span style="color:#dcdcdc;">Exception {
</span><span style="color:#dcdcdc;">        </span><span style="color:#608b4e;">// i.e., &quot;guice_binder&quot;
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">Object field = config.getValue(</span><span style="color:#b4cea8;">CONFIG_BOOTSTRAP_BINDER_NAME</span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">jsonArray bootstrapNames;
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">if </span><span style="color:#dcdcdc;">(field </span><span style="color:#569cd6;">instanceof </span><span style="color:#dcdcdc;">JsonArray) {
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">bootstrapNames = (JsonArray) field;
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">} </span><span style="color:#569cd6;">else </span><span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">            </span><span style="color:#608b4e;">// i.e., &quot;com.englishtown.vertx.guice.BootstrapBinder&quot;
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">bootstrapNames = </span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">JsonArray().add((field == </span><span style="color:#569cd6;">null ? </span><span style="color:#b4cea8;">BOOTSTRAP_BINDER_NAME </span><span style="color:#569cd6;">:</span><span style="color:#dcdcdc;"> field));
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">List&lt;Module&gt; bootstraps = </span><span style="color:#569cd6;">new </span><span style="color:#dcdcdc;">ArrayList&lt;&gt;();
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">for </span><span style="color:#dcdcdc;">(</span><span style="color:#569cd6;">int</span><span style="color:#dcdcdc;"> i = </span><span style="color:#b5cea8;">0</span><span style="color:#dcdcdc;">; i &lt; bootstrapNames.size(); i</span><span style="color:#569cd6;">++</span><span style="color:#dcdcdc;">) {
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">String bootstrapName = bootstrapNames.getString(i);
</span><span style="color:#dcdcdc;">            </span><span style="color:#569cd6;">try </span><span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">Class bootstrapClass = classLoader.loadClass(bootstrapName);
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">Object obj = bootstrapClass.newInstance();
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">                </span><span style="color:#569cd6;">if </span><span style="color:#dcdcdc;">(obj </span><span style="color:#569cd6;">instanceof </span><span style="color:#dcdcdc;">Module) {
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">bootstraps.add((Module) obj);
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">} </span><span style="color:#569cd6;">else </span><span style="color:#dcdcdc;">{
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">logger.error(</span><span style="color:#d69d85;">&quot;Class &quot; </span><span style="color:#dcdcdc;">+ bootstrapName
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">+ </span><span style="color:#d69d85;">&quot; does not implement Module.&quot;</span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">} </span><span style="color:#569cd6;">catch </span><span style="color:#dcdcdc;">(ClassNotFoundException e) {
</span><span style="color:#dcdcdc;">                </span><span style="color:#569cd6;">if </span><span style="color:#dcdcdc;">(parent == </span><span style="color:#569cd6;">null</span><span style="color:#dcdcdc;">) {
</span><span style="color:#dcdcdc;">                    </span><span style="color:#dcdcdc;">logger.warn(</span><span style="color:#d69d85;">&quot;Guice bootstrap binder class &quot; </span><span style="color:#dcdcdc;">+ bootstrapName
</span><span style="color:#dcdcdc;">                            </span><span style="color:#dcdcdc;">+ </span><span style="color:#d69d85;">&quot; was not found.  Are you missing injection bindings?&quot;</span><span style="color:#dcdcdc;">);
</span><span style="color:#dcdcdc;">                </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">            </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">
</span><span style="color:#dcdcdc;">        </span><span style="color:#dcdcdc;">Injector injector = parent == </span><span style="color:#569cd6;">null ? </span><span style="color:#dcdcdc;">Guice.createInjector(bootstraps) </span><span style="color:#569cd6;">:</span><span style="color:#dcdcdc;"> parent.createChildInjector(bootstraps);
</span><span style="color:#dcdcdc;">        </span><span style="color:#569cd6;">return </span><span style="color:#dcdcdc;">(Verticle) injector.getInstance(clazz);
</span><span style="color:#dcdcdc;">    </span><span style="color:#dcdcdc;">}
</span><span style="color:#dcdcdc;">}
</span></pre>
<p>在 Verticle 的创建逻辑中，会首先尝试获取键 &quot;guice_binder&quot; 对应的配置项值，该配置项的值可以是全类名字符串或者全类名字符串数组；如果不配置的话，则会默认使用 &quot;com.englishtown.vertx.guice.BootstrapBinder&quot; 作为配置项的值。之后使用该值使用反射创建类实例；再然后使用该实例创建注入器；再然后从注入器中请求目标类名的 Verticle 注入结果实例并返回。</p>
<p>所以只需要把所有的依赖以及指定名称的 Verticle 实现的提供者（<code>com.google.inject.Module</code> 实现类）的全类名作为值，以 &quot;guice_binder&quot; 为键放入到部署参数配置里面，就可以自动生成一个注入器了。或者，在不提供该键值对的情况下，将依赖提供者实现命名为 &quot;com.englishtown.vertx.guice.BootstrapBinder&quot; 也可以达到相同的效果。</p>
<h1 id="zong-jie"><a class="zola-anchor" href="#zong-jie" aria-label="Anchor link for: zong-jie">🔗</a>
总结</h1>
<p><a href="https://github.com/ef-labs/vertx-guice" title="Google Guice">Vert.x Guice Extension</a> 的实现充分利用了 Vert.x 的扩展机制，解耦合了 Verticle 的实现和依赖注入，思路非常漂亮。对于功能的添加又很克制，没有尝试去实现其他没有必要的 auto-wired、package scanning 等功能（如果需要这些功能，为什么不直接使用 <a href="https://spring.io">Spring Framework</a> 呢？）。</p>
<p>以上</p>

        </div>
        
    
</div></div>
            
    <div class="pagination">
        <div class="pagination__buttons">
            </div>
    </div>
<footer class="footer">
                    <div class="footer__inner"><div class="copyright copyright--user"><span>© 2019 <a href="https://www.wangbo.im">wangbo&apos; blog</a> :: <a href="https://github.wangbo.im">Github</a> :: Powered by <a href="https://www.getzola.org/">Zola</a></span></div>
    <script type="text/javascript" src="https:&#x2F;&#x2F;www.wangbo.im&#x2F;assets&#x2F;js&#x2F;main.js"></script>
</div>
                    

                </footer></div>
    </body>
</html>
