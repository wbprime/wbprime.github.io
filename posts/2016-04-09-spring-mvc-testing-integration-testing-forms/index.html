<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Spring MVC Integration Testing - Forms</title>
        <style>

    html body {
        font-family: Raleway, sans-serif;
        background-color: white;
    }

    :root {
        --accent: lightseagreen;
        --border-width:  0 ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c&#43;&#43;.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.49" />
        
    </head>

    <body>

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Spring MVC Integration Testing - Forms</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/posts/">Posts</a></li>
                            
                                <li><a href="/categories/">Categories</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="https://github.com/wbprime/"><i class="fa fa-github"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/posts/2016-04-09-spring-mvc-testing-integration-testing-forms/">Spring MVC Integration Testing - Forms</a></h4>
    <h5>April 9, 2016</h5>
     <kbd class="item-tag">Spring MVC</kbd>  <kbd class="item-tag">testing</kbd>  <kbd class="item-tag">java</kbd> 

</div>


    <br> <div class="text-justify">

<p>本文是 <a href="/2016/04/09/spring-mvc-testing-content/">Spring MVC Testing</a> 集成测试系列的第3篇，原文链接：<a href="http://www.petrikainulainen.net/programming/spring-framework/integration-testing-of-spring-mvc-applications-forms/">Integration Testing of Spring MVC Applications: Forms</a>。</p>

<p>本文主要介绍为处理Form表单请求的接口编写集成测试用例。</p>

<p>本文紧接着上一篇 <a href="/2016/04/09/spring-mvc-testing-integration-testing-controllers/">Spring MVC Integration Testing - Controllers</a> 的内容，主要涉及到两个接口：创建新的Todo项和更新指定的Todo项。</p>

<!-- More -->

<h1 id="通过maven获取依赖">通过Maven获取依赖</h1>

<p>除了上一篇中介绍的依赖之外，本文添加了新的依赖：</p>

<ul>
<li>jackson-core-asl 1.9.9</li>
<li>jackson-mapper-asl 1.9.9</li>
</ul>

<p>对应的pom.xml文件片段如下：</p>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;org.codehaus.jackson&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-core-asl&lt;/artifactId&gt;
    &lt;version&gt;1.9.9&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.codehaus.jackson&lt;/groupId&gt;
    &lt;artifactId&gt;jackson-mapper-asl&lt;/artifactId&gt;
    &lt;version&gt;1.9.9&lt;/version&gt;
    &lt;scope&gt;test&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>

<h1 id="示例web应用结构">示例web应用结构</h1>

<h2 id="dto">DTO</h2>

<p>本文主要处理Form表单，对应的类为<code>TodoDTO</code>。<code>TodoDTO</code>类是一个简单的Java Bean类，除了setter和getter方法外，还是用到了validator规则：</p>

<ul>
<li>title项不能为空</li>
<li>title项的最大长度为100</li>
<li>description项的最大长度为500</li>
</ul>

<p>对应的代码如下：</p>

<pre><code class="language-java">import org.hibernate.validator.constraints.Length;
import org.hibernate.validator.constraints.NotEmpty;
 
public class TodoDTO {
 
    private Long id;
 
    @Length(max = 500)
    private String description;
 
    @NotEmpty
    @Length(max = 100)
    private String title;
 
    public TodoDTO() {
 
    }
 
    //Getters and setters
}
</code></pre>

<h2 id="service-层">Service 层</h2>

<p>对应地，<code>TodoService</code>接口也添加了两个方法：</p>

<ul>
<li><code>Todo add(TodoDTO added)</code> 创建并返回Todo项</li>
<li><code>Todo update(TodoDTO updated)</code> 更新指定的Todo项；如果指定的Todo项不存在，则抛出<code>TodoNotFoundException</code>异常</li>
</ul>

<p>新增代码如下：</p>

<pre><code class="language-java">public interface TodoService {
 
    public Todo add(TodoDTO added);
 
    public Todo update(TodoDTO updated) throws TodoNotFoundException;
}
</code></pre>

<h2 id="controller-层">Controller 层</h2>

<p>对应地，<code>TodoController</code>类也增加了4个接口方法：</p>

<ul>
<li><code>showAddTodoForm()</code> GET 返回添加Todo项的表单页面</li>
<li><code>add()</code> POST 处理添加Todo项的表单请求</li>
<li><code>showUpdateTodoForm()</code> GET 返回修改Todo项的表单页面</li>
<li><code>update()</code> POST 处理修改Todo项的表单请求</li>
</ul>

<p>对应的代码如下：</p>

<pre><code class="language-java">import org.springframework.context.MessageSource;
import org.springframework.context.i18n.LocaleContextHolder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
 
import javax.annotation.Resource;
import javax.validation.Valid;
 
@Controller
@SessionAttributes(&quot;todo&quot;)
public class TodoController {
 
    @Resource
    private TodoService service;
 
    @Resource
    private MessageSource messageSource;
 
    @RequestMapping(value = &quot;/todo/add&quot;, method = RequestMethod.GET)
    public String showAddTodoForm(Model model) {
        TodoDTO formObject = new TodoDTO();
        model.addAttribute(&quot;todo&quot;, formObject);
 
        return &quot;todo/add&quot;;
    }
 
    @RequestMapping(value = &quot;/todo/add&quot;, method = RequestMethod.POST)
    public String add(@Valid @ModelAttribute(&quot;todo&quot;) TodoDTO dto, BindingResult result, RedirectAttributes attributes) {
        if (result.hasErrors()) {
            return &quot;todo/add&quot;;
        }
 
        Todo added = service.add(dto);
 
        addFeedbackMessage(attributes, &quot;feedback.message.todo.added&quot;, added.getTitle());
        attributes.addAttribute(&quot;id&quot;, added.getId());
 
        return createRedirectViewPath(&quot;/todo/{id}&quot;);
    }
 
    @RequestMapping(value = &quot;/todo/update/{id}&quot;, method = RequestMethod.GET)
    public String showUpdateTodoForm(@PathVariable(&quot;id&quot;) Long id, Model model) throws TodoNotFoundException {
        Todo updated = service.findById(id);
 
        TodoDTO formObject = constructFormObjectForUpdateForm(updated);
        model.addAttribute(&quot;todo&quot;, formObject);
 
        return &quot;todo/update&quot;;
    }
 
    @RequestMapping(value = &quot;/todo/update&quot;, method = RequestMethod.POST)
    public String update(@Valid @ModelAttribute(&quot;todo&quot;) TodoDTO dto, BindingResult result, RedirectAttributes attributes) throws TodoNotFoundException {
        if (result.hasErrors()) {
            return &quot;todo/update&quot;;
        }
 
        Todo updated = service.update(dto);
 
        addFeedbackMessage(attributes, &quot;feedback.message.todo.updated&quot;, updated.getTitle());
        attributes.addAttribute(&quot;id&quot;, updated.getId());
 
        return createRedirectViewPath(&quot;/todo/{id}&quot;);
    }
 
    private TodoDTO constructFormObjectForUpdateForm(Todo updated) {
        TodoDTO dto = new TodoDTO();
 
        dto.setId(updated.getId());
        dto.setDescription(updated.getDescription());
        dto.setTitle(updated.getTitle());
 
        return dto;
    }
 
    private void addFeedbackMessage(RedirectAttributes attributes, String messageCode, Object... messageParameters) {
        String localizedFeedbackMessage = getMessage(messageCode, messageParameters);
        attributes.addFlashAttribute(&quot;feedbackMessage&quot;, localizedFeedbackMessage);
    }
 
    private String getMessage(String messageCode, Object... messageParameters) {
        Locale current = LocaleContextHolder.getLocale();
        return messageSource.getMessage(messageCode, messageParameters, current);
    }
 
 
    private String createRedirectViewPath(String requestMapping) {
        StringBuilder redirectViewPath = new StringBuilder();
        redirectViewPath.append(&quot;redirect:&quot;);
        redirectViewPath.append(requestMapping);
        return redirectViewPath.toString();
    }
}
</code></pre>

<h1 id="添加测试用例">添加测试用例</h1>

<h2 id="get-添加todo项表单页面接口">GET 添加Todo项表单页面接口</h2>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/add&rdquo;的GET请求，并取得返回的响应结果</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’todo/add’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/todo/add.jsp”</li>
<li>对返回的响应结果作断言：model中Todo项各个字段均为空</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void showAddTodoForm() throws Exception {
        mockMvc.perform(get(&quot;/todo/add&quot;))
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;todo/add&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/todo/add.jsp&quot;))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;id&quot;, nullValue())))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;description&quot;, isEmptyOrNullString())))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;title&quot;, isEmptyOrNullString())));
    }
}
</code></pre>

<p>代码中使用到的<code>todoData.xml</code>文件内容如下：</p>

<pre><code class="language-xml">&lt;dataset&gt;
    &lt;todos id=&quot;1&quot; creation_time=&quot;2012-10-21 11:13:28&quot; description=&quot;Lorem ipsum&quot; modification_time=&quot;2012-10-21 11:13:28&quot; title=&quot;Foo&quot; version=&quot;0&quot;/&gt;
    &lt;todos id=&quot;2&quot; creation_time=&quot;2012-10-21 11:13:28&quot; description=&quot;Lorem ipsum&quot; modification_time=&quot;2012-10-21 11:13:28&quot; title=&quot;Bar&quot; version=&quot;0&quot;/&gt;
&lt;/dataset&gt;
</code></pre>

<h2 id="post-添加todo项表单处理接口">POST 添加Todo项表单处理接口</h2>

<p>处理一个添加Todo项的表单请求，可能会有3种处理结果：</p>

<ul>
<li>表单提交的Todo项为空，添加失败，返回错误提示</li>
<li>表单提交的Todo项的title/description字段值长度不合法，添加失败，返回错误提示</li>
<li>表单提交的Todo项各个字段合法，添加成功</li>
</ul>

<p>下面来分别编写测试用例。</p>

<h3 id="提交空表单">提交空表单</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/add&rdquo;的POST请求，并取得返回的响应结果：Content-type 设置为&rdquo;application/x-www-form-urlencoded&rdquo;</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’todo/add’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/todo/add.jsp”</li>
<li>对返回的响应结果作断言：model中存在预期的错误提示信息</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void addEmptyTodo() throws Exception {
        mockMvc.perform(post(&quot;/todo/add&quot;)
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .sessionAttr(&quot;todo&quot;, new TodoDTO())
        )
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;todo/add&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/todo/add.jsp&quot;))
                .andExpect(model().attributeHasFieldErrors(&quot;todo&quot;, &quot;title&quot;))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;id&quot;, nullValue())))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;description&quot;, isEmptyOrNullString())))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;title&quot;, isEmptyOrNullString())));
    }
}
</code></pre>

<h3 id="表单验证失败">表单验证失败</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/add&rdquo;的POST请求，并取得返回的响应结果：Content-type 设置为&rdquo;application/x-www-form-urlencoded&rdquo;</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’todo/add’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/todo/add.jsp”</li>
<li>对返回的响应结果作断言：model中存在预期的错误提示信息</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void addTodoWhenTitleAndDescriptionAreTooLong() throws Exception {
        String title = TodoTestUtil.createStringWithLength(101);
        String description = TodoTestUtil.createStringWithLength(501);
 
        mockMvc.perform(post(&quot;/todo/add&quot;)
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .param(&quot;description&quot;, description)
                .param(&quot;title&quot;, title)
                .sessionAttr(&quot;todo&quot;, new TodoDTO())
        )
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;todo/add&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/todo/add.jsp&quot;))
                .andExpect(model().attributeHasFieldErrors(&quot;todo&quot;, &quot;title&quot;))
                .andExpect(model().attributeHasFieldErrors(&quot;todo&quot;, &quot;description&quot;))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;id&quot;, nullValue())))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;description&quot;, is(description))))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;title&quot;, is(title))));
    }
}
</code></pre>

<h3 id="表单被正确处理">表单被正确处理</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口往数据库中写入了一条记录</li>
<li>模拟执行&rdquo;/todo/add&rdquo;的POST请求，并取得返回的响应结果：Content-type 设置为&rdquo;application/x-www-form-urlencoded&rdquo;</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’redirect:/todo/view/{id}’</li>
<li>对返回的响应结果作断言：model中返回的Todo项的id值为3</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import com.github.springtestdbunit.assertion.DatabaseAssertionMode;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.is;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(value=&quot;toDoData-add-expected.xml&quot;, assertionMode = DatabaseAssertionMode.NON_STRICT)
    public void addTodo() throws Exception {
        mockMvc.perform(post(&quot;/todo/add&quot;)
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .param(&quot;description&quot;, &quot;description&quot;)
                .param(&quot;title&quot;, &quot;title&quot;)
                .sessionAttr(&quot;todo&quot;, new TodoDTO())
        )
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;redirect:/todo/view/{id}&quot;))
                .andExpect(model().attribute(&quot;id&quot;, is(&quot;3&quot;)))
                .andExpect(flash().attribute(&quot;feedbackMessage&quot;, is(&quot;Todo entry: title was added.&quot;)));
    }
}
</code></pre>

<h2 id="get-修改todo项表单页面接口">GET 修改Todo项表单页面接口</h2>

<p>根据参数的不同，该请求会返回不同的结果：</p>

<ul>
<li>如果指定的Todo项被找到，返回修改页面</li>
<li>如果指定的Todo项未找到，返回404页面</li>
</ul>

<p>下面来分别编写测试用例。</p>

<h3 id="指定todo项被找到">指定Todo项被找到</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/update/1&rdquo;的GET请求，并取得返回的响应结果</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’todo/update’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/todo/update.jsp”</li>
<li>对返回的响应结果作断言：model中存在预期的错误提示信息</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void showUpdateTodoForm() throws Exception {
        mockMvc.perform(get(&quot;/todo/update/{id}&quot;, 1L))
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;todo/update&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/todo/update.jsp&quot;))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;id&quot;, is(1L))))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;description&quot;, is(&quot;Lorem ipsum&quot;))))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;title&quot;, is(&quot;Foo&quot;))));
    }
}
</code></pre>

<h3 id="指定todo项未找到">指定Todo项未找到</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/update/3&rdquo;的GET请求，并取得返回的响应结果</li>
<li>对返回的响应结果作断言：HTTP状态码为404</li>
<li>对返回的响应结果作断言：view的名字是’error/404’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/error/404.jsp”</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.get;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void showUpdateTodoFormWhenTodoIsNotFound() throws Exception {
        mockMvc.perform(get(&quot;/todo/update/{id}&quot;, 3L))
                .andExpect(status().isNotFound())
                .andExpect(view().name(&quot;error/404&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/error/404.jsp&quot;));
    }
}
</code></pre>

<h2 id="post-修改todo项表单处理接口">POST 修改Todo项表单处理接口</h2>

<p>处理一个修改Todo项的表单请求，可能会有以下4个结果：</p>

<ul>
<li>表单里的Todo项为空，修改失败，返回错误信息</li>
<li>表单里的Todo项参数不合法，修改失败，返回错误信息</li>
<li>表单里指定的Todo项被正确修改</li>
<li>表单里指定的Todo项不存在，修改失败</li>
</ul>

<p>下面来分别编写测试用例。</p>

<h3 id="提交空表单-1">提交空表单</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/update&rdquo;的POST请求，并取得返回的响应结果：Content-type 设置为&rdquo;application/x-www-form-urlencoded&rdquo;</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’todo/update’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/todo/update.jsp”</li>
<li>对返回的响应结果作断言：model中存在预期的错误提示信息</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void updateEmptyTodo() throws Exception {
        mockMvc.perform(post(&quot;/todo/update&quot;)
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .param(&quot;id&quot;, &quot;1&quot;)
                .sessionAttr(&quot;todo&quot;, new TodoDTO())
        )
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;todo/update&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/todo/update.jsp&quot;))
                .andExpect(model().attributeHasFieldErrors(&quot;todo&quot;, &quot;title&quot;))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;id&quot;, is(1L))))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;description&quot;, isEmptyOrNullString())))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;title&quot;, isEmptyOrNullString())));
    }
}
</code></pre>

<h3 id="表单验证失败-1">表单验证失败</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/update&rdquo;的POST请求，并取得返回的响应结果：Content-type 设置为&rdquo;application/x-www-form-urlencoded&rdquo;</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’todo/update’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/todo/update.jsp”</li>
<li>对返回的响应结果作断言：model中存在预期的错误提示信息</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.*;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void updateTodoWhenTitleAndDescriptionAreTooLong() throws Exception {
        String title = TodoTestUtil.createStringWithLength(101);
        String description = TodoTestUtil.createStringWithLength(501);
 
        mockMvc.perform(post(&quot;/todo/update&quot;)
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .param(&quot;description&quot;, description)
                .param(&quot;id&quot;, &quot;1&quot;)
                .param(&quot;title&quot;, title)
                .sessionAttr(&quot;todo&quot;, new TodoDTO())
        )
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;todo/update&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/todo/update.jsp&quot;))
                .andExpect(model().attributeHasFieldErrors(&quot;todo&quot;, &quot;title&quot;))
                .andExpect(model().attributeHasFieldErrors(&quot;todo&quot;, &quot;description&quot;))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;id&quot;, is(1L))))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;description&quot;, is(description))))
                .andExpect(model().attribute(&quot;todo&quot;, hasProperty(&quot;title&quot;, is(title))));
    }
}
</code></pre>

<h3 id="表单被正确处理-1">表单被正确处理</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口修改了数据库的一条数据</li>
<li>模拟执行&rdquo;/todo/update&rdquo;的POST请求，并取得返回的响应结果：Content-type 设置为&rdquo;application/x-www-form-urlencoded&rdquo;</li>
<li>对返回的响应结果作断言：HTTP状态码为200</li>
<li>对返回的响应结果作断言：view的名字是’redirect:/todo/view/{id}’</li>
<li>对返回的响应结果作断言：model中返回的Todo项的id值为1</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import com.github.springtestdbunit.assertion.DatabaseAssertionMode;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.hamcrest.Matchers.is;
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(value=&quot;toDoData-update-expected.xml&quot;, assertionMode = DatabaseAssertionMode.NON_STRICT)
    public void updateTodo() throws Exception {
        mockMvc.perform(post(&quot;/todo/update&quot;)
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .param(&quot;description&quot;, &quot;description&quot;)
                .param(&quot;id&quot;, &quot;1&quot;)
                .param(&quot;title&quot;, &quot;title&quot;)
                .sessionAttr(&quot;todo&quot;, new TodoDTO())
        )
                .andExpect(status().isOk())
                .andExpect(view().name(&quot;redirect:/todo/view/{id}&quot;))
                .andExpect(model().attribute(&quot;id&quot;, is(&quot;1&quot;)))
                .andExpect(flash().attribute(&quot;feedbackMessage&quot;, is(&quot;Todo entry: title was updated.&quot;)));
    }
}
</code></pre>

<p>进行数据库验证的<code>toDoData-update-expected.xml</code>文件的内容如下：</p>

<pre><code class="language-xml">&lt;dataset&gt;
    &lt;todos id=&quot;1&quot; description=&quot;description&quot; title=&quot;title&quot; version=&quot;1&quot;/&gt;
    &lt;todos id=&quot;2&quot; description=&quot;Lorem ipsum&quot; title=&quot;Bar&quot; version=&quot;0&quot;/&gt;
&lt;/dataset&gt;
</code></pre>

<h3 id="指定todo项未找到-1">指定Todo项未找到</h3>

<p>添加测试用例的思路如下：</p>

<ol>
<li>使用@ExpectedDatabase注解来验证接口没有对数据库表状态产生变化</li>
<li>模拟执行&rdquo;/todo/update&rdquo;的POST请求，并取得返回的响应结果：Content-type 设置为&rdquo;application/x-www-form-urlencoded&rdquo;</li>
<li>对返回的响应结果作断言：HTTP状态码为404</li>
<li>对返回的响应结果作断言：view的名字是’error/404’</li>
<li>对返回的响应结果作断言：view的路径为”/WEB-INF/jsp/error/404.jsp”</li>
</ol>

<p>最终代码如下：</p>

<pre><code class="language-java">import com.github.springtestdbunit.DbUnitTestExecutionListener;
import com.github.springtestdbunit.annotation.DatabaseSetup;
import com.github.springtestdbunit.annotation.ExpectedDatabase;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.springframework.http.MediaType;
import org.springframework.test.context.ContextConfiguration;
import org.springframework.test.context.TestExecutionListeners;
import org.springframework.test.context.junit4.SpringJUnit4ClassRunner;
import org.springframework.test.context.support.DependencyInjectionTestExecutionListener;
import org.springframework.test.context.support.DirtiesContextTestExecutionListener;
import org.springframework.test.context.transaction.TransactionalTestExecutionListener;
import org.springframework.test.web.server.MockMvc;
import org.springframework.test.web.server.samples.context.WebContextLoader;
 
import static org.springframework.test.web.server.request.MockMvcRequestBuilders.post;
import static org.springframework.test.web.server.result.MockMvcResultMatchers.*;
 
@RunWith(SpringJUnit4ClassRunner.class)
@ContextConfiguration(loader = WebContextLoader.class, classes = {ExampleApplicationContext.class})
@TestExecutionListeners({ DependencyInjectionTestExecutionListener.class,
        DirtiesContextTestExecutionListener.class,
        TransactionalTestExecutionListener.class,
        DbUnitTestExecutionListener.class })
@DatabaseSetup(&quot;toDoData.xml&quot;)
public class ITTodoControllerTest {
 
    //Add web application context here
 
    private MockMvc mockMvc;
 
    //Add setUp() method here
 
    @Test
    @ExpectedDatabase(&quot;toDoData.xml&quot;)
    public void updateTodoWhenTodoIsNotFound() throws Exception {
        mockMvc.perform(post(&quot;/todo/update&quot;)
                .contentType(MediaType.APPLICATION_FORM_URLENCODED)
                .param(&quot;description&quot;, &quot;description&quot;)
                .param(&quot;id&quot;, &quot;3&quot;)
                .param(&quot;title&quot;, &quot;title&quot;)
                .sessionAttr(&quot;todo&quot;, new TodoDTO())
        )
                .andExpect(status().isNotFound())
                .andExpect(view().name(&quot;error/404&quot;))
                .andExpect(forwardedUrl(&quot;/WEB-INF/jsp/error/404.jsp&quot;));
    }
}
</code></pre>

<h1 id="总结">总结</h1>

<p>本文主要介绍了如何编写集成测试用例测试表单处理接口，要点如下：</p>

<ul>
<li>如何指定请求的content type</li>
<li>如何模拟表单请求</li>
<li>如何在Session中添加数据</li>
<li>如何检测响应数据中包含了错误提示信息</li>
</ul>

<p>下一篇是 <a href="/2016/04/09/spring-mvc-testing-integration-testing-rest-api/">Spring MVC Integration Testing - REST API</a>。</p>
</div>

    
    

    

    

        <h4 class="page-header">Comments</h4>

        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "wbprime" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a></p>

        </footer>

    </body>

</html>

