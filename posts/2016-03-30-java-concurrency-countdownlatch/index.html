<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Learning Java Concurrency - CountDownLatch</title>
        <style>

    html body {
        font-family: Raleway, sans-serif;
        background-color: white;
    }

    :root {
        --accent: lightseagreen;
        --border-width:  0 ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c&#43;&#43;.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.26" />
        
    </head>

    <body>

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Learning Java Concurrency - CountDownLatch</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/posts/">Posts</a></li>
                            
                                <li><a href="/categories/">Categories</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="mailto:mail@wbprime.me"><i class="fa fa-envelope-o"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://github.com/wbprime/"><i class="fa fa-github"></i></a></li>
                            
                                <li class="navbar-icon"><a href="https://www.stackoverflow.com/wbprime/"><i class="fa fa-stack-overflow"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/posts/2016-03-30-java-concurrency-countdownlatch/">Learning Java Concurrency - CountDownLatch</a></h4>
    <h5>March 30, 2016</h5>
     <kbd class="item-tag">java</kbd>  <kbd class="item-tag">concurrency</kbd> 

</div>


    <br> <div class="text-justify">

<p>CountDownLatch 是一种比较有意思的线程同步方法，主要用于需要同步启动的环境中。</p>

<p>举个栗子，部门进行聚餐要等到大家都到齐了才能开动。这个时候CountDownLatch可以理解为“还有多少人没有到”这个东西，来了一个，这个东西的值就会减1。一直到人都到齐了，这个东西的值变为了0,也就是可以开吃了。</p>

<p>举个栗子，通用的make进行多工程代码编译，必须所有工程编译完了才能结束。</p>

<p>举个栗子，项目上线，各个模块都上线完了，leader说一句OK，大家才能走。</p>

<p>要注意以上几个栗子都是每个线程减1，但是实际中具体减多少不做限制。</p>

<p>比如，猫有9条命，两个人你一下我一下一刀一刀砍上去，然后它就死了。这个也可用CountDownLatch来描述。</p>

<!-- more -->

<h1 id="countdownlatch-的简单使用">CountDownLatch 的简单使用</h1>

<p>首先，估计要参与工作的子工作数，创建一个CountDownLatch。</p>

<p>然后，创建干活的线程，持有该CountDownLatch实例，调用await()等待事件。比如具体到聚餐就是“开吃”，具体到9命猫就是“命没了要死了”。</p>

<p>然后，创建多个准备的线程，每个线程持有相同的CountDownLatch实例。这些线程用来做准备工作，争取早日达到能干活的状态。具体到聚餐上就是“人一个一个来”，具体到猫上就是“一次一次被砍死”。</p>

<p>然后，就结束了。</p>

<h1 id="countdownlatch-的-api">CountDownLatch 的 API</h1>

<ol>
<li><code>CountDownLatch(int)</code>
构造一个可以由n个线程共享的闭锁。</li>
<li><code>void await() throws InterruptedException</code>
等待原始的n变成0。调用的线程会被阻塞，直到条件达到。</li>
<li><code>boolean await(long timeout, TimeUnit unit) throws InterruptedException</code>
等待原始的n变成0。调用的线程会被阻塞，直到条件达到(return true)或者超时(return false)。</li>
<li><code>void countDown()</code>
n - 1。</li>
<li><code>long getCount()</code>
查询n的值。</li>
</ol>

<p>CountDownLatch内部有一个静态类Sync。CountDownLatch的所有方法都委托到内部一个Sync实例。</p>

<pre><code class="language-java">private static final class Sync extends AbstractQueuedSynchronizer
</code></pre>

<p>Sync可以理解为一个共享锁，主要使用AbstractQueuedSynchronizer的共享锁方面的功能。</p>

<h1 id="示例代码">示例代码</h1>

<pre><code class="language-java">package me.wbprime.showcase.concurrent;


import java.util.Random;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.ExecutorService;
import java.util.concurrent.Executors;

/**
 * Class: CountDownLatchCase
 * Date: 2016/03/30 13:05
 *
 * @author Elvis Wang [mail@wbprime.me]
 */
public final class CountDownLatchCase {

    public static class Module implements Runnable {
        private CountDownLatch latch;
        private String name;

        public Module(final String name, final CountDownLatch val) {
            this.name = (null != name) ? name : &quot;Anonymous&quot;;
            this.latch = val;
        }

        public void run() {
            System.out.println(&quot;Begin to deploy module: &quot; + name);

            final Random rnd = new Random(System.currentTimeMillis());
            final int sleepTime = rnd.nextInt(1000) + 1;

            try {
                Thread.sleep(sleepTime);
            } catch (InterruptedException e) {
                // do nothing
            }

            System.out.println(&quot;Finish deploying module: &quot; + name);

            latch.countDown();
        }
    }

    public static class Controller implements Runnable {
        private CountDownLatch latch;

        public Controller(final CountDownLatch val) {
            this.latch = val;
        }

        public void run() {
            try {
                latch.await();
                System.out.println(&quot;Finish deploying all modules&quot;);
            } catch (InterruptedException e) {
                // do nothing
            }
        }
    }

    public static void main(String[] args) {

        final int moduleCount = 20;

        final CountDownLatch syncLatch = new CountDownLatch(moduleCount);

        final ExecutorService executorService = Executors.newFixedThreadPool(8);

        executorService.execute(new Controller(syncLatch));
        for (int i = 0; i &lt; moduleCount; i++) {
            executorService.execute(new Module(&quot;Module &quot; + i, syncLatch));
        }

        executorService.shutdown();
    }
}
</code></pre>

<h1 id="示例代码说明">示例代码说明</h1>

<ol>
<li><p>有一个项目需要上线。项目的各个子模块解耦合做的非常好，彼此可以独立上线。但是由于上线有BOSS看着，所以所有模块的团队不管上没上线完，都得在公司里呆着，防止出意外。</p></li>

<li><p>Controller 类表征一个上线通知。所有模块上线完了，整个项目才算上线完了。BOSS才发话，大家才可以回家。</p></li>

<li><p>Module 类表征一个一个的模块。各个模块自己独立上线，上线完了通知项目组一声，然后等别的模块上线。</p></li>

<li><p>main函数里面，创建了CountDownLatch实例，创建了项目组，创建了各个模块，然后大家一起等上线。</p></li>
</ol>

<h1 id="代码下载">代码下载</h1>

<ol>
<li><a href="CountDownLatchCase.java">CountDownLatchCase.java</a></li>
</ol>
</div>

    
    

    

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a></p>

        </footer>

    </body>

</html>

