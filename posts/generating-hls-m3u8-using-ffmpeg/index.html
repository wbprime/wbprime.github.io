<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>wangboâ€™s blog - Generating HLS&#x2F;M3U8 Using FFmpeg</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">WB Prime</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;github.wangbo.im">
                            Github
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;about">
                            About
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;www.wangbo.im">WB Prime</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;github.wangbo.im">
                                    Github
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;generating-hls-m3u8-using-ffmpeg&#x2F;">Generating HLS&#x2F;M3U8 Using FFmpeg</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-07-06</span>
            
        </div>
    </header>

    <div class="post-content">
      <p><a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> æ˜¯å¼€æºçš„éŸ³è§†é¢‘å¤„ç†é¡¹ç›®ï¼Œä»¥ä½¿ç”¨çµæ´»ã€åŠŸèƒ½ä¸°å¯Œè‘—ç§°ï¼Œè¢«å„å¤§äº’è”ç½‘å…¬å¸ç”¨æ¥æ„å»ºå¤šåª’ä½“æœåŠ¡çš„åŸºç¡€ã€‚</p>
<p>æœ€è¿‘çš„é¡¹ç›®ä¸­éœ€è¦æä¾›éŸ³è§†é¢‘å¤šç ç‡è½¬ç æ”¯æŒï¼Œé›†ä¸­è°ƒç ”äº† <a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> å¯¹ <a href="https://developer.apple.com/streaming/">Apple HTTP Live Streaming (HLS)</a> çš„æ”¯æŒï¼Œæ€»ç»“ä¸€ä¸‹ï¼Œé‚æˆæœ¬æ–‡ã€‚</p>
<p>è¯´æ˜ï¼šæœ¬æ–‡ä¸­ä½¿ç”¨çš„å‘½ä»¤è¡Œ <code>ffmpeg</code> ç‰ˆæœ¬ä¸ºï¼š</p>
<blockquote>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;"> ~  ffmpeg
</span><span style="color:#fdf4c1aa;">ffmpeg version n4.1.3 Copyright (c) 2000-2019 the FFmpeg developers
</span><span style="color:#fdf4c1aa;">  built with gcc 8.2.1 (GCC) 20181127
</span><span style="color:#fdf4c1aa;">  configuration: --prefix=/usr --disable-debug --disable-static --disable-stripping --enable-fontconfig --enable-gmp --enable-gnutls --enable-gpl --enable-ladspa --enable-libaom --enable-libass --enable-libbluray --enable-libdrm --enable-libfreetype --enable-libfribidi --enable-libgsm --enable-libiec61883 --enable-libjack --enable-libmodplug --enable-libmp3lame --enable-libopencore_amrnb --enable-libopencore_amrwb --enable-libopenjpeg --enable-libopus --enable-libpulse --enable-libsoxr --enable-libspeex --enable-libssh --enable-libtheora
</span><span style="color:#fdf4c1aa;">--enable-libv4l2 --enable-libvidstab --enable-libvorbis --enable-libvpx --enable-libwebp --enable-libx264 --enable-libx265 --enable-libxcb --enable-libxml2 --enable-libxvid --enable-nvdec --enable-nvenc --enable-omx --enable-shared --enable-version3
</span><span style="color:#fdf4c1aa;">  libavutil      56. 22.100 / 56. 22.100
</span><span style="color:#fdf4c1aa;">  libavcodec     58. 35.100 / 58. 35.100
</span><span style="color:#fdf4c1aa;">  libavformat    58. 20.100 / 58. 20.100
</span><span style="color:#fdf4c1aa;">  libavdevice    58.  5.100 / 58.  5.100
</span><span style="color:#fdf4c1aa;">  libavfilter     7. 40.101 /  7. 40.101
</span><span style="color:#fdf4c1aa;">  libswscale      5.  3.100 /  5.  3.100
</span><span style="color:#fdf4c1aa;">  libswresample   3.  3.100 /  3.  3.100
</span><span style="color:#fdf4c1aa;">  libpostproc    55.  3.100 / 55.  3.100
</span></pre></blockquote>
<p id="zola-continue-reading"><a name="continue-reading"></a></p>
<h1 id="hls-muxer"><a class="zola-anchor" href="#hls-muxer" aria-label="Anchor link for: hls-muxer">ğŸ”—</a><code>hls</code> Muxer</h1>
<p><a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> é€šè¿‡ <a href="http://ffmpeg.org/ffmpeg-formats.html#hls-2">hls</a> å°è£…å™¨æ ¼å¼å¯ä»¥æ”¯æŒ <a href="https://tools.ietf.org/html/draft-pantos-http-live-streaming-06" title="HTTP Live Streaming draft-pantos-http-live-streaming-06">HTTP Live Streaming (HLS)</a> è¾“å‡ºã€‚å…¶ä¼šå°†åŸè§†é¢‘åˆ†å‰²ä¸ºå¤šä¸ª <a href="https://en.wikipedia.org/wiki/MPEG_transport_stream" title="MPEG transport stream">MPEG-TS (.ts)</a> æ ¼å¼çš„ç‰‡æ®µæ–‡ä»¶ï¼Œä»¥åŠä¸€ä¸ª <a href="https://en.wikipedia.org/wiki/M3U" title="M3U">M3U8 (.m3u8)</a> æ ¼å¼çš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ã€‚</p>
<p>å®˜æ–¹æä¾›çš„ç¤ºä¾‹ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">ffmpeg -i in.mkv -c:v h264 -flags +cgop -g 30 -hls_time 1 out.m3u8
</span></pre>
<p>ä¼šç”Ÿæˆä¸€ä¸ªæ’­æ”¾åˆ—è¡¨æ–‡ä»¶ <code>out.m3u8</code>ï¼Œä»¥åŠå¤šä¸ªè§†é¢‘åˆ†ç‰‡æ–‡ä»¶ <code>out0.ts</code>, <code>out1.ts</code>, <code>out2.ts</code> ç­‰ã€‚</p>
<p>å¦å¤–ï¼Œ<a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> ä¹Ÿæä¾›äº† <a href="http://ffmpeg.org/ffmpeg-formats.html#segment_002c-stream_005fsegment_002c-ssegment">segment</a> å°è£…å™¨æ ¼å¼å¯ä»¥ç”Ÿæˆ <a href="https://tools.ietf.org/html/draft-pantos-http-live-streaming-06" title="HTTP Live Streaming draft-pantos-http-live-streaming-06">HTTP Live Streaming (HLS)</a> æ ¼å¼çš„è¾“å‡ºã€‚</p>
<h1 id="dan-ma-lu-m3u8"><a class="zola-anchor" href="#dan-ma-lu-m3u8" aria-label="Anchor link for: dan-ma-lu-m3u8">ğŸ”—</a>å•ç ç‡ M3U8</h1>
<h2 id="qi-shi"><a class="zola-anchor" href="#qi-shi" aria-label="Anchor link for: qi-shi">ğŸ”—</a>èµ·å§‹</h2>
<p>ä¸€ä¸ªå…¸å‹çš„ç”Ÿæˆ <a href="https://tools.ietf.org/html/draft-pantos-http-live-streaming-06" title="HTTP Live Streaming draft-pantos-http-live-streaming-06">HLS</a> è¾“å‡ºçš„å‘½ä»¤è¡Œå¦‚ä¸‹ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">ffmpeg -hide_banner -loglevel warning \
    -ss 10 -t 10 \
    -i test.avi \
    -c:v libx264 -crf 23 -preset veryfast \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type vod \
    -hls_segment_filename hls.test%d.ts \
    -hls_list_size 0 \
    hls.test.m3u8
</span></pre>
<ol>
<li><code>-f hls</code> è¡ŒæŒ‡å®šäº†è¾“å‡ºæ ¼å¼ä¸º <code>hls</code>ï¼Œffmpeg ä¼šä½¿ç”¨ <a href="http://ffmpeg.org/ffmpeg-formats.html#hls-2">hls</a> æ¥å¯¹è¾“å‡ºè§†é¢‘åšå°è£…æ“ä½œã€‚</li>
<li><code>-hls_time 4</code> è¡ŒæŒ‡å®šäº†è¾“å‡ºè§†é¢‘ç‰‡æ®µçš„é•¿åº¦ï¼ŒæœŸæœ›è¾“å‡ºçš„è§†é¢‘ç‰‡æ®µæ¯ä¸€ä¸ªçš„æ—¶é•¿éƒ½æ˜¯ 4sã€‚</li>
<li><code>-hls_playlist_type vod</code> è¡ŒæŒ‡å®šäº†æ’­æ”¾åˆ—è¡¨çš„ç±»å‹ï¼›<code>vod</code> å³ç‚¹æ’­ï¼Œ<code>event</code> å³ç›´æ’­ã€‚</li>
<li><code>-hls_segment_filename hls.test%d.ts</code> è¡ŒæŒ‡å®šäº†è¾“å‡ºç‰‡æ®µæ–‡ä»¶åæ ¼å¼ï¼Œå¯ä»¥ä½¿ç”¨ <code>%d</code> æˆ– <code>%5d</code> çš„æ ¼å¼åŒ–ç¬¦</li>
<li><code>-hls_list_size 0</code> è¡ŒæŒ‡å®šäº†è¾“å‡ºè§†é¢‘ç‰‡æ®µçš„æœ€å¤§ä¸ªæ•°ï¼›å¦‚æœè®¾ç½®ä¸º 0ï¼Œè¯´æ˜ä¸é™åˆ¶ä¸ªæ•°ã€‚</li>
</ol>
<p>è¯¥å‘½ä»¤ä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶ï¼š</p>
<ul>
<li>hls.test0.ts</li>
<li>hls.test1.ts</li>
<li>hls.test2.ts</li>
<li>hls.test3.ts</li>
<li>hls.test.m3u8</li>
</ul>
<p>ç”Ÿæˆçš„ <code>hls.test.m3u8</code> æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<blockquote>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">#EXTM3U
</span><span style="color:#fdf4c1aa;">#EXT-X-VERSION:3
</span><span style="color:#fdf4c1aa;">#EXT-X-TARGETDURATION:7
</span><span style="color:#fdf4c1aa;">#EXT-X-MEDIA-SEQUENCE:0
</span><span style="color:#fdf4c1aa;">#EXT-X-PLAYLIST-TYPE:VOD
</span><span style="color:#fdf4c1aa;">#EXTINF:6.760000,
</span><span style="color:#fdf4c1aa;">hls.test0.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:6.040000,
</span><span style="color:#fdf4c1aa;">hls.test1.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:4.520000,
</span><span style="color:#fdf4c1aa;">hls.test2.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:2.680000,
</span><span style="color:#fdf4c1aa;">hls.test3.ts
</span><span style="color:#fdf4c1aa;">#EXT-X-ENDLIST
</span></pre></blockquote>
<p>æ³¨æ„åˆ°è§†é¢‘ç‰‡æ®µçš„é•¿åº¦å¹¶ä¸æ˜¯æŒ‡å®šçš„ 4sã€‚è¿™æ˜¯å› ä¸º <a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> åœ¨ç”Ÿæˆç‰‡æ®µæ—¶ï¼Œæ€»æ˜¯ä¼šåœ¨æ»¡è¶³æ—¶é•¿è¦æ±‚æ¡ä»¶çš„ç¬¬ä¸€ä¸ªå…³é”®å¸§ (I-frame) å¤„æˆªæ–­ï¼Œè€Œä¸æ˜¯ä¸¥æ ¼æŒ‰ç…§æ—¶é•¿æ¥æˆªæ–­çš„ã€‚</p>
<p><a href="https://www.wangbo.im/posts/generating-hls-m3u8-using-ffmpeg/m3u8.simple.01.sh">Demo Script</a></p>
<h2 id="zhi-ding-gop"><a class="zola-anchor" href="#zhi-ding-gop" aria-label="Anchor link for: zhi-ding-gop">ğŸ”—</a>æŒ‡å®š GOP</h2>
<p>å¦‚æœèƒ½å¤Ÿä½¿å¾—è§†é¢‘åœ¨æŒ‡å®šçš„æ—¶é—´é—´éš”å¤„å­˜åœ¨å…³é”®å¸§ï¼Œåˆ™è¾“å‡ºçš„ç‰‡æ®µæ—¶é•¿éƒ½èƒ½ä¿æŒä¸€è‡´ã€‚å¯ä»¥é€šè¿‡ <code>-g</code> å‚æ•°æ¥è®¾ç½® GOP (ç›¸é‚»çš„ä¸¤ä¸ªå…³é”®å¸§ä¹‹é—´çš„å¸§æ•°ï¼‰ã€‚</p>
<p>æ–°çš„å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">ffmpeg -hide_banner -loglevel warning \
    -ss 10 -t 10 \
    -i test.avi \
    -c:v libx264 -crf 23 -preset veryfast \
    -g 30 \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type vod \
    -hls_segment_filename hls.test%d.ts \
    -hls_list_size 0 \
    hls.test.m3u8
</span></pre>
<p>ç”Ÿæˆçš„æ–‡ä»¶å¦‚ä¸‹ï¼š</p>
<blockquote>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">#EXTM3U
</span><span style="color:#fdf4c1aa;">#EXT-X-VERSION:3
</span><span style="color:#fdf4c1aa;">#EXT-X-TARGETDURATION:5
</span><span style="color:#fdf4c1aa;">#EXT-X-MEDIA-SEQUENCE:0
</span><span style="color:#fdf4c1aa;">#EXT-X-PLAYLIST-TYPE:VOD
</span><span style="color:#fdf4c1aa;">#EXTINF:4.280000,
</span><span style="color:#fdf4c1aa;">hls.test0.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:4.800000,
</span><span style="color:#fdf4c1aa;">hls.test1.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:3.600000,
</span><span style="color:#fdf4c1aa;">hls.test2.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:3.720000,
</span><span style="color:#fdf4c1aa;">hls.test3.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:3.600000,
</span><span style="color:#fdf4c1aa;">hls.test4.ts
</span><span style="color:#fdf4c1aa;">#EXT-X-ENDLIST
</span></pre></blockquote>
<p>ç‰‡æ®µçš„æ—¶é•¿å’Œç›®æ ‡æ—¶é•¿æ¥è¿‘äº†å¾ˆå¤šï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›å·®å¼‚ã€‚</p>
<p><a href="https://www.wangbo.im/posts/generating-hls-m3u8-using-ffmpeg/m3u8.simple.02.sh">Demo Script</a></p>
<h2 id="qu-xiao-yun-dong-chang-jing-jian-ce"><a class="zola-anchor" href="#qu-xiao-yun-dong-chang-jing-jian-ce" aria-label="Anchor link for: qu-xiao-yun-dong-chang-jing-jian-ce">ğŸ”—</a>å–æ¶ˆè¿åŠ¨åœºæ™¯æ£€æµ‹</h2>
<p><a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> åœ¨ç¼–ç æ—¶è¿›è¡Œè¿åŠ¨æ£€æµ‹ã€‚å½“æ£€æµ‹åˆ°è¿åŠ¨åœºæ™¯å˜æ¢æ—¶ï¼Œå…¶ä¼šè‡ªåŠ¨æ’å…¥ä¸€å¸§å…³é”®å¸§ï¼›è¯¥è¡Œä¸ºå¯ä»¥é€šè¿‡ <code>-sc_threshold</code> ç¦ç”¨ã€‚</p>
<p>æ–°å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">ffmpeg -hide_banner -loglevel warning \
    -ss 10 -t 10 \
    -i test.avi \
    -c:v libx264 -crf 23 -preset veryfast \
    -g 30 \
    -sc_threshold 0 \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type vod \
    -hls_segment_filename hls.test%d.ts \
    -hls_list_size 0 \
    hls.test.m3u8
</span></pre>
<p>æ–°çš„æ’­æ”¾åˆ—è¡¨å¦‚ä¸‹ï¼š</p>
<blockquote>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">#EXTM3U
</span><span style="color:#fdf4c1aa;">#EXT-X-VERSION:3
</span><span style="color:#fdf4c1aa;">#EXT-X-TARGETDURATION:5
</span><span style="color:#fdf4c1aa;">#EXT-X-MEDIA-SEQUENCE:0
</span><span style="color:#fdf4c1aa;">#EXT-X-PLAYLIST-TYPE:VOD
</span><span style="color:#fdf4c1aa;">#EXTINF:4.800000,
</span><span style="color:#fdf4c1aa;">hls.test0.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:3.600000,
</span><span style="color:#fdf4c1aa;">hls.test1.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:3.600000,
</span><span style="color:#fdf4c1aa;">hls.test2.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:4.800000,
</span><span style="color:#fdf4c1aa;">hls.test3.ts
</span><span style="color:#fdf4c1aa;">#EXTINF:3.200000,
</span><span style="color:#fdf4c1aa;">hls.test4.ts
</span><span style="color:#fdf4c1aa;">#EXT-X-ENDLIST
</span></pre></blockquote>
<p><a href="https://www.wangbo.im/posts/generating-hls-m3u8-using-ffmpeg/m3u8.simple.03.sh">Demo Script</a></p>
<h2 id="closed-gop"><a class="zola-anchor" href="#closed-gop" aria-label="Anchor link for: closed-gop">ğŸ”—</a>closed GOP</h2>
<p>å¯¹äºè§†é¢‘åˆ†ç‰‡æ¥è¯´ï¼Œé€šå¸¸è¿˜éœ€è¦è®¾ç½® <em>closed GOP</em> æ¨¡å¼ï¼Œé˜²æ­¢è§†é¢‘å¸§å»å¼•ç”¨ GOP ä¹‹å¤–çš„å¸§ã€‚</p>
<p><a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> ä¸­é€šè¿‡ <code>-flags +cgop</code> é€‰é¡¹è®¾ç½® <em>closed GOP</em> æ¨¡å¼ã€‚</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">ffmpeg -hide_banner -loglevel warning \
    -ss 10 -t 10 \
    -i test.avi \
    -c:v libx264 -crf 23 -preset veryfast \
    -g 30 \
    -sc_threshold 0 \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type vod \
    -hls_segment_filename hls.test%d.ts \
    -hls_list_size 0 \
    hls.test.m3u8
</span></pre>
<p><a href="https://www.wangbo.im/posts/generating-hls-m3u8-using-ffmpeg/m3u8.simple.04.sh">Demo Script</a></p>
<h1 id="duo-ma-lu-m3u8"><a class="zola-anchor" href="#duo-ma-lu-m3u8" aria-label="Anchor link for: duo-ma-lu-m3u8">ğŸ”—</a>å¤šç ç‡ M3U8</h1>
<h2 id="duo-ma-lu"><a class="zola-anchor" href="#duo-ma-lu" aria-label="Anchor link for: duo-ma-lu">ğŸ”—</a>å¤šç ç‡</h2>
<p><a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> å¯ä»¥ç›´æ¥æ”¯æŒå¯¹å¤šç ç‡ <a href="https://tools.ietf.org/html/draft-pantos-http-live-streaming-06" title="HTTP Live Streaming draft-pantos-http-live-streaming-06">HLS</a> è¾“å‡ºçš„æ”¯æŒã€‚å…¶åœ¨ç”Ÿæˆå¤šä¸ªå•ç ç‡æ’­æ”¾åˆ—è¡¨ä¹‹å¤–ï¼Œè¿˜ä¼šç”Ÿæˆä¸€ä¸ªå±‚çº§æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ã€‚</p>
<p>å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">ffmpeg -hide_banner -loglevel warning \
    -ss 10 -t 10 \
    -i test.avi \
    -g 30 \
    -sc_threshold 0 \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type event \
    -hls_segment_filename hls.test%d.%v.ts \
    -hls_list_size 0 \
    -map v:0 -c:v:0 libx264 -b:v:0 2000k \
    -map v:0 -c:v:1 libx264 -b:v:1 6000k \
    -map a:0 \
    -map a:0 \
    -var_stream_map </span><span style="color:#b8bb26;">&quot;v:0,a:0 v:1,a:1&quot; </span><span style="color:#fdf4c1;">\
    -master_pl_name hls.test.m3u8 \
    hls.test.m3u8
</span></pre>
<p>è¯´æ˜å¦‚ä¸‹ï¼š</p>
<ul>
<li><code>-var_stream_map &quot;v:0,a:0 v:1,a:1&quot;</code> è¡Œé€šè¿‡é€—å·å’Œç©ºæ ¼åˆ†éš”çš„å‚æ•°æŒ‡å®šè¾“å‡ºä¸¤ä¸ªç ç‡çš„æ’­æ”¾åˆ—è¡¨ï¼Œå¹¶æŒ‡å®šç¬¬ä¸€ä¸ªæ’­æ”¾åˆ—è¡¨å¯¹åº”çš„è§†é¢‘ä»ç¬¬ä¸€ä¸ªè§†é¢‘æµå’Œç¬¬ä¸€ä¸ªéŸ³é¢‘æµç”Ÿæˆï¼Œç¬¬äºŒä¸ªæ’­æ”¾åˆ—è¡¨å¯¹åº”çš„è§†é¢‘ç‰‡æ®µä»ç¬¬äºŒä¸ªè§†é¢‘æµå’Œç¬¬äºŒä¸ªéŸ³é¢‘æµç”Ÿæˆï¼›ä½¿ç”¨æœ¬å‚æ•°ä¹‹åï¼Œ<code>-hls_segment_filename</code> é€‰é¡¹éœ€è¦æ·»åŠ ä¸€ä¸ª <code>%v</code> çš„å ä½ç¬¦ï¼Œè¡¨ç¤ºç¬¬å‡ ä¸ªæ’­æ”¾åˆ—è¡¨ã€‚</li>
<li><code>-master_pl_name hls.test.master.m3u8</code> è¡ŒæŒ‡å®šè¾“å‡ºçš„å±‚çº§æ’­æ”¾åˆ—è¡¨æ–‡ä»¶å</li>
</ul>
<p>æ³¨æ„ï¼Œç”±äºéœ€è¦è¾“å‡ºå¤šç ç‡ï¼Œæ‰€ä»¥åœ¨è¾“å‡ºå‚æ•°éœ€è¦é€šè¿‡ <code>-map</code> å‚æ•°å‡†å¤‡å¤šä¸ªè¾“å‡ºæµã€‚</p>
<p>å¦å¤–ï¼Œåœ¨æœ¬æ–‡ä½¿ç”¨çš„ffmpegç‰ˆæœ¬ä¸­ï¼Œ<code>-hls_playlist_type</code> éœ€è¦è®¾ç½®ä¸º <code>event</code>ï¼Œå¦åˆ™ä¼šæŠ¥ <code>core dump</code> å¼‚å¸¸ã€‚</p>
<p>ç”Ÿæˆçš„å±‚çº§æ’­æ”¾åˆ—è¡¨æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<blockquote>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">#EXTM3U
</span><span style="color:#fdf4c1aa;">#EXT-X-VERSION:3
</span><span style="color:#fdf4c1aa;">#EXT-X-STREAM-INF:BANDWIDTH=2340800,RESOLUTION=1280x720,CODECS=&quot;avc1.64001f,mp4a.40.2&quot;
</span><span style="color:#fdf4c1aa;">hls.test.0.m3u8
</span><span style="color:#fdf4c1aa;">
</span><span style="color:#fdf4c1aa;">#EXT-X-STREAM-INF:BANDWIDTH=6740800,RESOLUTION=1280x720,CODECS=&quot;avc1.64001f,mp4a.40.2&quot;
</span><span style="color:#fdf4c1aa;">hls.test.1.m3u8
</span></pre></blockquote>
<p>å¯¹äºå¤šç ç‡çš„é€‰æ‹©ï¼Œå¯ä»¥å‚è€ƒ <a href="https://developer.apple.com/documentation/http_live_streaming/hls_authoring_specification_for_apple_devices">Apple çš„æ¨èç ç‡</a>ã€‚</p>
<p><a href="https://www.wangbo.im/posts/generating-hls-m3u8-using-ffmpeg/m3u8.multi.01.sh">Demo Script</a></p>
<h2 id="duo-fen-bian-lu"><a class="zola-anchor" href="#duo-fen-bian-lu" aria-label="Anchor link for: duo-fen-bian-lu">ğŸ”—</a>å¤šåˆ†è¾¨ç‡</h2>
<p>å¦‚æœéœ€è¦è¾“å‡ºçš„å¤šç ç‡è§†é¢‘åŒ¹é…å¤šä¸ªåˆ†è¾¨ç‡ï¼Œå¯ä»¥ä½¿ç”¨ <code>-complex_filter</code> ç»„è£…è¿‡æ»¤å™¨å›¾æ¥å®ç°ã€‚</p>
<p>å‘½ä»¤å¦‚ä¸‹ï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">ffmpeg -hide_banner -loglevel warning \
    -ss 10 -t 10 \
    -i test.avi \
    -filter_complex </span><span style="color:#b8bb26;">&quot;[v:0]split=2[vtemp001][vout002];[vtemp001]scale=w=960:h=540[vout001]&quot; </span><span style="color:#fdf4c1;">\
    -g 30 \
    -sc_threshold 0 \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type event \
    -hls_segment_filename hls.test%d.%v.ts \
    -hls_list_size 0 \
    -map </span><span style="color:#b8bb26;">&quot;[vout001]&quot;</span><span style="color:#fdf4c1;"> -c:v:0 libx264 -b:v:0 2000k \
    -map </span><span style="color:#b8bb26;">&quot;[vout002]&quot;</span><span style="color:#fdf4c1;"> -c:v:1 libx264 -b:v:1 6000k \
    -map a:0 \
    -map a:0 \
    -var_stream_map </span><span style="color:#b8bb26;">&quot;v:0,a:0 v:1,a:1&quot; </span><span style="color:#fdf4c1;">\
    -master_pl_name hls.test.m3u8 \
    hls.test.m3u8
</span></pre>
<p>æ³¨æ„ï¼Œè¿‡æ»¤å™¨å›¾éœ€è¦ç”Ÿæˆå¤šä¸ªè¾“å‡ºï¼Œ<code>-map</code> è¡Œéœ€è¦ä¸å¯¹åº”çš„è¾“å‡ºåŒ¹é…ã€‚</p>
<p>ç”Ÿæˆçš„æ’­æ”¾åˆ—è¡¨æ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p>
<blockquote>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1aa;">#EXTM3U
</span><span style="color:#fdf4c1aa;">#EXT-X-VERSION:3
</span><span style="color:#fdf4c1aa;">#EXT-X-STREAM-INF:BANDWIDTH=2340800,RESOLUTION=960x540,CODECS=&quot;avc1.64001f,mp4a.40.2&quot;
</span><span style="color:#fdf4c1aa;">hls.test.0.m3u8
</span><span style="color:#fdf4c1aa;">
</span><span style="color:#fdf4c1aa;">#EXT-X-STREAM-INF:BANDWIDTH=6740800,RESOLUTION=1280x720,CODECS=&quot;avc1.64001f,mp4a.40.2&quot;
</span><span style="color:#fdf4c1aa;">hls.test.1.m3u8
</span></pre></blockquote>
<p><a href="https://www.wangbo.im/posts/generating-hls-m3u8-using-ffmpeg/m3u8.multi.02.sh">Demo Script</a></p>
<h1 id="ffmpeg-3-x"><a class="zola-anchor" href="#ffmpeg-3-x" aria-label="Anchor link for: ffmpeg-3-x">ğŸ”—</a>FFmpeg 3.x</h1>
<p>é—æ†¾çš„æ˜¯ï¼Œ<code>-var_stream_map</code> é€‰é¡¹æ˜¯åœ¨ <a href="http://ffmpeg.org/" title="FFmpeg A complete, cross-platform solution to record, convert and stream audio and video.">FFmpeg</a> 4.x ç‰ˆæœ¬ä»¥åæ·»åŠ çš„åŠŸèƒ½ï¼Œåœ¨ 3.x ç‰ˆæœ¬ä¸­ä¸è¢«æ”¯æŒã€‚</p>
<p>è§£å†³åŠæ³• <s>åˆ æ‰ 3.x å®‰è£… 4.x</s> (_^_^_)</p>
<p>æˆ‘é‡‡ç”¨çš„æ–¹æ³•æ˜¯å¤šè¾“å‡ºç„¶åæ‰‹åŠ¨åˆå¹¶ã€‚</p>
<p>é¦–å…ˆæ‰§è¡Œï¼š</p>
<pre style="background-color:#282828;">
<span style="color:#fdf4c1;">ffmpeg -hide_banner -loglevel warning \
    -ss 10 -t 10 \
    -i test.avi \
    -filter_complex </span><span style="color:#b8bb26;">&quot;[v:0]split=2[vtemp001][vout002];[vtemp001]scale=w=960:h=540[vout001]&quot; </span><span style="color:#fdf4c1;">\
    -g 30 \
    -sc_threshold 0 \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type event \
    -hls_segment_filename hls.test%d.0.ts \
    -hls_list_size 0 \
    -map </span><span style="color:#b8bb26;">&quot;[vout001]&quot;</span><span style="color:#fdf4c1;"> -c:v:0 libx264 -b:v:0 2000k \
    -map a:0 \
    hls.test.0.m3u8 \
    -g 30 \
    -sc_threshold 0 \
    -c:a aac -b:a 128k -ac 2 \
    -f hls \
    -hls_time 4 \
    -hls_playlist_type event \
    -hls_segment_filename hls.test%d.1.ts \
    -hls_list_size 0 \
    -map </span><span style="color:#b8bb26;">&quot;[vout002]&quot;</span><span style="color:#fdf4c1;"> -c:v:1 libx264 -b:v:1 6000k \
    -map a:0 \
    hls.test.1.m3u8
</span></pre>
<p>ç„¶åï¼Œä½¿ç”¨ <code>ffprobe</code> éå†æ¯ä¸€ä¸ªç ç‡çš„ç‰‡æ®µæ–‡ä»¶ï¼Œè·å–æœ€å¤§ç ç‡å’Œåˆ†è¾¨ç‡ä¹‹åæ‰‹åŠ¨ç”Ÿæˆå±‚çº§æ’­æ”¾åˆ—è¡¨æ–‡ä»¶ã€‚</p>
<p><a href="https://www.wangbo.im/posts/generating-hls-m3u8-using-ffmpeg/m3u8.multi.03.sh">Demo Script</a></p>
<hr />
<p>ä»¥ä¸Šã€‚</p>
<p>å‚è€ƒï¼š</p>
<ul>
<li><a href="https://www.martin-riedl.de/2018/08/24/using-ffmpeg-as-a-hls-streaming-server-part-1/">Using FFmpeg as a HLS streaming server (Part 1) â€“ HLS Basics</a></li>
<li><a href="https://www.martin-riedl.de/2018/08/24/using-ffmpeg-as-a-hls-streaming-server-part-2/">Using FFmpeg as a HLS streaming server (Part 2) â€“ Enhanced HLS Segmentation</a></li>
<li><a href="https://www.martin-riedl.de/2018/08/25/using-ffmpeg-as-a-hls-streaming-server-part-3/">Using FFmpeg as a HLS streaming server (Part 3) â€“ Multiple Bitrates</a></li>
<li><a href="https://www.martin-riedl.de/2018/08/26/using-ffmpeg-as-a-hls-streaming-server-part-4-multiple-video-resolutions/">Using FFmpeg as a HLS streaming server (Part 4) â€“ Multiple Video Resolutions</a></li>
<li><a href="https://www.martin-riedl.de/2018/08/30/using-ffmpeg-as-a-hls-streaming-server-part-5-folder-structure/">Using FFmpeg as a HLS streaming server (Part 5) â€“ Folder Structure</a></li>
</ul>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;ffmpeg&#x2F;">#ffmpeg</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;hls&#x2F;">#hls</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;m3u8&#x2F;">#m3u8</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;understanding-rate-control-modes-x264-x265-vpx&#x2F;">â€¹ [è¯‘] Understanding Rate Control Modes (x264, x265, vpx)</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;general-video-bitrate-recommendation&#x2F;">[Note] General Video Bitrate Recommendation â€º</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;www.wangbo.im&#x2F;even.js" ></script>
      
    </body>

</html>
