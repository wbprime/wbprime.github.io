

<!DOCTYPE html>
<html lang="en">
    <head>
      <meta http-equiv="X-UA-Compatible" content="IE=edge">
      <meta http-equiv="content-type" content="text/html; charset=utf-8">

      <!-- Enable responsiveness on mobile devices-->
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

      <title>wangbo’s home &amp; blog - Intro to Spring Cloud Gateway</title>

      

      
          <script src="https://cdnjs.cloudflare.com/ajax/libs/slideout/1.0.1/slideout.min.js"></script>
          
      

      
          <link rel="stylesheet" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;site.css">
          
      

      
      
    </head>

    <body>
        <div class="container">

            <div id="mobile-navbar" class="mobile-navbar">
              <div class="mobile-header-logo">
                <a href="/" class="logo">WB Prime</a>
              </div>
              <div class="mobile-navbar-icon icon-out">
                <span></span>
                <span></span>
                <span></span>
              </div>
            </div>

            <nav id="mobile-menu" class="mobile-menu slideout-menu slideout-menu-left">
              <ul class="mobile-menu-list">
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im">
                            Home
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;categories">
                            Categories
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;tags">
                            Tags
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https://www.wangbo.im&#x2F;about">
                            About
                        </a>
                    </li>
                
                    <li class="mobile-menu-item">
                        <a href="https:&#x2F;&#x2F;github.wangbo.im">
                            Github
                        </a>
                    </li>
                
              </ul>
            </nav>

            <header id="header">
                <div class="logo"><a href="https:&#x2F;&#x2F;www.wangbo.im">WB Prime</a></div>
                <nav class="menu">
                    <ul>
                        
                            <li>
                                <a href="https://www.wangbo.im">
                                    Home
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;categories">
                                    Categories
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;tags">
                                    Tags
                                </a>
                            </li>
                        
                            <li>
                                <a href="https://www.wangbo.im&#x2F;about">
                                    About
                                </a>
                            </li>
                        
                            <li>
                                <a href="https:&#x2F;&#x2F;github.wangbo.im">
                                    Github
                                </a>
                            </li>
                        
                    </ul>
                </nav>
            </header>

            <main>
                <div class="content" id="mobile-panel">
                    



<article class="post">
    
    <header class="post__header">
        <h1 class="post__title">
            <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-08-28-intro-to-spring-cloud-gateway-slide&#x2F;">Intro to Spring Cloud Gateway</a>
        </h1>
        <div class="post__meta">
            <span class="post__time">2019-08-28</span>
            
        </div>
    </header>

    <div class="post-content">
      <p>本文基于在部门内的一次分享修改而成，主要介绍 <a href="https://spring.io/projects/spring-cloud-gateway">Spring Cloud Gateway</a> 的请求处理流程和装配流程。</p>
<p>演示文档是从 markdown 格式文本通过格式转换工具 <a href="https://pandoc.org/">Pandoc</a> 引用
<a href="https://revealjs.com">Reveal.js</a> 转换得到，可供下载。</p>
<p>| Downloads            |
| ---                  |
| <a href="https://www.wangbo.im/posts/2019-08-28-intro-to-spring-cloud-gateway-slide/slide.md">Markdown</a> |
| <a href="https://www.wangbo.im/posts/2019-08-28-intro-to-spring-cloud-gateway-slide/slide.html">Slide</a>  |</p>
<p><a name="continue-reading"></a></p>
<h1 id="intro"><a class="zola-anchor" href="#intro" aria-label="Anchor link for: intro">🔗</a>
Intro</h1>
<h2 id="spring-cloud-gateway"><a class="zola-anchor" href="#spring-cloud-gateway" aria-label="Anchor link for: spring-cloud-gateway">🔗</a>
Spring Cloud Gateway</h2>
<blockquote>
<p><strong>Spring Cloud Gateway</strong> aims to provide a simple, yet effective way to route to APIs and provide cross cutting concerns to them such as: security, monitoring/metrics, and resiliency.</p>
</blockquote>
<p>简而言之，<a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Cloud Gateway</a> 是一个基于 Java 的 Api 网关系统，开箱即用；如果需要自定义也是可以快速搞定。</p>
<p>文档地址：<a href="https://cloud.spring.io/spring-cloud-static/spring-cloud-gateway/2.1.0.RELEASE/">Documentation 2.1.0 Current GA</a></p>
<h2 id="pom"><a class="zola-anchor" href="#pom" aria-label="Anchor link for: pom">🔗</a>
pom</h2>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">dependencies</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">dependency</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">      </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">groupId</span><span style="color:#c0c5ce;">&gt;org.springframework.cloud&lt;/</span><span style="color:#bf616a;">groupId</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">      </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">artifactId</span><span style="color:#c0c5ce;">&gt;spring-cloud-starter-gateway&lt;/</span><span style="color:#bf616a;">artifactId</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">&lt;/</span><span style="color:#bf616a;">dependency</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">&lt;/</span><span style="color:#bf616a;">dependencies</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">dependencyManagement</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">dependencies</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">      </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">dependency</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">groupId</span><span style="color:#c0c5ce;">&gt;org.springframework.boot&lt;/</span><span style="color:#bf616a;">groupId</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">artifactId</span><span style="color:#c0c5ce;">&gt;spring-boot-dependencies&lt;/</span><span style="color:#bf616a;">artifactId</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">version</span><span style="color:#c0c5ce;">&gt;${spring-boot.version}&lt;/</span><span style="color:#bf616a;">version</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">type</span><span style="color:#c0c5ce;">&gt;pom&lt;/</span><span style="color:#bf616a;">type</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">scope</span><span style="color:#c0c5ce;">&gt;import&lt;/</span><span style="color:#bf616a;">scope</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">      </span><span style="color:#c0c5ce;">&lt;/</span><span style="color:#bf616a;">dependency</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">      </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">dependency</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">groupId</span><span style="color:#c0c5ce;">&gt;org.springframework.cloud&lt;/</span><span style="color:#bf616a;">groupId</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">artifactId</span><span style="color:#c0c5ce;">&gt;spring-cloud-dependencies&lt;/</span><span style="color:#bf616a;">artifactId</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">version</span><span style="color:#c0c5ce;">&gt;${spring-cloud.version}&lt;/</span><span style="color:#bf616a;">version</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">type</span><span style="color:#c0c5ce;">&gt;pom&lt;/</span><span style="color:#bf616a;">type</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">&lt;</span><span style="color:#bf616a;">scope</span><span style="color:#c0c5ce;">&gt;import&lt;/</span><span style="color:#bf616a;">scope</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">      </span><span style="color:#c0c5ce;">&lt;/</span><span style="color:#bf616a;">dependency</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">&lt;/</span><span style="color:#bf616a;">dependencies</span><span style="color:#c0c5ce;">&gt;
</span><span style="color:#c0c5ce;">&lt;/</span><span style="color:#bf616a;">dependencyManagement</span><span style="color:#c0c5ce;">&gt;
</span></pre><h2 id="spring-reactor"><a class="zola-anchor" href="#spring-reactor" aria-label="Anchor link for: spring-reactor">🔗</a>
Spring Reactor</h2>
<p><a href="https://projectreactor.io/">Project Reactor</a> 是 <a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> 的底层技术。其号称是一个
异步反应式的编程模式，竞争者是大名鼎鼎的 <a href="https://github.com/ReactiveX/RxJava">RxJava</a>。</p>
<blockquote>
<p>Reactor is a fourth-generation Reactive library for building non-blocking applications on the JVM based on the Reactive Streams Specification.</p>
</blockquote>
<ul>
<li><code>Mono&lt;T&gt;</code> 类似于 <code>CompletableFuture&lt;T&gt;</code>，支持异步 0/1 个结果或异常的语义</li>
<li><code>Flux&lt;T&gt;</code> 类似于 <code>Stream&lt;T&gt;</code>，支持异步 N 个结果或异常的语义</li>
</ul>
<h3 id="mono"><a class="zola-anchor" href="#mono" aria-label="Anchor link for: mono">🔗</a>
Mono</h3>
<p><em>First</em> 构建</p>
<pre style="background-color:#2b303b;">
<span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; mono = </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">fromRunnable</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> dao.</span><span style="color:#bf616a;">update</span><span style="color:#c0c5ce;">(user));
</span></pre>
<p>or</p>
<pre style="background-color:#2b303b;">
<span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">User</span><span style="color:#c0c5ce;">&gt; mono = </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">fromCallable</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> dao.</span><span style="color:#bf616a;">findById</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">1000</span><span style="color:#b48ead;">L</span><span style="color:#c0c5ce;">)</span><span style="background-color:#bf616a;color:#2b303b;">;</span><span style="color:#c0c5ce;">
</span></pre>
<p><em>Then</em> 拼接与转换</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">mono.</span><span style="color:#bf616a;">map</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">user </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> user.</span><span style="color:#bf616a;">getId</span><span style="color:#c0c5ce;">());
</span></pre>
<p>or</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">mono.</span><span style="color:#bf616a;">flatMap</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">user </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> userDao.</span><span style="color:#bf616a;">deleteById</span><span style="color:#c0c5ce;">(user.</span><span style="color:#bf616a;">getId</span><span style="color:#c0c5ce;">())</span><span style="background-color:#bf616a;color:#2b303b;">;</span><span style="color:#c0c5ce;">
</span></pre>
<p><em>Finally</em> 异步处理结果</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">mono.</span><span style="color:#bf616a;">subscribe</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">value </span><span style="color:#b48ead;">-&gt; </span><span style="color:#ebcb8b;">System</span><span style="color:#c0c5ce;">.out.</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;">(value),
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">ex </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> ex.</span><span style="color:#bf616a;">printStackTrace</span><span style="color:#c0c5ce;">(),
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">() </span><span style="color:#b48ead;">-&gt; </span><span style="color:#ebcb8b;">System</span><span style="color:#c0c5ce;">.out.</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">No data</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">);
</span></pre><h3 id="flux"><a class="zola-anchor" href="#flux" aria-label="Anchor link for: flux">🔗</a>
Flux</h3>
<p><em>First</em> 构建</p>
<pre style="background-color:#2b303b;">
<span style="color:#ebcb8b;">Flux</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">User</span><span style="color:#c0c5ce;">&gt; flux = </span><span style="color:#ebcb8b;">Flux</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">create</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">sink </span><span style="color:#b48ead;">-&gt; </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">User</span><span style="color:#b48ead;">[]</span><span style="color:#c0c5ce;"> users = userDao.</span><span style="color:#bf616a;">findByName</span><span style="color:#c0c5ce;">(name);
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(users != </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">for </span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">User</span><span style="color:#c0c5ce;"> user : users) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">sink.</span><span style="color:#bf616a;">next</span><span style="color:#c0c5ce;">(user);
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">sink.</span><span style="color:#bf616a;">complete</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">} </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">sink.</span><span style="color:#bf616a;">error</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">IllegalStateException</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">                </span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">Invalid name: </span><span style="color:#c0c5ce;">&quot; + name));
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">});
</span></pre>
<p>or</p>
<pre style="background-color:#2b303b;">
<span style="color:#ebcb8b;">Flux</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#c0c5ce;">&gt; flux = </span><span style="color:#ebcb8b;">Flux</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">just</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">123</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">456</span><span style="color:#c0c5ce;">&quot;, &quot;</span><span style="color:#a3be8c;">789</span><span style="color:#c0c5ce;">&quot;);
</span></pre>
<p><em>Then</em> 拼接与转换</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">flux.</span><span style="color:#bf616a;">map</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">str </span><span style="color:#b48ead;">-&gt; </span><span style="color:#ebcb8b;">Longs</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">tryParse</span><span style="color:#c0c5ce;">(str));
</span></pre>
<p>or</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">flux.</span><span style="color:#bf616a;">flatMap</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">user </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> userDao.</span><span style="color:#bf616a;">deleteById</span><span style="color:#c0c5ce;">(user.</span><span style="color:#bf616a;">getId</span><span style="color:#c0c5ce;">()));
</span></pre>
<p><em>Finally</em> 异步处理结果</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">mono.</span><span style="color:#bf616a;">subscribe</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">value </span><span style="color:#b48ead;">-&gt; </span><span style="color:#ebcb8b;">System</span><span style="color:#c0c5ce;">.out.</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;">(value),
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">ex </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> ex.</span><span style="color:#bf616a;">printStackTrace</span><span style="color:#c0c5ce;">(),
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">() </span><span style="color:#b48ead;">-&gt; </span><span style="color:#ebcb8b;">System</span><span style="color:#c0c5ce;">.out.</span><span style="color:#bf616a;">println</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">No data</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">);
</span></pre><h2 id="webflux"><a class="zola-anchor" href="#webflux" aria-label="Anchor link for: webflux">🔗</a>
WebFlux</h2>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">Spring WebFlux - Web on Reactive Stack</a> 是 <a href="https://spring.io/">Spring</a> 推出的基于 <a href="https://projectreactor.io/">Project Reactor</a> 的 HTTP 网络开发框架，相似者是 <a href="https://vertx.io/docs/vertx-web/java/">Vert.x-Web</a>。</p>
<blockquote>
<p>fully non-blocking, supports Reactive Streams back pressure, and runs on such servers as Netty, Undertow, and Servlet 3.1+ containers.</p>
<ul>
<li>the Spring WebFlux framework</li>
<li>the reactive WebClient</li>
<li>support for testing</li>
<li>and reactive libraries.</li>
</ul>
</blockquote>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">WebFlux</a> 被设计来取代或者说补充原有的基于 Servlet 的网络框架：<a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web.html#spring-web">Spring Web MVC - Web on Servlet Stack</a>。</p>
<p><img src="https://www.wangbo.im/posts/2019-08-28-intro-to-spring-cloud-gateway-slide/spring-mvc-context-hierarchy.png" alt="spring-mvc-dispatcherservlet" /></p>
<p>二者的关系：</p>
<p><img src="https://www.wangbo.im/posts/2019-08-28-intro-to-spring-cloud-gateway-slide/spring-mvc-vs-webflux.png" alt="spring-webflux-vs-webmvc" /></p>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">WebFlux</a> 的典型代码：</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">RequestMapping</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/root</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">RestController
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">WebFluxTestController </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">GetMapping</span><span style="color:#eff1f5;">(</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#a3be8c;">/user/{id}</span><span style="color:#c0c5ce;">&quot;</span><span style="color:#eff1f5;">)
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">UserDto</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">getUser</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">final </span><span style="color:#ebcb8b;">String </span><span style="color:#bf616a;">id</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Mono</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">just</span><span style="color:#eff1f5;">(</span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">Foobar</span><span style="color:#eff1f5;">());
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre><h1 id="gateway"><a class="zola-anchor" href="#gateway" aria-label="Anchor link for: gateway">🔗</a>
Gateway</h1>
<h2 id="workflow"><a class="zola-anchor" href="#workflow" aria-label="Anchor link for: workflow">🔗</a>
Workflow</h2>
<p>官方的请求处理流程图：</p>
<p><img src="https://www.wangbo.im/posts/2019-08-28-intro-to-spring-cloud-gateway-slide/spring_cloud_gateway_diagram.png" alt="spring-gateway-architecture" /></p>
<p>下面来从对象装配(Assembly) 和请求匹配(Runtime) 的角度来深入一下 <a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> 的内部代码。</p>
<h2 id="assembly-httphandlerautoconfiguration"><a class="zola-anchor" href="#assembly-httphandlerautoconfiguration" aria-label="Anchor link for: assembly-httphandlerautoconfiguration">🔗</a>
Assembly - HttpHandlerAutoConfiguration</h2>
<p><a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" title="WebFlux - Web on Reactive Stack">WebFlux</a> 基于 Spring 的传统对底层的网络层进行了抽象，可以支持 Servlet 的实现和一个内建的
基于 <a href="https://netty.io/">Netty</a> 的实现。<a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> 默认使用基于 Netty 的实现。</p>
<p>首先定位到网络服务器 <code>WebServer</code> 接口的 Netty 实现类。</p>
<ul>
<li><code>org.springframework.boot.web.embedded.netty.NettyReactiveWebServerFactory#getWebServer</code></li>
<li><code>org.springframework.boot.web.embedded.netty.NettyWebServer#start</code></li>
<li><code>org.springframework.http.server.reactive.ReactorHttpHandlerAdapter#apply</code></li>
<li><code>org.springframework.http.server.reactive.HttpHandler#handle</code></li>
</ul>
<p>发现请求的处理类是 <code>HttpHandler</code> 类。</p>
<h2 id="assembly-httphandlerautoconfiguration-1"><a class="zola-anchor" href="#assembly-httphandlerautoconfiguration-1" aria-label="Anchor link for: assembly-httphandlerautoconfiguration-1">🔗</a>
Assembly - HttpHandlerAutoConfiguration</h2>
<p>然后根据 Spring boot 启动逻辑找到 <code>HttpHandler</code> 的实现类。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Configuration
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">ConditionalOnClass</span><span style="color:#c0c5ce;">({ </span><span style="color:#ebcb8b;">DispatcherHandler</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">, </span><span style="color:#ebcb8b;">HttpHandler</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class </span><span style="color:#c0c5ce;">})
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">ConditionalOnWebApplication</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">type </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">ConditionalOnWebApplication</span><span style="color:#c0c5ce;">.</span><span style="color:#ebcb8b;">Type</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">REACTIVE</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">ConditionalOnMissingBean</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">HttpHandler</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">AutoConfigureAfter</span><span style="color:#c0c5ce;">({ </span><span style="color:#ebcb8b;">WebFluxAutoConfiguration</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class </span><span style="color:#c0c5ce;">})
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">AutoConfigureOrder</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Ordered</span><span style="color:#c0c5ce;">.</span><span style="color:#d08770;">HIGHEST_PRECEDENCE </span><span style="color:#c0c5ce;">+ </span><span style="color:#d08770;">10</span><span style="color:#c0c5ce;">)
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">HttpHandlerAutoConfiguration </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Configuration
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public static class </span><span style="color:#ebcb8b;">AnnotationConfig </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">ApplicationContext </span><span style="color:#eff1f5;">applicationContext;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">public </span><span style="color:#8fa1b3;">AnnotationConfig</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ApplicationContext </span><span style="color:#bf616a;">applicationContext</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">            </span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.applicationContext </span><span style="color:#c0c5ce;">=</span><span style="color:#eff1f5;"> applicationContext;
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Bean
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">HttpHandler </span><span style="color:#8fa1b3;">httpHandler</span><span style="color:#eff1f5;">() {
</span><span style="color:#eff1f5;">            </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">WebHttpHandlerBuilder</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">applicationContext</span><span style="color:#eff1f5;">(</span><span style="color:#bf616a;">this</span><span style="color:#eff1f5;">.applicationContext).</span><span style="color:#bf616a;">build</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">        </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre>
<p>定位到 <code>WebHttpHandlerBuilder</code> 类，下一步需要去看看其 <code>build()</code> 方法里面的代码。</p>
<h2 id="assembly-webhttphandlerbuilder"><a class="zola-anchor" href="#assembly-webhttphandlerbuilder" aria-label="Anchor link for: assembly-webhttphandlerbuilder">🔗</a>
Assembly - WebHttpHandlerBuilder</h2>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public static final </span><span style="color:#ebcb8b;">String </span><span style="color:#d08770;">WEB_HANDLER_BEAN_NAME </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">webHandler</span><span style="color:#c0c5ce;">&quot;;
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">private </span><span style="color:#bf616a;">WebHttpHandlerBuilder</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">WebHandler</span><span style="color:#c0c5ce;"> webHandler, @</span><span style="color:#ebcb8b;">Nullable ApplicationContext</span><span style="color:#c0c5ce;"> applicationContext) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.webHandler = webHandler; </span><span style="color:#65737e;">// HERE
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.applicationContext = applicationContext;
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">public static </span><span style="color:#ebcb8b;">WebHttpHandlerBuilder </span><span style="color:#bf616a;">applicationContext</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ApplicationContext</span><span style="color:#c0c5ce;"> context) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">WebHttpHandlerBuilder</span><span style="color:#c0c5ce;"> builder = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">WebHttpHandlerBuilder</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">context.</span><span style="color:#bf616a;">getBean</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">WEB_HANDLER_BEAN_NAME</span><span style="color:#c0c5ce;">, </span><span style="color:#ebcb8b;">WebHandler</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">), context); </span><span style="color:#65737e;">// HERE
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> builder;
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">HttpHandler </span><span style="color:#bf616a;">build</span><span style="color:#c0c5ce;">() {
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">WebHandler</span><span style="color:#c0c5ce;"> decorated = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">FilteringWebHandler</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.webHandler, </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.filters); </span><span style="color:#65737e;">// HERE
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">decorated = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ExceptionHandlingWebHandler</span><span style="color:#c0c5ce;">(decorated,  </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.exceptionHandlers); </span><span style="color:#65737e;">// HERE
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">HttpWebHandlerAdapter</span><span style="color:#c0c5ce;"> adapted = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">HttpWebHandlerAdapter</span><span style="color:#c0c5ce;">(decorated); </span><span style="color:#65737e;">//HERE
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> adapted;
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>找到了比较关键的 <code>HttpWebHandlerAdapter</code> 类和 <code>FilteringWebHandler</code> 类。</p>
<h2 id="assembly-httpwebhandleradapter"><a class="zola-anchor" href="#assembly-httpwebhandleradapter" aria-label="Anchor link for: assembly-httpwebhandleradapter">🔗</a>
Assembly - HttpWebHandlerAdapter</h2>
<p>发现 <code>HttpWebHandlerAdapter</code> 类的逻辑就是把请求转给了 <code>FilteringWebHandler</code> 类。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerHttpRequest</span><span style="color:#c0c5ce;"> request, </span><span style="color:#ebcb8b;">ServerHttpResponse</span><span style="color:#c0c5ce;"> response) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">getDelegate</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(exchange) </span><span style="color:#65737e;">// HERE
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">doOnSuccess</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">aVoid </span><span style="color:#b48ead;">-&gt; </span><span style="color:#bf616a;">logResponse</span><span style="color:#c0c5ce;">(exchange))
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">onErrorResume</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">ex </span><span style="color:#b48ead;">-&gt; </span><span style="color:#bf616a;">handleUnresolvedError</span><span style="color:#c0c5ce;">(exchange, ex))
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">then</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">defer</span><span style="color:#c0c5ce;">(response::</span><span style="color:#bf616a;">setComplete</span><span style="color:#c0c5ce;">));
</span><span style="color:#c0c5ce;">}
</span></pre><h2 id="assembly-exceptionhandlingwebhandler"><a class="zola-anchor" href="#assembly-exceptionhandlingwebhandler" aria-label="Anchor link for: assembly-exceptionhandlingwebhandler">🔗</a>
Assembly - ExceptionHandlingWebHandler</h2>
<p>这是 <code>WebHttpHandlerBuilder#build()</code> 里面发现的 <code>ExceptionHandlingWebHandler</code> 类，可以不用重点关注。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;"> exchange) {
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; completion;
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">try </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">completion = </span><span style="color:#bf616a;">super</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(exchange); </span><span style="color:#65737e;">// HERE
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">} </span><span style="color:#b48ead;">catch </span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Throwable </span><span style="color:#bf616a;">ex</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">completion = </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">error</span><span style="color:#c0c5ce;">(ex);
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> completion;
</span><span style="color:#c0c5ce;">}
</span></pre><h2 id="assembly-filteringwebhandler"><a class="zola-anchor" href="#assembly-filteringwebhandler" aria-label="Anchor link for: assembly-filteringwebhandler">🔗</a>
Assembly - FilteringWebHandler</h2>
<p>重点看一下 <code>FilteringWebHandler</code> 类的实现。</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.chain = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">DefaultWebFilterChain</span><span style="color:#c0c5ce;">(handler, filters); </span><span style="color:#65737e;">// HERE
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;"> exchange) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.chain.</span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">(exchange);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>里面把请求转给了 <code>DefaultWebFilterChain</code> 类，这个类一听就是一个类似责任链的设计。</p>
<h2 id="assembly-defaultwebfilterchain"><a class="zola-anchor" href="#assembly-defaultwebfilterchain" aria-label="Anchor link for: assembly-defaultwebfilterchain">🔗</a>
Assembly - DefaultWebFilterChain</h2>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;"> exchange) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">defer</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">-&gt;
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.currentFilter != </span><span style="color:#d08770;">null </span><span style="color:#c0c5ce;">&amp;&amp; </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.next != </span><span style="color:#d08770;">null </span><span style="color:#c0c5ce;">?
</span><span style="color:#c0c5ce;">                </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.currentFilter.</span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">(exchange, </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.next) :
</span><span style="color:#c0c5ce;">                </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.handler.</span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(exchange));
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>这里面又做了一层封装，会调用到 <code>DispatcherHandler</code> 类的实现逻辑。</p>
<h2 id="assembly-webfluxconfigurationsupport"><a class="zola-anchor" href="#assembly-webfluxconfigurationsupport" aria-label="Anchor link for: assembly-webfluxconfigurationsupport">🔗</a>
Assembly - WebFluxConfigurationSupport</h2>
<p><code>DispatcherHandler</code> 类在 <code>org.springframework.web.reactive.config.WebFluxConfigurationSupport</code> 中被
自动注册。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Bean
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">DispatcherHandler </span><span style="color:#bf616a;">webHandler</span><span style="color:#c0c5ce;">() {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return new </span><span style="color:#ebcb8b;">DispatcherHandler</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">}
</span></pre><h2 id="assembly-dispatcherhandler"><a class="zola-anchor" href="#assembly-dispatcherhandler" aria-label="Anchor link for: assembly-dispatcherhandler">🔗</a>
Assembly - DispatcherHandler</h2>
<p>这个 <code>org.springframework.web.reactive.DispatcherHandler</code> 又做了一层封装，底下是一系列的
<code>HandlerMapping</code> 类的实现。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">protected</span><span style="color:#c0c5ce;"> void </span><span style="color:#bf616a;">initStrategies</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ApplicationContext</span><span style="color:#c0c5ce;"> context) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">Map</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#c0c5ce;">, </span><span style="color:#ebcb8b;">HandlerMapping</span><span style="color:#c0c5ce;">&gt; mappingBeans = </span><span style="color:#ebcb8b;">BeanFactoryUtils</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">beansOfTypeIncludingAncestors</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">context, </span><span style="color:#ebcb8b;">HandlerMapping</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">true</span><span style="color:#c0c5ce;">, </span><span style="color:#d08770;">false</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">ArrayList</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">HandlerMapping</span><span style="color:#c0c5ce;">&gt; mappings = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ArrayList</span><span style="color:#c0c5ce;">&lt;&gt;(mappingBeans.</span><span style="color:#bf616a;">values</span><span style="color:#c0c5ce;">());
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">AnnotationAwareOrderComparator</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">sort</span><span style="color:#c0c5ce;">(mappings);
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.handlerMappings = </span><span style="color:#ebcb8b;">Collections</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">unmodifiableList</span><span style="color:#c0c5ce;">(mappings);
</span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;"> exchange) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.handlerMappings == </span><span style="color:#d08770;">null</span><span style="color:#c0c5ce;">) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">createNotFoundError</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Flux</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">fromIterable</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.handlerMappings)
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">concatMap</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">mapping </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> mapping.</span><span style="color:#bf616a;">getHandler</span><span style="color:#c0c5ce;">(exchange))
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">next</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">switchIfEmpty</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">createNotFoundError</span><span style="color:#c0c5ce;">())
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">flatMap</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">handler </span><span style="color:#b48ead;">-&gt; </span><span style="color:#bf616a;">invokeHandler</span><span style="color:#c0c5ce;">(exchange, handler))
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">flatMap</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">result </span><span style="color:#b48ead;">-&gt; </span><span style="color:#bf616a;">handleResult</span><span style="color:#c0c5ce;">(exchange, result));
</span><span style="color:#c0c5ce;">}
</span></pre><h2 id="assembly-routepredicatehandlermapping"><a class="zola-anchor" href="#assembly-routepredicatehandlermapping" aria-label="Anchor link for: assembly-routepredicatehandlermapping">🔗</a>
Assembly - RoutePredicateHandlerMapping</h2>
<p><code>HandlerMapping</code> 也是通过 Spring 自动管理的，其实现类是 <code>org.springframework.cloud.gateway.handler.RoutePredicateHandlerMapping</code>。</p>
<p>装配代码在 <code>org.springframework.cloud.gateway.config.GatewayAutoConfiguration</code> 中。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Configuration
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">ConditionalOnProperty</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">name </span><span style="color:#c0c5ce;">= &quot;</span><span style="color:#a3be8c;">spring.cloud.gateway.enabled</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#bf616a;">matchIfMissing </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">true</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">EnableConfigurationProperties
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">AutoConfigureBefore</span><span style="color:#c0c5ce;">({ </span><span style="color:#ebcb8b;">HttpHandlerAutoConfiguration</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#ebcb8b;">WebFluxAutoConfiguration</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class </span><span style="color:#c0c5ce;">})
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">AutoConfigureAfter</span><span style="color:#c0c5ce;">({ </span><span style="color:#ebcb8b;">GatewayLoadBalancerClientAutoConfiguration</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">        </span><span style="color:#ebcb8b;">GatewayClassPathWarningAutoConfiguration</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class </span><span style="color:#c0c5ce;">})
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">ConditionalOnClass</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">DispatcherHandler</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">class</span><span style="color:#c0c5ce;">)
</span><span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">GatewayAutoConfiguration </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Bean
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">RoutePredicateHandlerMapping </span><span style="color:#8fa1b3;">routePredicateHandlerMapping</span><span style="color:#eff1f5;">(
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">FilteringWebHandler </span><span style="color:#bf616a;">webHandler</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">RouteLocator </span><span style="color:#bf616a;">routeLocator</span><span style="color:#eff1f5;">,
</span><span style="color:#eff1f5;">            </span><span style="color:#ebcb8b;">GlobalCorsProperties </span><span style="color:#bf616a;">globalCorsProperties</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">Environment </span><span style="color:#bf616a;">environment</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return new </span><span style="color:#ebcb8b;">RoutePredicateHandlerMapping</span><span style="color:#eff1f5;">(webHandler, routeLocator,
</span><span style="color:#eff1f5;">                </span><span style="color:#eff1f5;">globalCorsProperties, environment);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Bean
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Primary
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// TODO: property to disable composite?
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">RouteLocator </span><span style="color:#8fa1b3;">cachedCompositeRouteLocator</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RouteLocator</span><span style="color:#eff1f5;">&gt; </span><span style="color:#bf616a;">routeLocators</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return new </span><span style="color:#ebcb8b;">CachingRouteLocator</span><span style="color:#eff1f5;">(
</span><span style="color:#eff1f5;">                </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">CompositeRouteLocator</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">Flux</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">fromIterable</span><span style="color:#eff1f5;">(routeLocators)));
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Bean
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">FilteringWebHandler </span><span style="color:#8fa1b3;">filteringWebHandler</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">GlobalFilter</span><span style="color:#eff1f5;">&gt; </span><span style="color:#bf616a;">globalFilters</span><span style="color:#eff1f5;">) {
</span><span style="color:#eff1f5;">        </span><span style="color:#b48ead;">return new </span><span style="color:#ebcb8b;">FilteringWebHandler</span><span style="color:#eff1f5;">(globalFilters);
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">}
</span><span style="color:#eff1f5;">}
</span></pre>
<p><code>GatewayAutoConfiguration</code> 这个装配类里面还提供了 <code>RouteLocator</code> 和 <code>FilteringWebHandler</code> 的实现，这
个后面会用到。</p>
<h2 id="runtime-routepredicatehandlermapping"><a class="zola-anchor" href="#runtime-routepredicatehandlermapping" aria-label="Anchor link for: runtime-routepredicatehandlermapping">🔗</a>
Runtime - RoutePredicateHandlerMapping</h2>
<p><code>RoutePredicateHandlerMapping</code> 中首先从 <code>org.springframework.cloud.gateway.route.RouteLocator</code> 中去
获取当前所有可用的 <code>Route</code> 实例并找到第一个能匹配当前请求的 <code>Route</code> 放到请求的上下文中，然后调用 <code>org.springframework.cloud.gateway.handler.FilteringWebHandler</code> 里面的代码。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">protected </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Route</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">lookupRoute</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;"> exchange) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.routeLocator.</span><span style="color:#bf616a;">getRoutes</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">// individually filter routes so that filterWhen error delaying is not a
</span><span style="color:#c0c5ce;">        </span><span style="color:#65737e;">// problem
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">concatMap</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">route </span><span style="color:#b48ead;">-&gt; </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">just</span><span style="color:#c0c5ce;">(route).</span><span style="color:#bf616a;">filterWhen</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">r </span><span style="color:#b48ead;">-&gt; </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">            </span><span style="color:#65737e;">// add the current route we are testing
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">exchange.</span><span style="color:#bf616a;">getAttributes</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">put</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">GATEWAY_PREDICATE_ROUTE_ATTR</span><span style="color:#c0c5ce;">, r.</span><span style="color:#bf616a;">getId</span><span style="color:#c0c5ce;">());
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> r.</span><span style="color:#bf616a;">getPredicate</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">apply</span><span style="color:#c0c5ce;">(exchange);
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">})
</span><span style="color:#c0c5ce;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>RouteLocator</code> 的逻辑后面再讲，先看看 <code>FilteringWebHandler</code> 的逻辑。</p>
<h2 id="runtime-filteringwebhandler"><a class="zola-anchor" href="#runtime-filteringwebhandler" aria-label="Anchor link for: runtime-filteringwebhandler">🔗</a>
Runtime - FilteringWebHandler</h2>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">handle</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;"> exchange) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">Route</span><span style="color:#c0c5ce;"> route = exchange.</span><span style="color:#bf616a;">getRequiredAttribute</span><span style="color:#c0c5ce;">(</span><span style="color:#d08770;">GATEWAY_ROUTE_ATTR</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">List</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">GatewayFilter</span><span style="color:#c0c5ce;">&gt; gatewayFilters = route.</span><span style="color:#bf616a;">getFilters</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">List</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">GatewayFilter</span><span style="color:#c0c5ce;">&gt; combined = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ArrayList</span><span style="color:#c0c5ce;">&lt;&gt;(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.globalFilters);
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">combined.</span><span style="color:#bf616a;">addAll</span><span style="color:#c0c5ce;">(gatewayFilters);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">AnnotationAwareOrderComparator</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">sort</span><span style="color:#c0c5ce;">(combined);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return new </span><span style="color:#ebcb8b;">DefaultGatewayFilterChain</span><span style="color:#c0c5ce;">(combined).</span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">(exchange);
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>FilteringWebHandler</code> 中首先从请求的上下文中取出匹配到的 <code>Route</code> 实例，将实例里面的 <code>GatewayFilter</code>
列表和全局的 <code>GlobalFilter</code> 列表合并排序后放入 <code>DefaultGatewayFilterChain</code> （又是一个责任链）中进行
链式处理。</p>
<h2 id="runtime-defaultwebfilterchain"><a class="zola-anchor" href="#runtime-defaultwebfilterchain" aria-label="Anchor link for: runtime-defaultwebfilterchain">🔗</a>
Runtime - DefaultWebFilterChain</h2>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;"> exchange) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">defer</span><span style="color:#c0c5ce;">(() </span><span style="color:#b48ead;">-&gt; </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.index &lt; filters.</span><span style="color:#bf616a;">size</span><span style="color:#c0c5ce;">()) {
</span><span style="color:#c0c5ce;">            </span><span style="color:#ebcb8b;">GatewayFilter</span><span style="color:#c0c5ce;"> filter = filters.</span><span style="color:#bf616a;">get</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.index);
</span><span style="color:#c0c5ce;">            </span><span style="color:#ebcb8b;">DefaultGatewayFilterChain</span><span style="color:#c0c5ce;"> chain = </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">DefaultGatewayFilterChain</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">,
</span><span style="color:#c0c5ce;">                    </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.index + </span><span style="color:#d08770;">1</span><span style="color:#c0c5ce;">);
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> filter.</span><span style="color:#bf616a;">filter</span><span style="color:#c0c5ce;">(exchange, chain);
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">else </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">            </span><span style="color:#b48ead;">return </span><span style="color:#ebcb8b;">Mono</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">empty</span><span style="color:#c0c5ce;">(); </span><span style="color:#65737e;">// complete
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">});
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><code>DefaultGatewayFilterChain</code> 里面维护了一个 <code>GatewayFilter</code> 的集合和一个标识当前正在处理的元素的索引
，每次调用到一个 <code>GatewayFilter</code> 元素的处理逻辑时创建一个新的指向循成额元素的链，以不可变性保证线程
安全。</p>
<h1 id="routes"><a class="zola-anchor" href="#routes" aria-label="Anchor link for: routes">🔗</a>
Routes</h1>
<p><a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> 向外暴露出来的对象之一是路由(Route) 对象，其根据一个或者一系列的条件来判断
接收到的请求是否能被本路由处理，如果能够处理，则使用内置的一系列局部过滤器和全局的过滤器处理请求并返回响应。</p>
<h2 id="class-route"><a class="zola-anchor" href="#class-route" aria-label="Anchor link for: class-route">🔗</a>
Class Route</h2>
<p>Route 类的全称是 <code>org.springframework.cloud.gateway.route.Route</code>，是 <a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> 暴露
出来的处理请求的基本单元。</p>
<p>结构如下：</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">Route </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">Ordered </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">id;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">URI </span><span style="color:#eff1f5;">uri;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final int </span><span style="color:#eff1f5;">order;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">AsyncPredicate</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#eff1f5;">&gt; predicate;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">GatewayFilter</span><span style="color:#eff1f5;">&gt; gatewayFilters;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">}
</span></pre>
<p>主要成员是一个请求的判定器 <code>predicate</code>、多个处理器 <code>gatewayFilters</code>、一个后端访问地址 <code>uri</code>，以及一
个唯一标识和序号。</p>
<h2 id="interface-routelocator"><a class="zola-anchor" href="#interface-routelocator" aria-label="Anchor link for: interface-routelocator">🔗</a>
Interface RouteLocator</h2>
<p><a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> 通过 <code>org.springframework.cloud.gateway.route.RouteLocator</code> 来进行所有路由
对象的加载。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public interface </span><span style="color:#ebcb8b;">RouteLocator </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Flux</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Route</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">getRoutes</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">}
</span></pre><h2 id="routelocator-implementations"><a class="zola-anchor" href="#routelocator-implementations" aria-label="Anchor link for: routelocator-implementations">🔗</a>
RouteLocator Implementations</h2>
<p><code>RouteLocator</code> 接口有以下自带实现：</p>
<ul>
<li><code>org.springframework.cloud.gateway.route.CachingRouteLocator</code></li>
<li><code>org.springframework.cloud.gateway.route.CompositeRouteLocator</code></li>
<li><code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator</code></li>
</ul>
<p>在 <code>GatewayAutoConfiguration</code> 中可以了解加载的实例：由 <code>RouteDefinitionRouteLocator</code> 管理的路由和多个由第三方自己实现的 <code>RouteLocator</code> 管理的路由被 <code>CompositeRouteLocator</code> 组合起来之后的结果再经过 <code>CachingRouteLocator</code> 被缓存使用。</p>
<p><strong>所有</strong> 能被 Spring 感知到的 <code>org.springframework.cloud.gateway.route.RouteLocator</code> bean 实例都会被默认收集被 <code>CompositeRouteLocator</code> 管理。</p>
<h2 id="routedefinitionroutelocator"><a class="zola-anchor" href="#routedefinitionroutelocator" aria-label="Anchor link for: routedefinitionroutelocator">🔗</a>
RouteDefinitionRouteLocator</h2>
<p><code>RouteDefinitionLocator</code> 用来管理反序列化生成的路由。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Override
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">Flux</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">Route</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">getRoutes</span><span style="color:#c0c5ce;">() {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">.routeDefinitionLocator.</span><span style="color:#bf616a;">getRouteDefinitions</span><span style="color:#c0c5ce;">().</span><span style="color:#bf616a;">map</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">this</span><span style="color:#c0c5ce;">::</span><span style="color:#bf616a;">convertToRoute</span><span style="color:#c0c5ce;">)
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">map</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">route </span><span style="color:#b48ead;">-&gt; </span><span style="color:#c0c5ce;">{
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">if </span><span style="color:#c0c5ce;">(logger.</span><span style="color:#bf616a;">isDebugEnabled</span><span style="color:#c0c5ce;">()) {
</span><span style="color:#c0c5ce;">                    </span><span style="color:#c0c5ce;">logger.</span><span style="color:#bf616a;">debug</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">RouteDefinition matched: </span><span style="color:#c0c5ce;">&quot; + route.</span><span style="color:#bf616a;">getId</span><span style="color:#c0c5ce;">());
</span><span style="color:#c0c5ce;">                </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">                </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> route;
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">});
</span><span style="color:#c0c5ce;">}
</span></pre>
<p>可以看到，其使用了 <code>RouteDefinitionLocator</code> 来管理路由的定义对象，并提供了路由定义对象到路由对象的转
换。</p>
<p><code>RouteDefinitionLocator</code> 的设计模式与 <code>RouteLocator</code> 相似。</p>
<h2 id="routedefinitionlocator-and-implementations"><a class="zola-anchor" href="#routedefinitionlocator-and-implementations" aria-label="Anchor link for: routedefinitionlocator-and-implementations">🔗</a>
RouteDefinitionLocator and Implementations</h2>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">package </span><span style="color:#c0c5ce;">org.springframework.cloud.gateway.route;
</span><span style="color:#b48ead;">public interface </span><span style="color:#ebcb8b;">RouteDefinitionLocator </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Flux</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">RouteDefinition</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">getRouteDefinitions</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">}
</span></pre>
<p><code>RouteDefinitionLocator</code> 的实现类有：</p>
<ul>
<li><code>org.springframework.cloud.gateway.route.CompositeRouteDefinitionLocator</code></li>
<li><code>org.springframework.cloud.gateway.config.PropertiesRouteDefinitionLocator</code></li>
<li><code>org.springframework.cloud.gateway.route.InMemoryRouteDefinitionRepository</code></li>
</ul>
<h2 id="routedefinitionlocator-loading"><a class="zola-anchor" href="#routedefinitionlocator-loading" aria-label="Anchor link for: routedefinitionlocator-loading">🔗</a>
RouteDefinitionLocator Loading</h2>
<p>类似地，在 <code>GatewayAutoConfiguration</code> 中可以找到 <code>RouteDefinitionLocator</code> 被加载使用的逻辑。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Bean
</span><span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Primary
</span><span style="color:#b48ead;">public </span><span style="color:#ebcb8b;">RouteDefinitionLocator </span><span style="color:#bf616a;">routeDefinitionLocator</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">        </span><span style="color:#ebcb8b;">List</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">RouteDefinitionLocator</span><span style="color:#c0c5ce;">&gt; routeDefinitionLocators) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return new </span><span style="color:#ebcb8b;">CompositeRouteDefinitionLocator</span><span style="color:#c0c5ce;">(
</span><span style="color:#c0c5ce;">            </span><span style="color:#ebcb8b;">Flux</span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">fromIterable</span><span style="color:#c0c5ce;">(routeDefinitionLocators));
</span><span style="color:#c0c5ce;">}
</span></pre>
<p><strong>所有</strong> 能被 Spring 感知到的 <code>org.springframework.cloud.gateway.route.RouteDefinitionLocator</code> bean 实例都会被默认收集被 <code>CompositeRouteDefinitionLocator</code> 管理。</p>
<h2 id="routedefinition"><a class="zola-anchor" href="#routedefinition" aria-label="Anchor link for: routedefinition">🔗</a>
RouteDefinition</h2>
<p><code>RouteDefinition</code> 是 <code>Route</code> 路由对象的序列化对象；一个合法的 <code>RouteDefinition</code> 对象可以被构造为一个
路由对象。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">RouteDefinition </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">NotEmpty
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">id </span><span style="color:#c0c5ce;">= </span><span style="color:#ebcb8b;">UUID</span><span style="color:#eff1f5;">.</span><span style="color:#bf616a;">randomUUID</span><span style="color:#eff1f5;">().</span><span style="color:#bf616a;">toString</span><span style="color:#eff1f5;">();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">NotEmpty
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Valid
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">PredicateDefinition</span><span style="color:#eff1f5;">&gt; predicates </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ArrayList</span><span style="color:#eff1f5;">&lt;&gt;();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">Valid
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">FilterDefinition</span><span style="color:#eff1f5;">&gt; filters </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">ArrayList</span><span style="color:#eff1f5;">&lt;&gt;();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">NotNull
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">URI </span><span style="color:#eff1f5;">uri;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private int </span><span style="color:#eff1f5;">order </span><span style="color:#c0c5ce;">= </span><span style="color:#d08770;">0</span><span style="color:#eff1f5;">;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">}
</span></pre>
<p>与 <code>Route</code> 类似，<code>RouteDefinition</code> 的主要成员是多个请求的判定器定义对象 <code>predicates</code>、多个处理器定义对象 <code>filters</code>、一个后端访问地址 <code>uri</code>，以及一个唯一标识和序号。</p>
<h2 id="route-construction"><a class="zola-anchor" href="#route-construction" aria-label="Anchor link for: route-construction">🔗</a>
Route Construction</h2>
<p>所以，<a href="https://spring.io/projects/spring-cloud-gateway" title="Spring Cloud Gateway">Spring Gateway</a> 官方提供了两种方式生成一个路由对象。</p>
<h3 id="via-routelocatorbuilder-in-java"><a class="zola-anchor" href="#via-routelocatorbuilder-in-java" aria-label="Anchor link for: via-routelocatorbuilder-in-java">🔗</a>
Via RouteLocatorBuilder in Java</h3>
<p><code>RouteLocatorBuilder</code> 可以很容易地被用来构建路由对象。</p>
<pre style="background-color:#2b303b;">
<span style="color:#c0c5ce;">@</span><span style="color:#bf616a;">Bean
</span><span style="color:#ebcb8b;">RouteLocator </span><span style="color:#bf616a;">constantRouteLocator</span><span style="color:#c0c5ce;">(final </span><span style="color:#ebcb8b;">RouteLocatorBuilder</span><span style="color:#c0c5ce;"> builder) {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">return</span><span style="color:#c0c5ce;"> builder.</span><span style="color:#bf616a;">routes</span><span style="color:#c0c5ce;">()
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">route</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">demo_lb</span><span style="color:#c0c5ce;">&quot;, </span><span style="color:#bf616a;">r </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> r.</span><span style="color:#bf616a;">header</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">XHOST</span><span style="color:#c0c5ce;">&quot;)
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">filters</span><span style="color:#c0c5ce;">(</span><span style="color:#bf616a;">f </span><span style="color:#b48ead;">-&gt;</span><span style="color:#c0c5ce;"> f.</span><span style="color:#bf616a;">prefixPath</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">/search</span><span style="color:#c0c5ce;">&quot;))
</span><span style="color:#c0c5ce;">            </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">uri</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">lb://httpbin.org</span><span style="color:#c0c5ce;">&quot;))
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">.</span><span style="color:#bf616a;">build</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">}
</span></pre><h3 id="via-routedefinition-in-yaml-properties"><a class="zola-anchor" href="#via-routedefinition-in-yaml-properties" aria-label="Anchor link for: via-routedefinition-in-yaml-properties">🔗</a>
Via RouteDefinition in YAML/Properties</h3>
<p><code>RouteDefinition</code> 可以很容易地被用来从外部配置文件 (YAML/Properties) 构建路由对象。</p>
<pre style="background-color:#2b303b;">
<span style="color:#bf616a;">spring</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">    </span><span style="color:#bf616a;">cloud</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">        </span><span style="color:#bf616a;">gateway</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">            </span><span style="color:#bf616a;">routes</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                </span><span style="color:#c0c5ce;">- </span><span style="color:#bf616a;">id</span><span style="color:#c0c5ce;">: </span><span style="color:#a3be8c;">r1
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">order</span><span style="color:#c0c5ce;">: </span><span style="color:#d08770;">2
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">uri</span><span style="color:#c0c5ce;">: &quot;</span><span style="color:#a3be8c;">https://a.com</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">predicates</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                      </span><span style="color:#c0c5ce;">- </span><span style="color:#a3be8c;">host=a.org
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">filters</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                      </span><span style="color:#c0c5ce;">- </span><span style="color:#a3be8c;">AddRequestHeader=XHOST,my.a.org
</span><span style="color:#c0c5ce;">                </span><span style="color:#c0c5ce;">- </span><span style="color:#bf616a;">id</span><span style="color:#c0c5ce;">: </span><span style="color:#a3be8c;">r2
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">order</span><span style="color:#c0c5ce;">: </span><span style="color:#d08770;">1
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">uri</span><span style="color:#c0c5ce;">: &quot;</span><span style="color:#a3be8c;">https://b.com</span><span style="color:#c0c5ce;">&quot;
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">predicates</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                      </span><span style="color:#c0c5ce;">- </span><span style="color:#a3be8c;">Host=b.org
</span><span style="color:#c0c5ce;">                  </span><span style="color:#bf616a;">filters</span><span style="color:#c0c5ce;">:
</span><span style="color:#c0c5ce;">                      </span><span style="color:#c0c5ce;">- </span><span style="color:#a3be8c;">AddRequestHeader=XHOST,my.b.org
</span></pre><h1 id="predicate"><a class="zola-anchor" href="#predicate" aria-label="Anchor link for: predicate">🔗</a>
Predicate</h1>
<p>谓词对象即路由对象里面的判定条件。</p>
<h2 id="asyncpredicate"><a class="zola-anchor" href="#asyncpredicate" aria-label="Anchor link for: asyncpredicate">🔗</a>
AsyncPredicate</h2>
<p><code>Route</code> 类里面的谓词对象的类型是 <code>AsyncPredicate</code>。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">Route </span><span style="color:#b48ead;">implements </span><span style="color:#a3be8c;">Ordered </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">id;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">URI </span><span style="color:#eff1f5;">uri;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final int </span><span style="color:#eff1f5;">order;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">AsyncPredicate</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#eff1f5;">&gt; predicate; </span><span style="color:#65737e;">// HERE
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private final </span><span style="color:#ebcb8b;">List</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">GatewayFilter</span><span style="color:#eff1f5;">&gt; gatewayFilters;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">}
</span></pre><h2 id="predicatedefinition"><a class="zola-anchor" href="#predicatedefinition" aria-label="Anchor link for: predicatedefinition">🔗</a>
PredicateDefinition</h2>
<p>相比 <code>AsyncPredicate</code> 类，我们更关心其对应的定义类 <code>PredicateDefinition</code>。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">PredicateDefinition </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">NotNull
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">name;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">Map</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; args </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">LinkedHashMap</span><span style="color:#eff1f5;">&lt;&gt;();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">}
</span></pre>
<p>为了保持代码简单，其定义被设计为一个类型标识名和一个 K-V 的映射表。</p>
<h2 id="predicatedefinition-to-asyncpredicate"><a class="zola-anchor" href="#predicatedefinition-to-asyncpredicate" aria-label="Anchor link for: predicatedefinition-to-asyncpredicate">🔗</a>
PredicateDefinition to AsyncPredicate</h2>
<p><code>PredicateDefinition</code> 到 <code>AsyncPredicate</code> 的转换逻辑在 <code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator</code> 类的 <code>lookUp</code> 方法里面，大量使用了反射的技巧。</p>
<p>其中，使用了 <code>org.springframework.cloud.gateway.handler.predicate.RoutePredicateFactory</code> 类作为二者
转换的桥。</p>
<h2 id="routepredicatefactory"><a class="zola-anchor" href="#routepredicatefactory" aria-label="Anchor link for: routepredicatefactory">🔗</a>
RoutePredicateFactory</h2>
<p>该类全称 <code>org.springframework.cloud.gateway.handler.predicate.RoutePredicateFactory&lt;C&gt;</code>，提供了一个
统一的基于 Spring 通用反射模式的谓词构造工厂类。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public interface </span><span style="color:#ebcb8b;">RoutePredicateFactory</span><span style="color:#eff1f5;">&lt;</span><span style="color:#bf616a;">C</span><span style="color:#eff1f5;">&gt; </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">ShortcutConfigurable</span><span style="color:#c0c5ce;">, </span><span style="color:#ebcb8b;">Configurable</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">C</span><span style="color:#c0c5ce;">&gt; {
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">AsyncPredicate</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">ServerWebExchange</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">applyAsync</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Consumer</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">C</span><span style="color:#c0c5ce;">&gt; consumer);
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#ebcb8b;">Class</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">C</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">getConfigClass</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">}
</span></pre><h2 id="builtin-predicate-factories"><a class="zola-anchor" href="#builtin-predicate-factories" aria-label="Anchor link for: builtin-predicate-factories">🔗</a>
Builtin Predicate Factories</h2>
<p>官方默认提供了以下谓词构造工厂的实现类，可以实现多种不同的请求匹配能力。</p>
<ul>
<li><code>org.springframework.cloud.gateway.handler.predicate.AfterRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.BeforeRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.BetweenRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.CookieRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.HeaderRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.HostRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.MethodRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.PathRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.QueryRoutePredicateFactory</code></li>
<li><code>org.springframework.cloud.gateway.handler.predicate.RemoteAddrRoutePredicateFactory</code></li>
</ul>
<h1 id="filter"><a class="zola-anchor" href="#filter" aria-label="Anchor link for: filter">🔗</a>
Filter</h1>
<p>过滤器对象即路由对象中匹配后处理逻辑的封装。</p>
<h2 id="gatewayfilter"><a class="zola-anchor" href="#gatewayfilter" aria-label="Anchor link for: gatewayfilter">🔗</a>
GatewayFilter</h2>
<p><code>Route</code> 类里面的过滤器对象的类型是 <code>GatewayFilter</code>。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public interface </span><span style="color:#ebcb8b;">GatewayFilter </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">ShortcutConfigurable </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#ebcb8b;">Mono</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">Void</span><span style="color:#eff1f5;">&gt; </span><span style="color:#8fa1b3;">filter</span><span style="color:#eff1f5;">(</span><span style="color:#ebcb8b;">ServerWebExchange </span><span style="color:#bf616a;">exchange</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">GatewayFilterChain </span><span style="color:#bf616a;">chain</span><span style="color:#eff1f5;">);
</span><span style="color:#eff1f5;">}
</span></pre>
<p>该类与之前的 <code>DefaultGatewayFilterChain</code> 类结合起来，组成了一个链式的请求处理流程。</p>
<h2 id="filterdefinition"><a class="zola-anchor" href="#filterdefinition" aria-label="Anchor link for: filterdefinition">🔗</a>
FilterDefinition</h2>
<p>相比 <code>FilterDefinition</code> 类，我们更关心其对应的定义类 <code>FilterDefinition</code>。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public class </span><span style="color:#ebcb8b;">FilterDefinition </span><span style="color:#eff1f5;">{
</span><span style="color:#eff1f5;">    </span><span style="color:#eff1f5;">@</span><span style="color:#bf616a;">NotNull
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">String </span><span style="color:#eff1f5;">name;
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#b48ead;">private </span><span style="color:#ebcb8b;">Map</span><span style="color:#eff1f5;">&lt;</span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">, </span><span style="color:#ebcb8b;">String</span><span style="color:#eff1f5;">&gt; args </span><span style="color:#c0c5ce;">= </span><span style="color:#b48ead;">new </span><span style="color:#ebcb8b;">LinkedHashMap</span><span style="color:#eff1f5;">&lt;&gt;();
</span><span style="color:#eff1f5;">
</span><span style="color:#eff1f5;">    </span><span style="color:#65737e;">// ...
</span><span style="color:#eff1f5;">}
</span></pre>
<p>为了保持代码简单，其定义被设计为一个类型标识名和一个 K-V 的映射表。</p>
<h2 id="filterdefinition-to-gatewayfilter"><a class="zola-anchor" href="#filterdefinition-to-gatewayfilter" aria-label="Anchor link for: filterdefinition-to-gatewayfilter">🔗</a>
FilterDefinition to GatewayFilter</h2>
<p>从定义生成过滤器对象的逻辑在 <code>org.springframework.cloud.gateway.route.RouteDefinitionRouteLocator</code> 的 <code>loadGatewayFilters</code> 方法中。其中，同样使用了 <code>org.springframework.cloud.gateway.handler.predicate.GatewayFilterFactory</code> 类作为二者转换的桥。</p>
<h2 id="gatewayfilterfactory"><a class="zola-anchor" href="#gatewayfilterfactory" aria-label="Anchor link for: gatewayfilterfactory">🔗</a>
GatewayFilterFactory</h2>
<p><code>org.springframework.cloud.gateway.filter.factory.GatewayFilterFactory&lt;T&gt;</code> 的设计模式和使用方式同
<code>RoutePredicateFactory</code> 。</p>
<pre style="background-color:#2b303b;">
<span style="color:#b48ead;">public interface </span><span style="color:#ebcb8b;">GatewayFilterFactory</span><span style="color:#eff1f5;">&lt;</span><span style="color:#bf616a;">C</span><span style="color:#eff1f5;">&gt; </span><span style="color:#b48ead;">extends </span><span style="color:#a3be8c;">ShortcutConfigurable</span><span style="color:#c0c5ce;">, </span><span style="color:#ebcb8b;">Configurable</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">C</span><span style="color:#c0c5ce;">&gt; {
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">default </span><span style="color:#ebcb8b;">GatewayFilter </span><span style="color:#bf616a;">apply</span><span style="color:#c0c5ce;">(</span><span style="color:#ebcb8b;">Consumer</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">C</span><span style="color:#c0c5ce;">&gt; consumer) {
</span><span style="color:#c0c5ce;">        </span><span style="color:#ebcb8b;">C</span><span style="color:#c0c5ce;"> config = </span><span style="color:#bf616a;">newConfig</span><span style="color:#c0c5ce;">();
</span><span style="color:#c0c5ce;">        </span><span style="color:#c0c5ce;">consumer.</span><span style="color:#bf616a;">accept</span><span style="color:#c0c5ce;">(config);
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">return </span><span style="color:#bf616a;">apply</span><span style="color:#c0c5ce;">(config);
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">
</span><span style="color:#c0c5ce;">    </span><span style="color:#b48ead;">default </span><span style="color:#ebcb8b;">Class</span><span style="color:#c0c5ce;">&lt;</span><span style="color:#ebcb8b;">C</span><span style="color:#c0c5ce;">&gt; </span><span style="color:#bf616a;">getConfigClass</span><span style="color:#c0c5ce;">() {
</span><span style="color:#c0c5ce;">        </span><span style="color:#b48ead;">throw new </span><span style="color:#ebcb8b;">UnsupportedOperationException</span><span style="color:#c0c5ce;">(&quot;</span><span style="color:#a3be8c;">getConfigClass() not implemented</span><span style="color:#c0c5ce;">&quot;);
</span><span style="color:#c0c5ce;">    </span><span style="color:#c0c5ce;">}
</span><span style="color:#c0c5ce;">}
</span></pre><h2 id="builtin-filter-factories"><a class="zola-anchor" href="#builtin-filter-factories" aria-label="Anchor link for: builtin-filter-factories">🔗</a>
Builtin Filter Factories</h2>
<p>官方默认提供了以下过滤器构造工厂的实现类，可以实现多种不同的请求处理能力。</p>
<ul>
<li>AddRequestHeader GatewayFilter Factory</li>
<li>AddRequestParameter GatewayFilter Factory</li>
<li>AddResponseHeader GatewayFilter Factory</li>
<li>Hystrix GatewayFilter Factory</li>
<li>FallbackHeaders GatewayFilter Factory</li>
<li>PrefixPath GatewayFilter Factory</li>
<li>PreserveHostHeader GatewayFilter Factory</li>
<li>RequestRateLimiter GatewayFilter Factory</li>
<li>RedirectTo GatewayFilter Factory</li>
<li>RemoveNonProxyHeaders GatewayFilter Factory</li>
<li>RemoveRequestHeader GatewayFilter Factory</li>
<li>RemoveResponseHeader GatewayFilter Factory</li>
<li>RewritePath GatewayFilter Factory</li>
<li>RewriteResponseHeader GatewayFilter Factory</li>
<li>SaveSession GatewayFilter Factory</li>
<li>SecureHeaders GatewayFilter Factory</li>
<li>SetPath GatewayFilter Factory</li>
<li>SetResponseHeader GatewayFilter Factory</li>
<li>SetStatus GatewayFilter Factory</li>
<li>StripPrefix GatewayFilter Factory</li>
<li>Retry GatewayFilter Factory</li>
<li>RequestSize GatewayFilter Factory</li>
<li>Modify Request Body GatewayFilter Factory</li>
<li>Modify Response Body GatewayFilter Factory</li>
</ul>
<h1 id="global-filter"><a class="zola-anchor" href="#global-filter" aria-label="Anchor link for: global-filter">🔗</a>
Global Filter</h1>
<p>全局过滤器对象是对路由反向代理到后端能力的封装，其主要通过 URI 的 scheme 来决定应用的逻辑；一般来说
，不同的 scheme 会有不同的全局过滤器对象来处理。</p>
<p>当前官方默认能支持的 scheme 有：</p>
<ul>
<li>http</li>
<li>https</li>
<li>lb</li>
<li>forward</li>
</ul>
<p>全局过滤器的接口同普通过滤器，但没有提供从定义反序列化生成的能力。</p>

    </div>

    
    

    <div class="post-footer">
        
            
                <div class="post-tags">
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;gateway&#x2F;">#gateway</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;spring-cloud&#x2F;">#spring cloud</a>
                    
                        <a href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;tags&#x2F;route&#x2F;">#route</a>
                    
                </div>
            
            
                <div class="post-nav">
                    
                        <a class="previous" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-07-21-ffmpeg-vsync-explained&#x2F;">‹ Ffmpeg -vsync 使用场景辨析</a>
                    
                    
                        <a class="next" href="https:&#x2F;&#x2F;www.wangbo.im&#x2F;posts&#x2F;2019-08-31-slow-mysql-query-on-too-many-cas-updating-failure&#x2F;">一次由于线上 MySQL 并发抢占更新冲突引发的 BUG ›</a>
                    
                    
                    
                </div>
            

        

    </div>

    
    
</article>


                </div>
            </main>

            
            
        </div>

      
          <script type="text/javascript" src="https:&#x2F;&#x2F;www.wangbo.im&#x2F;even.js" ></script>
      
    </body>

</html>
