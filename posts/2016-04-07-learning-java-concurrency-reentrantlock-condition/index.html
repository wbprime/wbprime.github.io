<!DOCTYPE html>
<html lang="zh">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>Learning Java Concurrency - ReentrantLock &amp; Condition</title>
        <style>

    html body {
        font-family: Raleway, sans-serif;
        background-color: white;
    }

    :root {
        --accent: lightseagreen;
        --border-width:  0 ;
    }

</style>


<link rel="stylesheet" href="/css/main.css">





<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Raleway">


 <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/solarized-dark.min.css"> 


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">


<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
 


    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

     <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/java.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/c&#43;&#43;.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/go.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/haskell.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/kotlin.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/scala.min.js"></script>  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/languages/swift.min.js"></script> 

    <script>hljs.initHighlightingOnLoad();</script>







<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>


<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>


<script>$(document).on('click', function() { $('.collapse').collapse('hide'); })</script>
 <meta name="generator" content="Hugo 0.32-DEV" />
        
    </head>

    <body>

        <nav class="navbar navbar-default navbar-fixed-top">

            <div class="container">

                <div class="navbar-header">

                    <a class="navbar-brand visible-xs" href="#">Learning Java Concurrency - ReentrantLock &amp; Condition</a>

                    <button class="navbar-toggle" data-target=".navbar-collapse" data-toggle="collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>

                </div>

                <div class="collapse navbar-collapse">

                    
                        <ul class="nav navbar-nav">
                            
                                <li><a href="/">Home</a></li>
                            
                                <li><a href="/posts/">Posts</a></li>
                            
                                <li><a href="/categories/">Categories</a></li>
                            
                                <li><a href="/tags/">Tags</a></li>
                            
                        </ul>
                    

                    
                        <ul class="nav navbar-nav navbar-right">
                            
                                <li class="navbar-icon"><a href="https://github.com/wbprime/"><i class="fa fa-github"></i></a></li>
                            
                        </ul>
                    

                </div>

            </div>

        </nav>


<main>

    <div class="item">

    
    
    

    
    

    <h4><a href="/posts/2016-04-07-learning-java-concurrency-reentrantlock-condition/">Learning Java Concurrency - ReentrantLock &amp; Condition</a></h4>
    <h5>April 7, 2016</h5>
     <kbd class="item-tag">java</kbd>  <kbd class="item-tag">concurrency</kbd> 

</div>


    <br> <div class="text-justify">

<p><code>ReentrantLock</code>是<code>synchronized</code>的高阶版本，用来控制多线程同步。<code>ReentrantLock</code>是一种独占锁，同一时间只能有一个线程使用一把锁，其他请求加锁的线程都会被阻塞。除了控制多线程同步之外，<code>ReentrantLock</code>还提供了<code>Condition</code>用来进行多线程通讯。<code>Condition</code>是<code>Object</code>类的方法<code>wait &amp; notify</code>的替代版本，可以用等待/通知模式来有效控制多线程对共享资源的访问。</p>

<p>仿<a href="/2016/04/01/java-concurrency-synchronized/"><code>synchronized</code></a>，用<code>ReentrantLock</code>实现单例模式的代码如下：</p>

<pre><code class="language-java">private static class Singleton {
    private static volatile Singleton INSTANCE;
    private static ReentrantLock lock = new ReentrantLock();

    private Singleton() {}

    public static Singleton instance() {
        Singleton var = INSTANCE;
        if (null == var) {
            lock.lock();
            try {
                var = INSTANCE;
                if (null == var) {
                    INSTANCE = var = new Singleton();
                }
            } finally {
                lock.unlock();
            }
        }

        return var;
    }
}
</code></pre>

<p>仿<a href="/2016/04/06/learning-java-concurrency-wait-notify/"><code>wait &amp; notify</code></a>，用<code>Condition</code>来实现父子通知汇款的代码如下：</p>

<pre><code class="language-java">private static class DepositAccount {
    private int money;

    private final ReentrantLock lock = new ReentrantLock();
    private final Condition cond = lock.newCondition();

    public DepositAccount() {
        this.money = 0;
    }

    public void withdraw(final int val) {
        lock.lock();
        try {
            while (money &lt; val) {
                try {
                    cond.await(); // 钱不够，等一会儿
                } catch (InterruptedException e) {
                    // do nothing here
                }
            }

            money -= val;
        } finally {
            lock.unlock();
        }
    }

    public void deposite(final int val) {
        lock.lock();
        try {
            money += val;

            cond.signalAll(); // 存完钱周知一下
        } finally {
            lock.unlock();
        }
    }
}
</code></pre>

<!-- More -->

<h1 id="reentrantlock-s-api">ReentrantLock&rsquo;s API</h1>

<ol>
<li>ReentrantLock() &amp; ReentrantLock(boolean fair)</li>
<li>void lock()</li>
<li>void lockInterruptibly() throws InterruptedException</li>
<li>boolean tryLock()</li>
<li>boolean tryLock(long timeout, TimeUnit unit)</li>
<li>void unlock()</li>
<li>boolean isHelpByCurrentThread()</li>
<li>boolean isLocked()</li>
<li>boolean isFair()</li>
<li>Condition newCondition()</li>
<li>boolean hasWaiters(Condition cond)</li>
</ol>

<p><code>ReentrantLock</code>的实现是委托给内部静态类<code>FairSync</code>和<code>NonfairSync</code>，这两个类又继承自<code>AbstractQueuedSynchronizer</code>。</p>

<pre><code class="language-java">abstract static class Sync extends AbstractQueuedSynchronizer {
    ...
}

static final class NonfairSync extends Sync {
    ...
}

static final class FairSync extends Sync {
    ...
}
</code></pre>

<h2 id="公平锁与非公平锁">公平锁与非公平锁</h2>

<p><code>FairSync</code>和<code>NonfairSync</code>即所谓的公平锁和非公平锁。对比一下两个锁版本对于<code>lock</code>方法的实现，就能明白公平和非公平的区别在哪里了。</p>

<pre><code class="language-java">final void lock() { // NonfairSync
    if (compareAndSetState(0, 1))
        setExclusiveOwnerThread(Thread.currentThread());
    else
        acquire(1);
}

final void lock() { // FairSync
    acquire(1);
}
</code></pre>

<p>可以看到，公平锁直接让当前线程加入等待队列；而非公平锁首先试图去获取锁，如果当前有线程恰好释放了锁，就可以插队获取到锁，如果获取失败，还是会加入等待队列。也就是说，非公平锁会在调用lock的时候去尝试获取锁。如果这时候能够获取锁，就直接获取到锁，这样可以减少线程挂起和恢复的性能开销；缺点就是有可能在等待队列中的线程有可能永远拿不到锁。</p>

<p><code>ReentrantLock</code>在构造器中可以指定使用公平锁还是非公平锁策略，默认是非公平锁。</p>

<h2 id="lock"><code>lock</code></h2>

<p><code>lock()</code>和<code>lockInterruptibly()</code>用于获取锁。调用线程试图去获取一个锁，如果锁已经被当前线程占用，则锁的计数器加1；如果锁被其他线程占用，则当前线程被阻塞，进入等待队列等待锁被释放。</p>

<p>两者的区别在于等待线程在等待的过程中是否可以被中断。</p>

<h2 id="trylock"><code>tryLock</code></h2>

<p>如果调用线程不想被阻塞，可以使用<code>lock</code>的异步版本<code>tryLock</code>。<code>tryLock</code>会试图去获取锁，如果获取成功了，就返回成功；如果失败了，就会返回失败。获取失败，可以设定一个等待时间，自旋等待。</p>

<h2 id="unlock"><code>unlock</code></h2>

<p>如果调用线程持有了目标锁，当前线程调用<code>unlock</code>会试图释放锁定。准确的说是让目标锁的计数器减1,如果目标锁的计数器为0,则锁被释放。</p>

<p>如果调用线程没有持有目标锁，会导致<code>IllegalMonitorStateException</code>异常。</p>

<h2 id="newcondition"><code>newCondition</code></h2>

<p>创建一个与目标锁相关联的<code>Condition</code>对象。</p>

<h1 id="condition-s-api">Condition&rsquo;s API</h1>

<ol>
<li>void await() throws InterruptedException</li>
<li>void awaitUninterruptibly()</li>
<li>long awaitNanos(long nanos) throws InterruptedException</li>
<li>boolean await(long timeout, TimeUnit unit) throws InterruptedException</li>
<li>boolean awaitUnit(Date dt) throws InterruptedException</li>
<li>void signal()</li>
<li>void signalAll()</li>
</ol>

<p><code>Condition</code>的作用和用法可以参考<code>Object</code>类的<code>wait &amp; notify</code>族。</p>

<p><code>ReentrantLock</code>返回的<code>Condition</code>对象与一个互斥锁相关联。<code>Condition</code>对象本身维护一个线程的等待队列，<code>await</code>会将调用线程放到等待队列中；<code>signal</code>会将等待线程中的所有线程放到关联的<code>ReentrantLock</code>对象的等待队列中。这样线程的挂起和唤醒工作就由<code>ReentrantLock</code>对象完成。</p>

<h2 id="await"><code>await</code></h2>

<p>同<code>Object</code>的<code>wait</code>族，估计就是因为已经有了<code>wait</code>，所以新的API才被命名为<code>await</code>。</p>

<p>调用线程会被挂起，一直等到条件满足被其他线程用<code>signal</code>来唤醒。</p>

<p>等待可以设置允不允许中断，也可以设置等待时间间隔。</p>

<p>调用线程被挂起之后会释放持有的锁，加入到<code>Condition</code>对象的等待队列中去。</p>

<h2 id="signal"><code>signal</code></h2>

<p>同<code>Object</code>的<code>notify</code>族。</p>

<p><code>signal</code>唤醒线程的顺序是未定义的，不同的JVM实现会有不同的策略，可以是等待时间最长的最先被唤醒。</p>

<p><code>signal</code>会将需要唤醒的线程从<code>Condition</code>自己的等待队列移动到绑定的<code>ReentrantLock</code>对象的等待序列，按照<code>ReentrantLock</code>的规则去获取锁。</p>

<h1 id="代码下载">代码下载</h1>

<p><a href="ConditionCase.java">ConditionCase.java</a>
<a href="ReentrantLockCase.java">ReentrantLockCase.java</a></p>
</div>

    
    

    

    

</main>

        <footer>

            <p class="copyright text-muted">&copy; All rights reserved. Powered by <a href="https://gohugo.io">Hugo</a> and <a href="https://github.com/calintat/minimal">Minimal</a></p>

        </footer>

    </body>

</html>

